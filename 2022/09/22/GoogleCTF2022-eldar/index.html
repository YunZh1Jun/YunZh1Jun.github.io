<!DOCTYPE html>
<html lang="zh-cn">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>GoogleCTF2022 eldar - äº‘ä¹‹å›&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/img/fav/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

  
<meta name="generator" content="Hexo 5.4.2"></head>
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">äº‘ä¹‹å›&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">ä¸»é¡µ</a>
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Learn">Learn</a>
            
            
            
            <a class="nav-item" href="/Diary">Diary</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/YunZh1Jun" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            
            <span>September</span>
            
            
            
            
            <span>22,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">GoogleCTF2022 eldar</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>ç¿»è¯‘äº†å›½å¤–ä¸€ä¸ªå¤§ç¥çš„WPï¼Œæˆ‘ä»€ä¹ˆæ—¶å€™èƒ½æœ‰è¿™ä¹ˆå¼ºğŸ˜­</p>
<p>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://ctf.harrisongreen.me/2022/googlectf/eldar/">GoogleCTF2022 - eldar</a><br>å¤ç°å¼ºç½‘æ¯çš„deeprevçš„æ—¶å€™çŸ¥é“çš„è¿™é¢˜ï¼Œæœ¬æ–‡æ˜¯ç…§ç€å¤ç°ï¼Œç¿»è¯‘äº†ä¸€éƒ¨åˆ†ï¼Œéƒ¨åˆ†åè¯æˆ‘ä¼šæ ‡æ³¨è‹±æ–‡åŸæ–‡ã€‚å¾ˆå¤šåœ°æ–¹ç¿»çš„å¾ˆåˆ«æ‰­ï¼Œå› ä¸ºæœ¬äººçš„è‹±è¯­æ°´å¹³å®åœ¨æ˜¯å¤ªğŸŒ¶ï¸ğŸ”äº†â€¦â€¦<br>å¢™è£‚å»ºè®®é˜…è¯»åŸæ–‡ <del>ä¸ç„¶çœ‹æˆ‘å†™çš„å¯èƒ½åªä¼šæ”¶è·ä¸€å¤´é›¾æ°´ã€‚</del><br>å…¶å®æ„Ÿè§‰è¿˜æ˜¯æå¾—ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œä»¥åå¦‚æœé¡¿æ‚Ÿäº†å†è¿‡æ¥è¡¥å……(x</p>
<p>æ¶‰åŠåˆ°çš„æŠ€æœ¯ï¼š<br><a target="_blank" rel="noopener" href="https://www.cs.dartmouth.edu/~sergey/wm/woot13-shapiro.pdf">â€œWeird Machinesâ€ in ELF: A Spotlight on the Underappreciated Metadata</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YgtxxLCVD-o">Programming Weird Machines with ELF Metadata</a></p>
<h2 id="ELFé‡å®šä½"><a href="#ELFé‡å®šä½" class="headerlink" title="ELFé‡å®šä½"></a>ELFé‡å®šä½</h2><p>ELFåŠ¨æ€é‡å®šä½çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr      r_offset;</span><br><span class="line">    Elf64_Xword     r_info;</span><br><span class="line">    Elf64_Sxword    r_addend;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p>infoåŒ…æ‹¬ä¸€ä¸ªtypeå’Œsymble(å¯é€‰)ç´¢å¼•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM(info)             ((info)&gt;&gt;32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE(info)            ((Elf64_Word)(info))</span></span><br></pre></td></tr></table></figure>

<p>åŠ¨æ€ç¬¦å·è¡¨ä¹Ÿæ˜¯ç›¸å…³çš„ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Word      st_name;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_info;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_other;</span><br><span class="line">    Elf64_Half      st_shndx;</span><br><span class="line">    Elf64_Addr      st_value;</span><br><span class="line">    Elf64_Xword     st_size;</span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰é‡å®šä½ä¿¡æ¯éƒ½å†™å…¥<code>r_offset</code>æŒ‡å‘çš„åœ°å€ã€‚å†™å…¥çš„å€¼å–å†³äºé‡å®šä½ç±»å‹ã€‚</p>
<p>eldarä½¿ç”¨äº†ä»¥ä¸‹4ç§é‡å®šä½ä¿¡æ¯ï¼š</p>
<h3 id="REL-type-8"><a href="#REL-type-8" class="headerlink" title="REL (type 8)"></a>REL (type 8)</h3><p>å°†é‡å®šä½ä¿¡æ¯è®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹åŸºå€çš„å€¼ï¼ˆä½†æ˜¯åŸºå€å§‹ç»ˆä¸º0ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="R64-type-1"><a href="#R64-type-1" class="headerlink" title="R64(type 1)"></a>R64(type 1)</h3><p>å°†é‡å®šä½ä¿¡æ¯è®¾ç½®ä¸º ç¬¦å·å€¼+å¸¸æ•° <em>ï¼ˆåŸæ–‡ä¸­æ˜¯addendï¼‰</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = symbols[ELF64_R_SYM(r.r_info)] + r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="R32-type-10"><a href="#R32-type-10" class="headerlink" title="R32 (type 10)"></a>R32 (type 10)</h3><p>å’ŒR64ä¸€æ ·ï¼Œåªä¸è¿‡è¢«æˆªæ–­ä¸º32ä½ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint32_t</span> *)r.r_offset = symbols[ELF64_R_SYM(r.r_info)].st_value + r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="CPY-type-5"><a href="#CPY-type-5" class="headerlink" title="CPY(type 5)"></a>CPY(type 5)</h3><p>ä»ç¬¦å·åœ°å€å¤åˆ¶nå­—èŠ‚åˆ°é‡å®šä½åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Elf64_Sym sym = symbols[ELF64_R_SYM(r.r_info)];</span><br><span class="line"><span class="built_in">memcpy</span>(r.r_offset, sym.st_value, sym.st_size);</span><br></pre></td></tr></table></figure>

<h2 id="Part1-è§£æ"><a href="#Part1-è§£æ" class="headerlink" title="Part1 è§£æ"></a>Part1 è§£æ</h2><p>æˆ‘å‘ç°liefè§£æé‡å®šä½æ•°æ®å’Œç¬¦å·ä¿¡æ¯éå¸¸æ–¹ä¾¿</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">b = lief.ELF.parse(<span class="string">&#x27;./eldar&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_sym</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(name) == <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ord</span>(name[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">Rel = namedtuple(<span class="string">&#x27;REL&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;val&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">Copy = namedtuple(<span class="string">&#x27;CPY&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;symbol&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">R64 = namedtuple(<span class="string">&#x27;R64&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;symbol&#x27;</span>,<span class="string">&#x27;addend&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">R32 = namedtuple(<span class="string">&#x27;R32&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;symbol&#x27;</span>,<span class="string">&#x27;addend&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">b</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Loading relocations...&#x27;</span>)</span><br><span class="line">    relocs = <span class="built_in">list</span>(b.relocations)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Parsing...&#x27;</span>)</span><br><span class="line">    instructions = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="built_in">len</span>(relocs)):</span><br><span class="line">        r = relocs[i]</span><br><span class="line">        <span class="keyword">match</span> r.<span class="built_in">type</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: <span class="comment"># R64</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    R64(r.address, to_sym(r.symbol.name), r.addend, i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: <span class="comment"># CPY</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    Copy(r.address, to_sym(r.symbol.name), i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="comment"># REL</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    Rel(r.address, r.addend, i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>: <span class="comment"># R32</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    R32(r.address, to_sym(r.symbol.name), r.addend, i))</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="keyword">for</span> op <span class="keyword">in</span> instructions:</span><br><span class="line">        <span class="keyword">match</span> op:</span><br><span class="line">            <span class="keyword">case</span> Rel(dst, val, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: rel <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;val&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Copy(dst, symbol, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: copy <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> R64(dst, symbol, addend, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: r64 <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span> + <span class="subst">&#123;addend&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> R32(dst, symbol, addend, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: r64 <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span> + <span class="subst">&#123;addend&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">instructions = parse(b)</span><br><span class="line">dump(instructions)</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[0354] :: copy 8405268, 2</span><br><span class="line">[0355] :: rel 8405148, 8405268</span><br><span class="line">[0356] :: rel 8405156, 8</span><br><span class="line">[0357] :: copy 8414226, 2</span><br><span class="line">[0358] :: r64 8405196, 4 + 0</span><br><span class="line">[0359] :: rel 8414226, 0</span><br><span class="line">[0360] :: r64 8405197, 1 + 0</span><br><span class="line">[0361] :: rel 8405148, 8405690</span><br><span class="line">[0362] :: copy 8405244, 2</span><br><span class="line">[0363] :: rel 8405148, 8405196</span><br><span class="line">[0364] :: copy 8414394, 2</span><br><span class="line">[0365] :: r64 8405220, 4 + 0</span><br><span class="line">[0366] :: rel 8414394, 0</span><br><span class="line">[0367] :: rel 8405148, 8405220</span><br><span class="line">[0368] :: copy 8414490, 2</span><br><span class="line">[0369] :: r64 8405220, 5 + 0</span><br><span class="line">[0370] :: rel 8414490, 0</span><br><span class="line">[0371] :: copy 8414562, 2</span><br><span class="line">[0372] :: r64 8405220, 5 + 0</span><br><span class="line">[0373] :: rel 8414562, 0</span><br><span class="line">[0374] :: r64 8405220, 5 + 8405690</span><br><span class="line">[0375] :: copy 8405690, 5</span><br><span class="line">[0376] :: copy 8414666, 2</span><br><span class="line">[0377] :: r64 0, 6 + 0</span><br><span class="line">[0378] :: rel 8405148, 8405698</span><br><span class="line">...</span><br><span class="line">[101463] :: copy 10840770, 2</span><br><span class="line">[101464] :: r64 8405244, 6 + 0</span><br><span class="line">[101465] :: rel 10840770, 0</span><br><span class="line">[101466] :: rel 8405148, 8405244</span><br><span class="line">[101467] :: copy 10840866, 2</span><br><span class="line">[101468] :: r64 8405244, 6 + 0</span><br><span class="line">[101469] :: rel 10840866, 0</span><br><span class="line">[101470] :: rel 8405148, 8405220</span><br><span class="line">[101471] :: copy 10840962, 2</span><br><span class="line">[101472] :: r64 8405244, 6 + 0</span><br><span class="line">[101473] :: rel 10840962, 0</span><br><span class="line">[101474] :: rel 8405148, 8405244</span><br><span class="line">[101475] :: copy 10841058, 2</span><br><span class="line">[101476] :: r64 8405244, 6 + 0</span><br><span class="line">[101477] :: rel 10841058, 0</span><br><span class="line">[101478] :: copy 10841130, 2</span><br><span class="line">[101479] :: r64 8405244, 6 + 0</span><br><span class="line">[101480] :: rel 10841130, 0</span><br><span class="line">[101481] :: rel 8405148, 8405220</span><br></pre></td></tr></table></figure>

<p>10wå¤šè¡Œé‡å®šä½ä¿¡æ¯å¯¹äºäººç±»æ¥è¯´è¿˜æ˜¯å¤ªæŠ½è±¡äº† <del>ï¼ˆè¿™å¥è¯æ˜¯æˆ‘å†™çš„</del><br>è¿™æ—¶æˆ‘æ³¨æ„åˆ°äº†ä¸€äº›å¥‡æ€ªçš„é‡å®šä½ä¿¡æ¯ï¼š<code>[0377] :: r64 0, 6 + 0</code><br>è¿™æ˜¯å¾€ä¸€ä¸ªç©ºæŒ‡é’ˆé‡Œå†™ä¸œè¥¿ï¼Œä½†æ˜¯ç¨‹åºæ²¡ğŸ”ï¼Œæ‰€ä»¥å¯èƒ½æ˜¯ä¸€äº›é‡å®šä½ä¿¡æ¯åœ¨æ‰§è¡Œæ—¶ä¼šè¢«ä¿®æ”¹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ•°å­—è½åœ¨å“ªä¸ªèŒƒå›´å†…ï¼Œå¦‚æœå®ƒä½äº<code>.rela.dyn</code>æˆ–<code>.dynsym</code>éƒ¨åˆ†å†…ï¼Œåˆ™ä¸ºå…¶åˆ†é…ä¸€ä¸ªç¬¦å·å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŸå§‹æ•°å­—ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“flagï¼ˆ<code>serial</code>ç¬¦å·ï¼‰åœ¨<code>[0x404040:0x40405d]</code>ï¼Œ<code>fail</code>åœ¨<code>0x404060</code>ã€‚</p>
<p>å®šä¹‰æˆ‘ä»¬çš„ç¬¦å·å€¼ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Symbol</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;s<span class="subst">&#123;self.idx&#125;</span>&#x27;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Reloc</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;r<span class="subst">&#123;self.idx&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ref</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    val: <span class="type">Any</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&amp;<span class="subst">&#123;self.val&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SymAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    sym: Symbol</span><br><span class="line">    field: <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;self.sym&#125;</span>.<span class="subst">&#123;self.field&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RelocAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    reloc: Reloc</span><br><span class="line">    field: <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;self.reloc&#125;</span>.<span class="subst">&#123;self.field&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">vaddr</span>(<span class="params">self</span>):</span><br><span class="line">        off = <span class="number">0</span></span><br><span class="line">        <span class="keyword">match</span> self.field:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_address&#x27;</span>:off = <span class="number">0</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_info&#x27;</span>: off = <span class="number">8</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_addend&#x27;</span>: off = <span class="number">16</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (self.reloc.idx * <span class="number">24</span>) + off + rela.virtual_address</span><br><span class="line">    </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlagAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;flag[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line"></span><br><span class="line">BaseAddr = namedtuple(<span class="string">&#x27;baseaddr&#x27;</span>, [])</span><br><span class="line">FailAddr = namedtuple(<span class="string">&#x27;fail&#x27;</span>, [])</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†å†™ä¸€ä¸ªå‡½æ•°<code>format_addr</code>æŠŠè™šæ‹Ÿåœ°å€è½¬ä¸ºç¬¦å·å€¼ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rela = [x <span class="keyword">for</span> x <span class="keyword">in</span> b.sections <span class="keyword">if</span> x.name == <span class="string">&#x27;.rela.dyn&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">dynsym = [x <span class="keyword">for</span> x <span class="keyword">in</span> b.sections <span class="keyword">if</span> x.name == <span class="string">&#x27;.dynsym&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_addr</span>(<span class="params">addr: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= rela.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; rela.virtual_address + rela.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - rela.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_address&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_info&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_addend&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> _: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), r_rem)</span><br><span class="line">    <span class="keyword">elif</span> (addr &gt; dynsym.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; dynsym.virtual_address + dynsym.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - dynsym.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> SymAddr(Symbol(r_offset), <span class="string">&#x27;st_name&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> Symbol(r_offset)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>: <span class="keyword">return</span> SymAddr(Symbol(r_offset), <span class="string">&#x27;st_size&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> _: <span class="keyword">return</span> SymAddr(Symbol(r_offset), r_rem)</span><br><span class="line">    <span class="keyword">elif</span> addr &gt;= <span class="number">0x404040</span> <span class="keyword">and</span> addr &lt; <span class="number">0x404040</span>+<span class="number">29</span>:</span><br><span class="line">        off = addr-<span class="number">0x404040</span></span><br><span class="line">        <span class="keyword">return</span> FlagAddr(off)</span><br><span class="line">    <span class="keyword">elif</span> addr == <span class="number">0x804000</span>:</span><br><span class="line">        <span class="keyword">return</span> BaseAddr()</span><br><span class="line">    <span class="keyword">elif</span> addr == <span class="number">0x404060</span>:</span><br><span class="line">        <span class="keyword">return</span> FailAddr()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure>

<p>è§£ææ—¶ï¼Œå¯¹æ¯ä¸€ä¸ªæ•°å€¼å…ˆè°ƒç”¨å‡½æ•°<code>format_addr</code>ï¼ˆæ­¤å¤„æœªå±•ç¤ºï¼‰ã€‚å¯ä»¥å¾—åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interesting section of NOPs:</span></span><br><span class="line">[<span class="number">0083</span>] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0084] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0085] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0086] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0087] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0088] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0089] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line"></span><br><span class="line"><span class="comment">// Writing some consecutive values into previously</span></span><br><span class="line"><span class="comment">// applied relocations:</span></span><br><span class="line">[0090] :: rel r3.r_address, 0</span><br><span class="line">[0091] :: rel r3.r_info, 1</span><br><span class="line">[0092] :: rel r3.r_addend, 2</span><br><span class="line">[0093] :: rel r4.r_address, 3</span><br><span class="line">[0094] :: rel r4.r_info, 4</span><br><span class="line">[0095] :: rel r4.r_addend, 5</span><br><span class="line">[0096] :: rel r5.r_address, 6</span><br><span class="line">[0097] :: rel r5.r_info, 7</span><br><span class="line">[0098] :: rel r5.r_addend, 8</span><br><span class="line">[0099] :: rel r6.r_address, 9</span><br><span class="line">[0100] :: rel r6.r_info, 10</span><br><span class="line">[0101] :: rel r6.r_addend, 11</span><br><span class="line"></span><br><span class="line"><span class="comment">// Much more readable code!</span></span><br><span class="line">[0343] :: rel r87.r_info, 253</span><br><span class="line">[0344] :: rel r87.r_addend, 254</span><br><span class="line">[0345] :: rel r88.r_address, 255</span><br><span class="line">[0346] :: rel s4, 0</span><br><span class="line">[0347] :: rel s2, r3.r_address</span><br><span class="line">[0348] :: rel s2.st_size, 8</span><br><span class="line">[0349] :: copy r350.r_addend, s2</span><br><span class="line">[0350] :: r64 s4, s4 + 0</span><br><span class="line">[0351] :: rel r350.r_addend, 0</span><br><span class="line">[0352] :: rel s2, flag[0]</span><br><span class="line">[0353] :: rel s2.st_size, 1</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜èƒ½çœ‹åˆ°ç±»ä¼¼çš„ä¸œè¥¿ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0349</span>] :: copy r350.r_addend, s2</span><br><span class="line">[<span class="number">0350</span>] :: r64 s4, s4 + <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>349è¦†å†™äº†350ä¸­çš„åŠ æ•°ã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤å¥è¯åº”è¯¥æ˜¯<code>s4 += s2</code>ï¼ˆ0è¢«è¦†å†™ä¸ºs2ï¼‰</p>
<p>ä¸‹é¢ä¹Ÿæœ‰ç›¸ä¼¼çš„è¦†å†™åœ°å€çš„æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0376</span>] :: copy r377.r_address, s2</span><br><span class="line">[<span class="number">0377</span>] :: r64 <span class="number">0</span>, s6 + <span class="number">0</span></span><br><span class="line"><span class="comment">//s2 = s6</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬å¯¹è¿™äº›ç»“æ„è¿›è¡Œæ¨¡å¼åŒ¹é…å¹¶å®šä¹‰æ›´é«˜çº§åˆ«çš„æ“ä½œï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¾—åˆ°ä¸€äº›æ›´ç®€æ´çš„ä»£ç </p>
<h2 id="Part2"><a href="#Part2" class="headerlink" title="Part2"></a>Part2</h2><p><del>ä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆä¸ç¿»è¯‘æ ‡é¢˜ï¼Œå› ä¸ºè¿™å¥è¯æˆ‘ä¹Ÿæ²¡çœ‹æ‡‚ï¼ğŸ˜­ï¼ˆå¦‚æœæœ‰çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€çš„å¸ˆå‚…è¯·åŠ¡å¿…å‘Šè¯‰æˆ‘</del></p>
<h3 id="Arr-Out-references"><a href="#Arr-Out-references" class="headerlink" title="Arr + Out references"></a>Arr + Out references</h3><p>åœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œæˆ‘æ³¨æ„åˆ°ä¸€äº›é‡å®šä½ä¿¡æ¯è¢«ä½œä¸ºNOPä½¿ç”¨ï¼ˆå‘å›ºå®šåœ°å€å†™å…¥0ï¼‰ã€‚å…¶ä»–é‡å®šä½ä¿¡æ¯ä¹Ÿä¼šå‘é‚£äº›é‡å®šä½ç‚¹ï¼ˆå¦‚ä¸€ä¸ª<code>uint64_t</code>æ•°ç»„ï¼‰å†™å…¥ä»»æ„çš„å€¼ã€‚</p>
<p>ç‰¹åˆ«æŒ‡å‡ºï¼Œr3åˆ°r88ä¼¼ä¹è¢«ç”¨ä½œä¸€ä¸ªæ•°ç»„ã€‚r89ä¼¼ä¹æ˜¯æŸç§è¾“å‡ºå€¼ï¼ˆä¹‹åä¼šè¯´ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>format_addr</code>æ¥ç†è§£è¿™äº›å¼•ç”¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;out[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArrAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;arr[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_addr</span>(<span class="params">addr: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= rela.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; rela.virtual_address + rela.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - rela.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># --- NEW ---</span></span><br><span class="line">        <span class="keyword">if</span> r_offset &gt;= <span class="number">3</span> <span class="keyword">and</span> r_offset &lt;= <span class="number">88</span>:</span><br><span class="line">            arr_idx = (r_offset - <span class="number">3</span>) * <span class="number">3</span> + (r_rem // <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">return</span> ArrAddr(arr_idx)</span><br><span class="line">        <span class="keyword">elif</span> r_offset == <span class="number">89</span>:</span><br><span class="line">            <span class="keyword">return</span> OutAddr(r_rem)</span><br><span class="line">        <span class="comment"># --- END ---</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹1ï¼ˆ102000æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// Nice array references!</span><br><span class="line">[0338] :: rel arr[248], 248</span><br><span class="line">[0339] :: rel arr[249], 249</span><br><span class="line">[0340] :: rel arr[250], 250</span><br><span class="line">[0341] :: rel arr[251], 251</span><br><span class="line">[0342] :: rel arr[252], 252</span><br><span class="line">[0343] :: rel arr[253], 253</span><br><span class="line">[0344] :: rel arr[254], 254</span><br><span class="line">[0345] :: rel arr[255], 255</span><br><span class="line">[0346] :: rel s4, 0</span><br><span class="line">[0347] :: rel s2, arr[0]            // neat</span><br><span class="line">[0348] :: rel s2.st_size, 8</span><br><span class="line">[0349] :: copy r350.r_addend, s2</span><br><span class="line">[0350] :: r64 s4, s4 + 0</span><br><span class="line">[0351] :: rel r350.r_addend, 0</span><br><span class="line">[0352] :: rel s2, flag[0]           // flag!</span><br><span class="line">[0353] :: rel s2.st_size, 1</span><br><span class="line">[0354] :: copy s7, s2</span><br><span class="line">[0355] :: rel s2, s7</span><br><span class="line">[0356] :: rel s2.st_size, 8</span><br><span class="line">[0357] :: copy r358.r_addend, s2</span><br><span class="line">[0358] :: r64 s4, s4 + 0</span><br><span class="line">[0359] :: rel r358.r_addend, 0</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: rel s2, arr[0]</span><br><span class="line">[0362] :: copy s6, s2</span><br></pre></td></tr></table></figure>

<p>å¥½çœ‹å¤šäº†ï¼</p>
<h3 id="Mov-Add"><a href="#Mov-Add" class="headerlink" title="Mov + Add"></a>Mov + Add</h3><p>ä¸‹ä¸€æ­¥æˆ‘ä»¬å¯ä»¥æŠŠ<code>Rel</code>ï¼Œ<code>R64</code>å’Œ<code>Copy</code>ä½¿ç”¨æ›´å®¹æ˜“ç†è§£çš„<code>Mov</code>å’Œ<code>Add</code>æ›¿æ¢</p>
<p>ä¸ºäº†çŸ¥é“movçš„å¤§å°ï¼ˆæ ¹æ®<code>Copy</code>å˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è¿½è¸ªæ‰€æœ‰æŒ‡ä»¤ï¼Œç„¶åè·Ÿè¸ªæ¯ä¸ªåç§»å¤„çš„ç¬¦å·å¤§å°ã€‚æˆ‘ä»¬å¯ä»¥åªçœ‹å‘ç¬¦å·<code>st_size</code>å†™çš„éƒ¨åˆ†æ¥è§‚å¯Ÿè¿™äº›å˜åŒ–ã€‚å¹¸è¿çš„æ˜¯ï¼Œå®ƒä»¬åœ¨è¿™ä¸ªç¨‹åºé‡Œæ˜¯ç¡®å®šçš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Mov = namedtuple(<span class="string">&#x27;mov&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;sz&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">Add = namedtuple(<span class="string">&#x27;add&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;addend&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_mov_add</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    sizes = []</span><br><span class="line">    curr = [<span class="number">8</span>] * <span class="number">8</span></span><br><span class="line">    sizes.append(curr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Trace instructions and monitor the size of every symbol.</span></span><br><span class="line">    <span class="keyword">for</span> instr <span class="keyword">in</span> instructions:</span><br><span class="line">        c = <span class="built_in">list</span>(curr)</span><br><span class="line">        <span class="keyword">match</span> instr:</span><br><span class="line">            <span class="keyword">case</span> Rel(SymAddr(Symbol(idx), <span class="string">&#x27;st_size&#x27;</span>), val, ridx):</span><br><span class="line">                c[idx] = val</span><br><span class="line">        sizes.append(c)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Iterate and find Mov/Add patterns.</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Rel(dst, val, ridx):</span><br><span class="line">                instructions[idx] = Mov(dst, Ref(val), <span class="number">8</span>, ridx)</span><br><span class="line">            <span class="keyword">case</span> Copy(dst, sym, ridx):</span><br><span class="line">                instructions[idx] = Mov(</span><br><span class="line">                    dst, sym, sizes[idx][sym.idx], ridx)</span><br><span class="line">            <span class="keyword">case</span> R64(dst, sym, add, ridx):</span><br><span class="line">                instructions[idx] = Add(dst, sym, add, ridx)</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_sizes</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="comment"># Sizes are now nops.</span></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(SymAddr(Symbol(s), <span class="string">&#x27;st_size&#x27;</span>), _, _, _):</span><br><span class="line">                instructions[idx:idx+<span class="number">1</span>] = []</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°æˆ‘ä»¬çš„dumpå‡½æ•°ä»¥æ”¯æŒè¿™äº›æ–°ç±»å‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="keyword">for</span> op <span class="keyword">in</span> instructions:</span><br><span class="line">        <span class="keyword">match</span> op:</span><br><span class="line">            <span class="comment"># --- snip ---</span></span><br><span class="line">            <span class="keyword">case</span> Mov(dst, src, <span class="number">8</span>, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: mov <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Mov(dst, src, sz, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: mov(<span class="subst">&#123;sz&#125;</span>) <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Add(dst, src, add, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: add <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>, <span class="subst">&#123;add&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹2ï¼ˆ96179æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// smoooth</span><br><span class="line">[0336] :: mov arr[246], &amp;246</span><br><span class="line">[0337] :: mov arr[247], &amp;247</span><br><span class="line">[0338] :: mov arr[248], &amp;248</span><br><span class="line">[0339] :: mov arr[249], &amp;249</span><br><span class="line">[0340] :: mov arr[250], &amp;250</span><br><span class="line">[0341] :: mov arr[251], &amp;251</span><br><span class="line">[0342] :: mov arr[252], &amp;252</span><br><span class="line">[0343] :: mov arr[253], &amp;253</span><br><span class="line">[0344] :: mov arr[254], &amp;254</span><br><span class="line">[0345] :: mov arr[255], &amp;255</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: mov s2, &amp;arr[0]</span><br><span class="line">[0349] :: mov r350.r_addend, s2</span><br><span class="line">[0350] :: add s4, s4, 0</span><br><span class="line">[0351] :: mov r350.r_addend, &amp;0</span><br><span class="line">[0352] :: mov s2, &amp;flag[0]</span><br><span class="line">[0354] :: mov(1) s7, s2</span><br><span class="line">[0355] :: mov s2, &amp;s7</span><br><span class="line">[0357] :: mov r358.r_addend, s2</span><br><span class="line">[0358] :: add s4, s4, 0</span><br><span class="line">[0359] :: mov r358.r_addend, &amp;0</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: mov s2, &amp;arr[0]</span><br><span class="line">[0362] :: mov s6, s2</span><br><span class="line">[0363] :: mov s2, &amp;s4</span><br></pre></td></tr></table></figure>

<h3 id="é—´æ¥mov"><a href="#é—´æ¥mov" class="headerlink" title="é—´æ¥mov"></a>é—´æ¥mov</h3><p>å‰é¢æåˆ°è¿‡ï¼ŒæŸäº›é‡å®šä½é‡Œçš„<code>r_addend</code>ä¼šåœ¨ç”¨åˆ°ä¹‹å‰è¢«ä¿®æ”¹ã€‚ä¸¾ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[0349] :: mov r350.r_addend, s2</span><br><span class="line">[0350] :: add s4, s4, 0</span><br><span class="line">[0351] :: mov r350.r_addend, &amp;0</span><br></pre></td></tr></table></figure>

<p>è¿™3å¥æŒ‡ä»¤å…¶å®å°±æ˜¯<code>s4 = s2</code>ã€‚æˆ‘æ„Ÿè§‰äº§ç”Ÿç¬¬3æ¡æŒ‡ä»¤æ˜¯ç¨‹åºç¼–è¯‘æ–¹å¼çš„é—®é¢˜ï¼Œè¿™ç©æ„å…¶å®åº”è¯¥æ²¡ä»€ä¹ˆç”¨ã€‚</p>
<p>ç”¨python3.10æ¥matchï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™ç§ç±»å‹çš„ç»“æ„æ‰§è¡Œæ¸…æ™°çš„æ¨¡å¼åŒ¹é…ï¼Œå¹¶ç”¨ä¸€æ¡AddæŒ‡ä»¤æ›¿æ¢å®ƒï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lift_indirect</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">3</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(RelocAddr(Reloc(r1), <span class="string">&#x27;r_addend&#x27;</span>), sym, _, ridx_1),</span><br><span class="line">                Add(dst_2, sym_2, _, ridx_2),</span><br><span class="line">                Mov(RelocAddr(Reloc(r3), <span class="string">&#x27;r_addend&#x27;</span>), Ref(<span class="number">0</span>), _, _),</span><br><span class="line">            ] <span class="keyword">if</span> (</span><br><span class="line">                (r1 == ridx_2) <span class="keyword">and</span> (r3 == ridx_2)</span><br><span class="line">            ):</span><br><span class="line">                instructions[idx:idx+<span class="number">3</span>] = [</span><br><span class="line">                    Add(dst_2, sym_2, sym, ridx_1)</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹3 ï¼ˆ58155æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: mov s2, &amp;arr[0]</span><br><span class="line">[0349] :: add s4, s4, s2     // wow</span><br><span class="line">[0352] :: mov s2, &amp;flag[0]</span><br><span class="line">[0354] :: mov(1) s7, s2</span><br><span class="line">[0355] :: mov s2, &amp;s7</span><br><span class="line">[0357] :: add s4, s4, s2     // cool</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: mov s2, &amp;arr[0]</span><br><span class="line">[0362] :: mov s6, s2</span><br><span class="line">[0363] :: mov s2, &amp;s4</span><br><span class="line">[0364] :: add s5, s4, s2     // amazing</span><br><span class="line">[0367] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>


<h3 id="åˆ†å—"><a href="#åˆ†å—" class="headerlink" title="åˆ†å—"></a>åˆ†å—</h3><p>æ£€æŸ¥æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°é‡å¤çš„ä»£ç å—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// ---------------</span><br><span class="line">[0378] :: mov s2, &amp;arr[1]</span><br><span class="line">[0379] :: add s4, s4, s2</span><br><span class="line">[0382] :: mov s2, &amp;flag[1]</span><br><span class="line">[0384] :: mov(1) s7, s2</span><br><span class="line">[0385] :: mov s2, &amp;s7</span><br><span class="line">[0387] :: add s4, s4, s2</span><br><span class="line">[0390] :: r64 s4.9, s1 + 0</span><br><span class="line">[0391] :: mov s2, &amp;arr[1]</span><br><span class="line">[0392] :: mov s6, s2</span><br><span class="line">[0393] :: mov s2, &amp;s4</span><br><span class="line">[0394] :: add s5, s4, s2</span><br><span class="line">[0397] :: mov s2, &amp;s5</span><br><span class="line">[0398] :: add s5, s5, s2</span><br><span class="line">[0401] :: add s5, s5, s2</span><br><span class="line">[0404] :: add s5, s5, arr[0]</span><br><span class="line">[0405] :: mov arr[1], s5</span><br><span class="line">[0406] :: mov r407.r_address, s2</span><br><span class="line">[0407] :: add 0, s6, 0</span><br><span class="line">// ---------------</span><br><span class="line">[0408] :: mov s2, &amp;arr[2]</span><br><span class="line">[0409] :: add s4, s4, s2</span><br><span class="line">[0412] :: mov s2, &amp;flag[0]</span><br><span class="line">[0414] :: mov(1) s7, s2</span><br><span class="line">[0415] :: mov s2, &amp;s7</span><br><span class="line">[0417] :: add s4, s4, s2</span><br><span class="line">[0420] :: r64 s4.9, s1 + 0</span><br><span class="line">[0421] :: mov s2, &amp;arr[2]</span><br><span class="line">[0422] :: mov s6, s2</span><br><span class="line">[0423] :: mov s2, &amp;s4</span><br><span class="line">[0424] :: add s5, s4, s2</span><br><span class="line">[0427] :: mov s2, &amp;s5</span><br><span class="line">[0428] :: add s5, s5, s2</span><br><span class="line">[0431] :: add s5, s5, s2</span><br><span class="line">[0434] :: add s5, s5, arr[0]</span><br><span class="line">[0435] :: mov arr[2], s5</span><br><span class="line">[0436] :: mov r437.r_address, s2</span><br><span class="line">[0437] :: add 0, s6, 0</span><br><span class="line">// ---------------</span><br></pre></td></tr></table></figure>

<p>è¿™äº›å—å¹²çš„äº‹æƒ…å°±æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ---</span><br><span class="line">s6 = (s6 + arr[1] + flag[1]) &amp; 0xff</span><br><span class="line">arr[1], arr[s6] = arr[s6], arr[1]</span><br><span class="line"># ---</span><br><span class="line">s6 = (s6 + arr[2] + flag[0]) &amp; 0xff</span><br><span class="line">arr[2], arr[s6] = arr[s6], arr[2]</span><br><span class="line"># ---</span><br></pre></td></tr></table></figure>

<p>ä¼¼ä¹åªæœ‰arrå’Œflagçš„ç´¢å¼•æ”¹å˜äº†ã€‚æ”¹ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Block = namedtuple(&#x27;block&#x27;, [&#x27;arr&#x27;, &#x27;flag&#x27;, &#x27;ridx&#x27;])</span><br><span class="line"></span><br><span class="line">def lift_block(instructions):</span><br><span class="line">    idx = 0</span><br><span class="line">    while idx &lt; len(instructions):</span><br><span class="line">        match instructions[idx:idx+18]:</span><br><span class="line">            case [</span><br><span class="line">                Mov(_,arr,_,ridx),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,flag,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+18] = [</span><br><span class="line">                    Block(arr, flag, ridx)</span><br><span class="line">                ]</span><br><span class="line">        idx += 1</span><br><span class="line">    return instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹4ï¼ˆ23339æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// array set</span><br><span class="line">[0342] :: mov arr[252], &amp;252</span><br><span class="line">[0343] :: mov arr[253], &amp;253</span><br><span class="line">[0344] :: mov arr[254], &amp;254</span><br><span class="line">[0345] :: mov arr[255], &amp;255</span><br><span class="line"></span><br><span class="line">// s4 = 0</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line"></span><br><span class="line">// repeating shuffles...</span><br><span class="line">[0347] :: shuffle &amp;arr[0], &amp;flag[0]</span><br><span class="line">[0378] :: shuffle &amp;arr[1], &amp;flag[1]</span><br><span class="line">[0408] :: shuffle &amp;arr[2], &amp;flag[0]</span><br><span class="line">[0438] :: shuffle &amp;arr[3], &amp;flag[1]</span><br><span class="line">[0468] :: shuffle &amp;arr[4], &amp;flag[0]</span><br><span class="line">[0498] :: shuffle &amp;arr[5], &amp;flag[1]</span><br><span class="line">[0528] :: shuffle &amp;arr[6], &amp;flag[0]</span><br><span class="line"></span><br><span class="line">// later</span><br><span class="line">[24275] :: add s5, s5, s2</span><br><span class="line">[24278] :: add s5, s5, s2</span><br><span class="line">[24281] :: add s5, s5, arr[0]</span><br><span class="line">[24282] :: mov out[8], s5</span><br><span class="line"></span><br><span class="line">// array is reset again...</span><br><span class="line">[24283] :: mov arr[0], &amp;0</span><br><span class="line">[24284] :: mov arr[1], &amp;1</span><br><span class="line">[24285] :: mov arr[2], &amp;2</span><br><span class="line">[24286] :: mov arr[3], &amp;3</span><br><span class="line">[24287] :: mov arr[4], &amp;4</span><br><span class="line">[24288] :: mov arr[5], &amp;5</span><br><span class="line">[24289] :: mov arr[6], &amp;6</span><br><span class="line">[24290] :: mov arr[7], &amp;7</span><br><span class="line">[24291] :: mov arr[8], &amp;8</span><br><span class="line">[24292] :: mov arr[9], &amp;9</span><br><span class="line">[24293] :: mov arr[10], &amp;10</span><br><span class="line">[24294] :: mov arr[11], &amp;11</span><br></pre></td></tr></table></figure>

<h3 id="é‡ç½®-Reset-å’Œå—ç§»åŠ¨-ShuffleBlock"><a href="#é‡ç½®-Reset-å’Œå—ç§»åŠ¨-ShuffleBlock" class="headerlink" title="é‡ç½®(Reset)å’Œå—ç§»åŠ¨(ShuffleBlock)"></a>é‡ç½®(Reset)å’Œå—ç§»åŠ¨(ShuffleBlock)</h3><p>ï¼ˆè¿™é‡Œçš„é‡ç½®å°±æ˜¯æ¸…é›¶çš„æ„æ€ï¼Œå—ç§»åŠ¨çœ‹çœ‹æ ·ä¾‹å°±æ‡‚äº†ï¼ˆé›¾ï¼‰</p>
<p>å¾ˆå¤šæŒ‡ä»¤æ˜¯ç”¨äºæ•°ç»„åˆå§‹åŒ–çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æ·¦æ‰ï¼ˆé›¾<br>è¿˜å¯ä»¥æ·¦æ‰å¾ˆå¤šç”¨äºç§»åŠ¨çš„æŒ‡ä»¤ï¼ˆliftå’Œshuffleä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘äº†ï¼Œä¸è¿‡çœ‹äº†æ ·ä¾‹å°±çŸ¥é“ä»€ä¹ˆæ„æ€äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Reset = namedtuple(<span class="string">&#x27;reset&#x27;</span>, [<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">ShuffleBlock = namedtuple(<span class="string">&#x27;shuffleblock&#x27;</span>, [<span class="string">&#x27;f1&#x27;</span>, <span class="string">&#x27;f2&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_reset</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions) - <span class="number">256</span>:</span><br><span class="line">        good = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            op = instructions[idx+i]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(op) == Mov:</span><br><span class="line">                dst, src, _, _ = op</span><br><span class="line">                <span class="keyword">if</span> dst != ArrAddr(i) <span class="keyword">or</span> src != Ref(i):</span><br><span class="line">                    good = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                good = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> good:</span><br><span class="line">            instructions[idx:idx+<span class="number">256</span>] = [</span><br><span class="line">                Reset(instructions[idx].ridx)</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_shuffle_block</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions) - <span class="number">256</span>:</span><br><span class="line">        good = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            op = instructions[idx+i]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(op) == Block:</span><br><span class="line">                arr, flag, ridx = op</span><br><span class="line">                <span class="keyword">if</span> arr != Ref(ArrAddr(i)):</span><br><span class="line">                    good = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                good = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> good:</span><br><span class="line">            instructions[idx:idx+<span class="number">256</span>] = [</span><br><span class="line">                ShuffleBlock(</span><br><span class="line">                    instructions[idx].flag,</span><br><span class="line">                    instructions[idx+<span class="number">1</span>].flag,</span><br><span class="line">                    instructions[idx].ridx)]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹5ï¼ˆ19259æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[0090] :: reset                             // wow</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]   // so smol</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: mov s2, &amp;arr[0]</span><br><span class="line">[8030] :: add s4, s4, s2</span><br><span class="line">[8033] :: r32 s4.9, s1, 0</span><br><span class="line">// ...</span><br><span class="line">[8154] :: mov out[2], s5</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]   // another!</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: mov s2, &amp;arr[0]</span><br><span class="line">[16094] :: add s4, s4, s2</span><br><span class="line">[16097] :: r32 s4.9, s1, 0</span><br></pre></td></tr></table></figure>

<h3 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h3><p>åœ¨æ¯ä¸ª<code>reset</code>&#x2F;<code>shuffleblock</code>å¯¹ä¹‹é—´ï¼Œä¼¼ä¹æœ‰ä¸‰ä¸ªé‡å¤çš„æŒ‡ä»¤å—å†™å…¥è¯¥<code>out</code>åŒºåŸŸï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// ---------------</span><br><span class="line">[8029] :: mov s2, &amp;arr[0]</span><br><span class="line">[8030] :: add s4, s4, s2</span><br><span class="line">[8033] :: r32 s4.9, s1, 0</span><br><span class="line">[8034] :: mov s6, s2</span><br><span class="line">[8035] :: mov s2, &amp;s4</span><br><span class="line">[8036] :: add s5, s4, s2</span><br><span class="line">[8039] :: mov s2, &amp;s5</span><br><span class="line">[8040] :: add s5, s5, s2</span><br><span class="line">[8043] :: add s5, s5, s2</span><br><span class="line">[8046] :: add s5, s5, arr[0]</span><br><span class="line">[8047] :: mov arr[0], s5</span><br><span class="line">[8048] :: mov s2, &amp;arr[0]</span><br><span class="line">[8049] :: mov s7, s2</span><br><span class="line">[8050] :: mov s2, &amp;s5</span><br><span class="line">[8051] :: mov r8052.r_address, s2</span><br><span class="line">[8052] :: add 0, s6, 0</span><br><span class="line">[8053] :: mov s2, &amp;s7</span><br><span class="line">[8054] :: add s6, s6, s2</span><br><span class="line">[8057] :: r32 s6.9, s1, 0</span><br><span class="line">[8058] :: mov s2, &amp;s6</span><br><span class="line">[8059] :: add s5, s6, s2</span><br><span class="line">[8062] :: mov s2, &amp;s5</span><br><span class="line">[8063] :: add s5, s5, s2</span><br><span class="line">[8066] :: add s5, s5, s2</span><br><span class="line">[8069] :: add s5, s5, arr[0]</span><br><span class="line">[8070] :: mov out[0], s5</span><br><span class="line">// ---------------</span><br><span class="line">[8071] :: mov s2, &amp;arr[1]</span><br><span class="line">[8072] :: add s4, s4, s2</span><br><span class="line">[8075] :: r32 s4.9, s1, 0</span><br><span class="line">[8076] :: mov s6, s2</span><br><span class="line">[8077] :: mov s2, &amp;s4</span><br><span class="line">[8078] :: add s5, s4, s2</span><br><span class="line">[8081] :: mov s2, &amp;s5</span><br><span class="line">[8082] :: add s5, s5, s2</span><br><span class="line">[8085] :: add s5, s5, s2</span><br><span class="line">[8088] :: add s5, s5, arr[0]</span><br><span class="line">[8089] :: mov arr[1], s5</span><br><span class="line">[8090] :: mov s2, &amp;arr[1]</span><br><span class="line">[8091] :: mov s7, s2</span><br><span class="line">[8092] :: mov s2, &amp;s5</span><br><span class="line">[8093] :: mov r8094.r_address, s2</span><br><span class="line">[8094] :: add 0, s6, 0</span><br><span class="line">[8095] :: mov s2, &amp;s7</span><br><span class="line">[8096] :: add s6, s6, s2</span><br><span class="line">[8099] :: r32 s6.9, s1, 0</span><br><span class="line">[8100] :: mov s2, &amp;s6</span><br><span class="line">[8101] :: add s5, s6, s2</span><br><span class="line">[8104] :: mov s2, &amp;s5</span><br><span class="line">[8105] :: add s5, s5, s2</span><br><span class="line">[8108] :: add s5, s5, s2</span><br><span class="line">[8111] :: add s5, s5, arr[0]</span><br><span class="line">[8112] :: mov out[1], s5</span><br><span class="line">// ---------------</span><br></pre></td></tr></table></figure>

<p>å®ƒä»¬å¹²çš„äº‹æƒ…å°±æ˜¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---</span></span><br><span class="line">s4 = (s4 + arr[<span class="number">0</span>]) &amp; <span class="number">0xff</span></span><br><span class="line">arr[<span class="number">0</span>], arr[s4] = arr[s4], arr[<span class="number">0</span>]</span><br><span class="line">out[<span class="number">0</span>] = arr[(arr[<span class="number">0</span>] + arr[s4]) &amp; <span class="number">0xff</span>]</span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line">s4 = (s4 + arr[<span class="number">1</span>]) &amp; <span class="number">0xff</span></span><br><span class="line">arr[<span class="number">1</span>], arr[s4] = arr[s4], arr[<span class="number">1</span>]</span><br><span class="line">out[<span class="number">1</span>] = arr[(arr[<span class="number">1</span>] + arr[s4]) &amp; <span class="number">0xff</span>]</span><br><span class="line"><span class="comment"># ---</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æŠŠå®ƒæ·¦æ‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Output = namedtuple(<span class="string">&#x27;output&#x27;</span>, [<span class="string">&#x27;out&#x27;</span>, <span class="string">&#x27;arr&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_output</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">26</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(_,arr,_,ridx),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(out,_,_,_),</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+<span class="number">26</span>] = [Output(out, arr, ridx)]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹6ï¼ˆ18659æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// hey this is looking almost readable</span><br><span class="line">[0090] :: reset</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: output out[0], &amp;arr[0]        // neat</span><br><span class="line">[8071] :: output out[1], &amp;arr[1]</span><br><span class="line">[8113] :: output out[2], &amp;arr[2]</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: output out[3], &amp;arr[0]</span><br><span class="line">[16135] :: output out[4], &amp;arr[1]</span><br><span class="line">[16177] :: output out[5], &amp;arr[2]</span><br><span class="line">[16219] :: reset</span><br><span class="line">[16475] :: mov s4, &amp;0</span><br><span class="line">[16476] :: shuffleblock &amp;flag[4], &amp;flag[5]</span><br><span class="line">[24156] :: mov s4, &amp;0</span><br><span class="line">[24157] :: output out[6], &amp;arr[0]</span><br><span class="line">[24199] :: output out[7], &amp;arr[1]</span><br><span class="line">[24241] :: output out[8], &amp;arr[2]</span><br><span class="line">[24283] :: reset</span><br><span class="line">[24539] :: mov s4, &amp;0</span><br><span class="line">[24540] :: shuffleblock &amp;flag[6], &amp;flag[7]</span><br><span class="line">[32220] :: mov s4, &amp;0</span><br><span class="line">[32221] :: output out[9], &amp;arr[0]</span><br><span class="line">[32263] :: output out[10], &amp;arr[1]</span><br><span class="line">[32305] :: output out[11], &amp;arr[2]</span><br><span class="line">[32347] :: reset</span><br><span class="line">[32603] :: mov s4, &amp;0</span><br></pre></td></tr></table></figure>

<h3 id="MultAdd"><a href="#MultAdd" class="headerlink" title="MultAdd"></a>MultAdd</h3><p>ï¼ˆå°±æ˜¯å¤šæ¬¡åŠ æ³•ï¼‰</p>
<p>checkåˆ°<code>flag[16]</code>ä¹‹åï¼Œä¸Šé¢é‚£ç§ä»£ç æ²¡äº†ï¼Œæ¢äº†æ–°çš„åŠ å¯†æ–¹å¼ã€‚<br>é‡åˆ°ä¸€äº›æ–°çš„å—ï¼Œå®ƒä»¬ä¼¼ä¹ä¸å¤ªä¸€æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">/ ----------</span><br><span class="line">[64730] :: mov s2, &amp;out[2]</span><br><span class="line">[64732] :: mov(1) s5, s2</span><br><span class="line">[64733] :: mov s6, &amp;0</span><br><span class="line">[64734] :: mov s2, &amp;s6</span><br><span class="line">[64736] :: add s6, s6, s2</span><br><span class="line">[64739] :: mov s2, &amp;s5</span><br><span class="line">[64740] :: add s6, s6, s2</span><br><span class="line">[64743] :: mov s2, &amp;s6</span><br><span class="line">[64744] :: add s6, s6, s2</span><br><span class="line">[64747] :: mov s2, &amp;s5</span><br><span class="line">[64748] :: add s6, s6, s2</span><br><span class="line">[64751] :: mov s2, &amp;s6</span><br><span class="line">[64752] :: add s6, s6, s2</span><br><span class="line">[64755] :: add s6, s6, s2</span><br><span class="line">[64758] :: mov s2, &amp;s5</span><br><span class="line">[64759] :: add s6, s6, s2</span><br><span class="line">[64762] :: mov s2, &amp;s6</span><br><span class="line">[64763] :: add s6, s6, s2</span><br><span class="line">[64766] :: add s6, s6, s2</span><br><span class="line">[64769] :: add s6, s6, s2</span><br><span class="line">[64772] :: add s6, s6, s2</span><br><span class="line">[64775] :: add s7, s7, s2</span><br><span class="line">// ----------</span><br><span class="line">[64778] :: mov s2, &amp;out[3]</span><br><span class="line">[64780] :: mov(1) s5, s2</span><br><span class="line">[64781] :: mov s6, &amp;0</span><br><span class="line">[64782] :: mov s2, &amp;s6</span><br><span class="line">[64784] :: add s6, s6, s2</span><br><span class="line">[64787] :: mov s2, &amp;s5</span><br><span class="line">[64788] :: add s6, s6, s2</span><br><span class="line">[64791] :: mov s2, &amp;s6</span><br><span class="line">[64792] :: add s6, s6, s2</span><br><span class="line">[64795] :: mov s2, &amp;s5</span><br><span class="line">[64796] :: add s6, s6, s2</span><br><span class="line">[64799] :: mov s2, &amp;s6</span><br><span class="line">[64800] :: add s6, s6, s2</span><br><span class="line">[64803] :: mov s2, &amp;s5</span><br><span class="line">[64804] :: add s6, s6, s2</span><br><span class="line">[64807] :: mov s2, &amp;s6</span><br><span class="line">[64808] :: add s6, s6, s2</span><br><span class="line">[64811] :: mov s2, &amp;s5</span><br><span class="line">[64812] :: add s6, s6, s2</span><br><span class="line">[64815] :: mov s2, &amp;s6</span><br><span class="line">[64816] :: add s6, s6, s2</span><br><span class="line">[64819] :: add s6, s6, s2</span><br><span class="line">[64822] :: mov s2, &amp;s5</span><br><span class="line">[64823] :: add s6, s6, s2</span><br><span class="line">[64826] :: mov s2, &amp;s6</span><br><span class="line">[64827] :: add s6, s6, s2</span><br><span class="line">[64830] :: mov s2, &amp;s5</span><br><span class="line">[64831] :: add s6, s6, s2</span><br><span class="line">[64834] :: mov s2, &amp;s6</span><br><span class="line">[64835] :: add s7, s7, s2</span><br><span class="line">/ ----------</span><br></pre></td></tr></table></figure>

<p>è¿™äº›å—å¹²çš„äº‹æƒ…å°±æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// s5 = out[3]</span><br><span class="line">[64778] :: mov s2, &amp;out[3]</span><br><span class="line">[64780] :: mov(1) s5, s2</span><br><span class="line">[64781] :: mov s6, &amp;0</span><br><span class="line"></span><br><span class="line">// compute some multiple of s5</span><br><span class="line"></span><br><span class="line">// add result to s7</span><br><span class="line">[64835] :: add s7, s7, s2</span><br></pre></td></tr></table></figure>

<p>å†…éƒ¨çš„ä¸€äº›ä»£ç æ‰§è¡Œçš„å°±æ˜¯<code>s6 += s5</code>ï¼ˆ+ï¼‰æˆ–<code>s6 += s6</code>ï¼ˆÃ—2ï¼‰</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[64730] :: mov s2, &amp;out[2]</span><br><span class="line">[64732] :: mov(1) s5, s2    // s5 = out[2]</span><br><span class="line">[64733] :: mov s6, &amp;0       // s6 = 0</span><br><span class="line"></span><br><span class="line">[64734] :: mov s2, &amp;s6</span><br><span class="line">[64736] :: add s6, s6, s2   // s6 = 0</span><br><span class="line">[64739] :: mov s2, &amp;s5</span><br><span class="line">[64740] :: add s6, s6, s2   // s6 = out[2]</span><br><span class="line">[64743] :: mov s2, &amp;s6</span><br><span class="line">[64744] :: add s6, s6, s2   // s6 = 2 * out[2]</span><br><span class="line">[64747] :: mov s2, &amp;s5</span><br><span class="line">[64748] :: add s6, s6, s2   // s6 = 3 * out[2]</span><br><span class="line">[64751] :: mov s2, &amp;s6</span><br><span class="line">[64752] :: add s6, s6, s2   // s6 = 6 * out[2]</span><br><span class="line">[64755] :: add s6, s6, s2   // s6 = 12 * out[2]</span><br><span class="line">[64758] :: mov s2, &amp;s5</span><br><span class="line">[64759] :: add s6, s6, s2   // s6 = 13 * out[2]</span><br><span class="line">[64762] :: mov s2, &amp;s6</span><br><span class="line">[64763] :: add s6, s6, s2   // s6 = 26 * out[2]</span><br><span class="line">[64766] :: add s6, s6, s2   // s6 = 52 * out[2]</span><br><span class="line">[64769] :: add s6, s6, s2   // s6 = 104 * out[2]</span><br><span class="line">[64772] :: add s6, s6, s2   // s6 = 208 * out[2]</span><br><span class="line"></span><br><span class="line">[64775] :: add s7, s7, s2   // s7 += (208 * out[2])</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶æœ‰ç‚¹éº»çƒ¦ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥æŠŠå®ƒæ·¦æ‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">MultAdd = namedtuple(<span class="string">&#x27;multadd&#x27;</span>, [<span class="string">&#x27;out&#x27;</span>, <span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_multadd</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">3</span>]:</span><br><span class="line">            <span class="comment"># block prefix</span></span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), out, _, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">5</span>), Symbol(<span class="number">2</span>), _, _),</span><br><span class="line">                Mov(Symbol(<span class="number">6</span>), Ref(<span class="number">0</span>), _, _),</span><br><span class="line">            ]:</span><br><span class="line">                k = <span class="number">0</span></span><br><span class="line">                double = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                ptr = idx + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">                good = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">6</span>)), _, _):</span><br><span class="line">                            double = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">case</span> Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">5</span>)), _, _):</span><br><span class="line">                            double = <span class="literal">False</span></span><br><span class="line">                        <span class="keyword">case</span> Add(Symbol(<span class="number">6</span>), Symbol(<span class="number">6</span>), Symbol(<span class="number">2</span>), _):</span><br><span class="line">                            k = (k * <span class="number">2</span>) <span class="keyword">if</span> double <span class="keyword">else</span> (k + <span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">case</span> Add(Symbol(<span class="number">7</span>), Symbol(<span class="number">7</span>), Symbol(<span class="number">2</span>), _):</span><br><span class="line">                            ptr += <span class="number">1</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            good = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> good:</span><br><span class="line">                    instructions[idx:ptr] = [</span><br><span class="line">                        MultAdd(Symbol(<span class="number">7</span>), out, k, ridx)</span><br><span class="line">                    ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹7ï¼ˆ2377æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[56795] :: mov s4, &amp;0</span><br><span class="line">[56796] :: shuffleblock &amp;flag[14], &amp;flag[15]</span><br><span class="line">[64476] :: mov s4, &amp;0</span><br><span class="line">[64477] :: output out[21], &amp;arr[0]</span><br><span class="line">[64519] :: output out[22], &amp;arr[1]</span><br><span class="line">[64561] :: output out[23], &amp;arr[2]</span><br><span class="line">[64603] :: mov s2, &amp;r101917.r_address</span><br><span class="line">[64605] :: mov(2064) arr[0], s2</span><br><span class="line">[64606] :: mov s4, &amp;0</span><br><span class="line">[64607] :: mov s5, &amp;0</span><br><span class="line">[64608] :: mov s7, &amp;-393039</span><br><span class="line">[64609] :: madd s7 += (&amp;out[0] * 155)   // math!</span><br><span class="line">[64667] :: madd s7 += (&amp;out[1] * 190)</span><br><span class="line">[64730] :: madd s7 += (&amp;out[2] * 208)</span><br><span class="line">[64778] :: madd s7 += (&amp;out[3] * 123)</span><br><span class="line">[64838] :: madd s7 += (&amp;out[4] * 214)</span><br><span class="line">[64896] :: madd s7 += (&amp;out[5] * 146)</span><br><span class="line">[64944] :: madd s7 += (&amp;out[6] * 211)</span><br><span class="line">[65002] :: madd s7 += (&amp;out[7] * 85)</span><br><span class="line">[65052] :: madd s7 += (&amp;out[8] * 87)</span><br><span class="line">[65107] :: madd s7 += (&amp;out[9] * 251)</span><br><span class="line">[65175] :: madd s7 += (&amp;out[10] * 122)</span><br><span class="line">[65230] :: madd s7 += (&amp;out[11] * 60)</span><br><span class="line">[65277] :: madd s7 += (&amp;out[12] * 237)</span><br><span class="line">[65340] :: madd s7 += (&amp;out[13] * 27)</span><br><span class="line">[65384] :: madd s7 += (&amp;out[14] * 63)</span><br><span class="line">[65441] :: madd s7 += (&amp;out[15] * 207)</span><br><span class="line">[65504] :: madd s7 += (&amp;out[16] * 33)</span><br><span class="line">[65541] :: madd s7 += (&amp;out[17] * 138)</span><br><span class="line">[65589] :: madd s7 += (&amp;out[18] * 51)</span><br><span class="line">[65636] :: madd s7 += (&amp;out[19] * 103)</span><br><span class="line">[65691] :: madd s7 += (&amp;out[20] * 58)</span><br><span class="line">[65738] :: madd s7 += (&amp;out[21] * 68)</span><br><span class="line">[65778] :: madd s7 += (&amp;out[22] * 120)</span><br><span class="line">[65828] :: madd s7 += (&amp;out[23] * 111)</span><br><span class="line">[65888] :: mov s2, &amp;s5.11</span><br><span class="line">[65890] :: mov(5) s7.11, s2</span><br><span class="line">[65891] :: mov s2, &amp;s7</span><br><span class="line">[65893] :: add s4, s4, s2</span><br><span class="line">[65896] :: mov s7, &amp;-368502</span><br><span class="line">[65897] :: madd s7 += (&amp;out[0] * 254)</span><br><span class="line">[65965] :: madd s7 += (&amp;out[1] * 21)</span><br><span class="line">[66004] :: madd s7 += (&amp;out[2] * 157)</span><br><span class="line">[66062] :: madd s7 += (&amp;out[3] * 204)</span><br><span class="line">[66115] :: madd s7 += (&amp;out[4] * 56)</span><br><span class="line">[66157] :: madd s7 += (&amp;out[5] * 134)</span><br></pre></td></tr></table></figure>

<h3 id="Trunc"><a href="#Trunc" class="headerlink" title="Trunc"></a>Trunc</h3><p>æ¯ç»„<code>madd</code>æŒ‡ä»¤ä¹‹åï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€äº›å¥‡æ€ªçš„æŒ‡ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[65888] :: mov s2, &amp;s5.11</span><br><span class="line">[65890] :: mov(5) s7.11, s2</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ­£åœ¨å¾€ä¸€ä¸ªç¬¦å·å€¼çš„åç§»ä¸º11çš„åœ°æ–¹ï¼ˆå°±æ˜¯<code>&amp;sym.st_value + 3</code>ï¼‰å†™å…¥å€¼ã€‚</p>
<p>æ£€æŸ¥è¿™äº›ä»£ç ï¼Œå¯ä»¥å‘ç°s5æ€»ä¸º0ã€‚æ‰€ä»¥è¿™ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠè¿™ä¸ªç¬¦å·å€¼çš„é«˜5å­—èŠ‚æ¸…é›¶ï¼Œå³<code>sym &amp;= 0xffffff</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Trunc = namedtuple(<span class="string">&#x27;trunc&#x27;</span>, [<span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line">def lift_truncate(instructions):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; len(instructions):</span><br><span class="line">        match instructions[idx:idx+<span class="number">2</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), Ref(SymAddr(Symbol(<span class="number">5</span>), <span class="number">11</span>)), _, ridx),</span><br><span class="line">                Mov(SymAddr(Symbol(<span class="number">7</span>), <span class="number">11</span>), Symbol(<span class="number">2</span>), <span class="number">5</span>, _)</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+<span class="number">2</span>] = [</span><br><span class="line">                    Trunc(Symbol(<span class="number">7</span>), <span class="number">0xffffff</span>, ridx)]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹8ï¼ˆ2336æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[80967] :: madd s7 += (&amp;out[17] * 219)</span><br><span class="line">[81030] :: madd s7 += (&amp;out[18] * 74)</span><br><span class="line">[81075] :: madd s7 += (&amp;out[19] * 223)</span><br><span class="line">[81143] :: madd s7 += (&amp;out[20] * 220)</span><br><span class="line">[81201] :: madd s7 += (&amp;out[21] * 235)</span><br><span class="line">[81264] :: madd s7 += (&amp;out[22] * 151)</span><br><span class="line">[81322] :: madd s7 += (&amp;out[23] * 165)</span><br><span class="line">[81375] :: trunc s7 &amp;= 0xffffff         // yay</span><br><span class="line">[81378] :: mov s2, &amp;s7</span><br><span class="line">[81380] :: add s4, s4, s2</span><br><span class="line">[81383] :: mov s7, &amp;-488931</span><br><span class="line">[81384] :: madd s7 += (&amp;out[0] * 207)</span><br><span class="line">[81447] :: madd s7 += (&amp;out[1] * 123)</span><br><span class="line">[81507] :: madd s7 += (&amp;out[2] * 9)</span><br></pre></td></tr></table></figure>

<h3 id="Array-slots"><a href="#Array-slots" class="headerlink" title="Array slots"></a>Array slots</h3><p>åœ¨æ–°çš„å­—èŠ‚ç é‡Œï¼Œæˆ‘ä»¬å‘ç°äº†å·¨å¤šå¸¸é‡ã€‚è¿˜æœ‰ä¸€äº›åƒæ•°ç»„çš„æ–°åœ°æ–¹ï¼š</p>
<p>æ³¨æ„ï¼šsetinfoåªæ˜¯ä¸€ä¸ªè¿›å…¥st_nameè®¾ç½®å…¶ä»–å­—æ®µçš„8å­—èŠ‚movã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// NOP relocations for array space</span><br><span class="line">[93678] :: mov baseaddr(), &amp;0</span><br><span class="line">[93679] :: mov baseaddr(), &amp;0</span><br><span class="line">[93680] :: mov baseaddr(), &amp;0</span><br><span class="line">[93681] :: mov baseaddr(), &amp;0</span><br><span class="line">[93682] :: mov baseaddr(), &amp;0</span><br><span class="line">[93683] :: mov baseaddr(), &amp;0</span><br><span class="line">// Array data...</span><br><span class="line">[93684] :: mov r93678.r_address, &amp;6124966137932793672</span><br><span class="line">[93685] :: mov r93678.r_info, &amp;-4041842636978026168</span><br><span class="line">[93686] :: mov r93678.r_addend, &amp;5027987508982512709</span><br><span class="line">[93687] :: mov r93679.r_address, &amp;-8413873093579112200</span><br><span class="line">[93688] :: mov r93679.r_info, &amp;5011179070235933765</span><br><span class="line">[93689] :: mov r93679.r_addend, &amp;4323655821306185960</span><br><span class="line">[93690] :: mov r93680.r_address, &amp;7154245383694349856</span><br><span class="line">[93691] :: mov r93680.r_info, &amp;-3458402876407461680</span><br><span class="line">[93692] :: mov r93680.r_addend, &amp;-5186046161349200369</span><br><span class="line">[93693] :: mov r93681.r_address, &amp;51797902590214145</span><br><span class="line">[93694] :: mov r93681.r_info, &amp;5009120185953550336</span><br><span class="line">[93695] :: mov r93681.r_addend, &amp;-4648246994148326916</span><br><span class="line">[93696] :: mov r93682.r_address, &amp;-8410243179269569141</span><br><span class="line">[93697] :: mov r93682.r_info, &amp;51245831810508869</span><br><span class="line">[93698] :: mov r93682.r_addend, &amp;5011371985779865103</span><br><span class="line">[93699] :: mov r93683.r_address, &amp;215243856300280</span><br><span class="line">[93700] :: mov s3, &amp;r93678.r_address</span><br><span class="line">[93701] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93702] :: add s5, s3, 0</span><br><span class="line">[93703] :: mov s2, &amp;r101997.r_address</span><br><span class="line">[93705] :: mov(144) r93678.r_address, s2</span><br><span class="line">[93706] :: mov s2, &amp;s5</span><br><span class="line">[93708] :: add s4, s4, s2</span><br><span class="line">[93711] :: mov s5, &amp;0</span><br><span class="line">[93712] :: mov s7, &amp;-55708</span><br><span class="line">[93713] :: madd s7 += (&amp;flag[16] * 76)</span><br><span class="line">[93758] :: madd s7 += (&amp;flag[17] * 104)</span><br><span class="line">[93803] :: mov s2, &amp;flag[18]</span><br><span class="line">[93805] :: mov(1) s5, s2</span><br><span class="line">// Array space?</span><br><span class="line">[93806] :: mov baseaddr(), &amp;0</span><br><span class="line">// Array data...</span><br><span class="line">[93807] :: mov r93806.r_address, &amp;-6989445605485108096</span><br><span class="line">[93808] :: mov r93806.r_info, &amp;195</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br><span class="line">[93814] :: mov(24) r93806.r_address, s2</span><br><span class="line">[93815] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ•°ç»„ä¼¼ä¹æ€»æ˜¯ç”±ä¸€å †nopæŒ‡ä»¤(<code>mov baseaddr(), &amp;0</code>)ç»„æˆï¼Œåé¢è·Ÿç€ä¸€å †movæ¥ç»™æ•°ç»„èµ‹å€¼ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰«æè¿™ç§å­—èŠ‚ç å¹¶æ”¾åˆ°ä¸€ä¸ªå›ºå®šçš„å¸¸é‡æ•°ç»„ä¸­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ArraySlots = namedtuple(<span class="string">&#x27;arr&#x27;</span>, [<span class="string">&#x27;values&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_array_slots</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(BaseAddr(), Ref(<span class="number">0</span>), _, ridx):</span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    op = instructions[ptr]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(op) != Mov <span class="keyword">or</span> op.dst != BaseAddr():</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                start = idx</span><br><span class="line">                end = ptr</span><br><span class="line"></span><br><span class="line">                data = []</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Check for movs into array.</span></span><br><span class="line">                vstart = RelocAddr(Reloc(ridx), <span class="string">&#x27;r_address&#x27;</span>).vaddr()</span><br><span class="line">                offset = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> end + offset &lt; <span class="built_in">len</span>(instructions) <span class="keyword">and</span> offset &lt; ((end - start) * <span class="number">3</span>):</span><br><span class="line">                    op = instructions[end + offset]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(op) == Mov <span class="keyword">and</span> <span class="built_in">type</span>(op.dst) <span class="keyword">is</span> RelocAddr <span class="keyword">and</span> op.dst.vaddr() == vstart + (offset * <span class="number">8</span>):</span><br><span class="line">                        data.append(op.src.val)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    offset += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span>:</span><br><span class="line">                    data += [<span class="number">0</span>] * (((end - start) * <span class="number">3</span>) - <span class="built_in">len</span>(data))   </span><br><span class="line">                    instructions[idx:end+offset] = [</span><br><span class="line">                        ArraySlots(data, ridx)</span><br><span class="line">                    ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹9ï¼ˆ2161æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[93677] :: mov s5, &amp;0</span><br><span class="line">// what a chonker</span><br><span class="line">[93678] :: array [0x5500404040c7c748, -0x38178276b71a76b8, 0x45c700000000fc45, -0x74c414ffffffff08, 0x458b48d06348fc45, 0x3c00b60fd00148e8, 0x6348fc458b147620, -0x2ffeb717ba74b730, -0x47f88981c3ff49f1, 0xb805eb00000001, 0x4583f84509000000, -0x4081e403827cfe04, -0x74b72f9cb703ba75, 0xb60fd00148e845, 0x458bf84509c0b60f, 0xc3c35d9848f8, 0x0, 0x0]</span><br><span class="line">[93700] :: mov s3, &amp;r93678.r_address</span><br><span class="line">[93701] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93702] :: add s5, s3, 0</span><br><span class="line">[93703] :: mov s2, &amp;r101997.r_address</span><br><span class="line">[93705] :: mov(144) r93678.r_address, s2</span><br><span class="line">[93706] :: mov s2, &amp;s5</span><br><span class="line">[93708] :: add s4, s4, s2</span><br><span class="line">[93711] :: mov s5, &amp;0</span><br><span class="line">[93712] :: mov s7, &amp;-55708</span><br><span class="line">[93713] :: madd s7 += (&amp;flag[16] * 76)</span><br><span class="line">[93758] :: madd s7 += (&amp;flag[17] * 104)</span><br><span class="line">[93803] :: mov s2, &amp;flag[18]</span><br><span class="line">[93805] :: mov(1) s5, s2</span><br><span class="line">// smol</span><br><span class="line">[93806] :: array [-0x60ff7fbf1bdadb80, 0xc3, 0x0]</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br></pre></td></tr></table></figure>

<h3 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h3><p>ç°åœ¨é—®é¢˜æ˜¯é‚£äº›å€¼æ˜¯å•¥ä¸œè¥¿ï¼Ÿæˆ‘åˆšå¼€å§‹ä»¥ä¸ºå®ƒä»¬æ˜¯æŸäº›çŸ©é˜µç®—å‡ºæ¥çš„å€¼ã€‚</p>
<p>ä½†æ˜¯æˆ‘æ³¨æ„åˆ°<code>0x48</code>å‰ç¼€å’Œ<code>0xc3</code>åç¼€ï¼Œå¹¶å¯¹å­—èŠ‚ç äº§ç”Ÿäº†æ€€ç–‘ã€‚æˆ‘ä¹‹å‰è¿˜æ³¨æ„åˆ°ï¼Œé‡æ–°å®šä½éƒ¨åˆ†è¢«æ ‡è®°äº†rwxã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æŠŠç¬¬ä¸€ä¸ªå—æ‰”è¿› Binary Ninjaï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆâ€¦â€¦</p>
<p><img src="/img/code/chall_photo/chunk1.png"></p>
<p>å½³äºï¼Œé‚£è‚¯å®šæ˜¯å­—èŠ‚ç äº†ã€‚ç¬¬ä¸€ä¸ªå¤§å‡½æ•°ä¼¼ä¹åªæ˜¯æ£€æŸ¥æ‰€æœ‰æ ‡å¿—å­—èŠ‚æ˜¯å¦åœ¨<code>(0x20, 0x7e)</code>èŒƒå›´å†…ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯å”¯ä¸€çš„å¤§åŠŸèƒ½ï¼Œå…¶ä½™çš„ä¼¼ä¹éƒ½æ˜¯9å­—èŠ‚çš„shellcodeæ•°æ®ã€‚</p>
<p>æˆ‘ä¸å¤ªäº†è§£shellcode æ˜¯å¦‚ä½•åœ¨è¿™é‡Œå®é™…æ‰§è¡Œçš„ï¼Œä½†å®ƒä¸åŠ è½½æŒ‡å‘ shellcode çš„ç¬¦å·æœ‰å…³ã€‚æˆ‘ä»¬å¯ä»¥å°†ä»¥ä¸‹å—è¯†åˆ«ä¸ºâ€œæ‰§è¡Œ shellcodeâ€å—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[93806] :: array [-0x60ff7fbf1bdadb80, 0xc3, 0x0]</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br><span class="line">[93814] :: mov(24) r93806.r_address, s2</span><br></pre></td></tr></table></figure>

<p>æŠŠå®ƒæ·¦æ‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line"></span><br><span class="line">Shellcode = namedtuple(<span class="string">&#x27;shellcode&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_shellcode</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">6</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                ArraySlots(values, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">3</span>), Ref(RelocAddr(Reloc(rel2), <span class="string">&#x27;r_address&#x27;</span>)), _, _),</span><br><span class="line">                Mov(SymAddr(Symbol(<span class="number">3</span>), <span class="string">&#x27;st_name&#x27;</span>), _, _, _),</span><br><span class="line">                Add(dst, Symbol(<span class="number">3</span>), _, _),</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), _, _, _),</span><br><span class="line">                Mov(RelocAddr(Reloc(rel6), <span class="string">&#x27;r_address&#x27;</span>), Symbol(<span class="number">2</span>), _, _)</span><br><span class="line">            ] <span class="keyword">if</span> (rel2 == ridx) <span class="keyword">and</span> (rel6 == ridx):</span><br><span class="line">                instructions[idx:idx+<span class="number">6</span>] = [</span><br><span class="line">                    Shellcode(dst, <span class="string">b&#x27;&#x27;</span>.join([(x &amp; <span class="number">0xffffffffffffffff</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> values]), ridx)</span><br><span class="line">                ]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>dumpçš„æ—¶å€™å¯ä»¥é€šè¿‡<code>capstone</code>å¾—åˆ°æ¼‚äº®çš„åæ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">case</span> Shellcode(dst, code, ridx):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: exec <span class="subst">&#123;dst&#125;</span> &lt;- <span class="subst">&#123;code.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(code, <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">if</span> i.mnemonic == <span class="string">&#x27;ret&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;    0x%x:\t%s\t%s&quot;</span> % (</span><br><span class="line">                i.address, </span><br><span class="line">                i.mnemonic, </span><br><span class="line">                i.op_str.replace(<span class="string">&#x27;0x8040e4&#x27;</span>, <span class="string">&#x27;s5&#x27;</span>)</span><br><span class="line">                        .replace(<span class="string">&#x27;0x8040cc&#x27;</span>, <span class="string">&#x27;s4&#x27;</span>)))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹10ï¼ˆ1771æ¡æŒ‡ä»¤ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// have you seen sexier disassembly?</span><br><span class="line"></span><br><span class="line">[100408] :: add s4, s4, s2</span><br><span class="line">[100411] :: mov s7, &amp;-30801</span><br><span class="line">[100412] :: madd s7 += (&amp;flag[16] * 15)</span><br><span class="line">[100453] :: madd s7 += (&amp;flag[17] * 41)</span><br><span class="line">[100495] :: mov s2, &amp;flag[18]</span><br><span class="line">[100497] :: mov(1) s5, s2</span><br><span class="line">[100498] :: exec r100498.r_address &lt;- c00425e4408000b4c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	rol	byte ptr [s5], 0xb4</span><br><span class="line">--------------------</span><br><span class="line">[100507] :: mov s2, &amp;s5</span><br><span class="line">[100509] :: add s7, s7, s2</span><br><span class="line">[100512] :: mov s2, &amp;flag[19]</span><br><span class="line">[100514] :: mov(1) s5, s2</span><br><span class="line">[100515] :: exec r100515.r_address &lt;- c02c25e440800003c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	shr	byte ptr [s5], 3</span><br><span class="line">--------------------</span><br><span class="line">[100524] :: mov s2, &amp;s5</span><br><span class="line">[100526] :: add s7, s7, s2</span><br><span class="line">[100529] :: mov s2, &amp;flag[20]</span><br><span class="line">[100531] :: mov(1) s5, s2</span><br><span class="line">[100532] :: exec r100532.r_address &lt;- c00c25e440800064c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	ror	byte ptr [s5], 0x64</span><br><span class="line">--------------------</span><br><span class="line">[100541] :: mov s2, &amp;s5</span><br><span class="line">[100543] :: add s7, s7, s2</span><br><span class="line">[100546] :: madd s7 += (&amp;flag[21] * 167)</span><br><span class="line">[100604] :: mov s2, &amp;flag[22]</span><br><span class="line">[100606] :: mov(1) s5, s2</span><br><span class="line">[100607] :: exec r100607.r_address &lt;- c00425e440800051c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	rol	byte ptr [s5], 0x51</span><br><span class="line">--------------------</span><br><span class="line">[100616] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>

<h3 id="Aop"><a href="#Aop" class="headerlink" title="Aop"></a>Aop</h3><p>æ‰€ä»¥è¿™ä¸ªshellcodeåªæ˜¯è¢«ç”¨æ¥åšæ›´å¤šç±»å‹çš„æ“ä½œçš„ä¸€ç§æœºåˆ¶ã€‚</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[100512] :: mov s2, &amp;flag[19]</span><br><span class="line">[100514] :: mov(1) s5, s2</span><br><span class="line">[100515] :: exec r100515.r_address &lt;- c02c25e440800003c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	shr	byte ptr [s5], 3</span><br><span class="line">--------------------</span><br><span class="line">[100524] :: mov s2, &amp;s5</span><br><span class="line">[100526] :: add s7, s7, s2</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå—å°±æ˜¯<code>s7 += (flag[19] &gt;&gt; 3)</code></p>
<p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ä¼¼äºmaddçš„aopï¼ˆåŠ æ“ä½œï¼‰ï¼Œä¸è¿‡å®ƒå¤šäº†ä¸€ä¸ªæ“ä½œç¬¦å·ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Aop = namedtuple(<span class="string">&#x27;aop&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;op&#x27;</span>, <span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_aop</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">5</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), val, _, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">5</span>), Symbol(<span class="number">2</span>), _, _),</span><br><span class="line">                Shellcode(_, data, _),</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">5</span>)), _, _),</span><br><span class="line">                Add(dst, dst2, Symbol(<span class="number">2</span>), _)</span><br><span class="line">            ] <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">24</span> <span class="keyword">and</span> (dst == dst2):</span><br><span class="line">                op = <span class="built_in">next</span>(md.disasm(data, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">                t = op.mnemonic</span><br><span class="line">                k = <span class="built_in">int</span>(op.op_str.split(<span class="string">&#x27;, &#x27;</span>)[-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">                instructions[idx:idx+<span class="number">5</span>] = [</span><br><span class="line">                    Aop(dst, t, val, k, ridx)</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>æ ·ä¾‹11ï¼ˆ1147æ¡æŒ‡ä»¤ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// out madd computation</span><br><span class="line">[64607] :: mov s5, &amp;0</span><br><span class="line">[64608] :: mov s7, &amp;-393039</span><br><span class="line">[64609] :: madd s7 += (&amp;out[0] * 155)</span><br><span class="line">[64667] :: madd s7 += (&amp;out[1] * 190)</span><br><span class="line">[64730] :: madd s7 += (&amp;out[2] * 208)</span><br><span class="line">[64778] :: madd s7 += (&amp;out[3] * 123)</span><br><span class="line">[64838] :: madd s7 += (&amp;out[4] * 214)</span><br><span class="line">[64896] :: madd s7 += (&amp;out[5] * 146)</span><br><span class="line">[64944] :: madd s7 += (&amp;out[6] * 211)</span><br><span class="line">[65002] :: madd s7 += (&amp;out[7] * 85)</span><br><span class="line">[65052] :: madd s7 += (&amp;out[8] * 87)</span><br><span class="line">[65107] :: madd s7 += (&amp;out[9] * 251)</span><br><span class="line">[65175] :: madd s7 += (&amp;out[10] * 122)</span><br><span class="line">[65230] :: madd s7 += (&amp;out[11] * 60)</span><br><span class="line">[65277] :: madd s7 += (&amp;out[12] * 237)</span><br><span class="line">[65340] :: madd s7 += (&amp;out[13] * 27)</span><br><span class="line">[65384] :: madd s7 += (&amp;out[14] * 63)</span><br><span class="line">[65441] :: madd s7 += (&amp;out[15] * 207)</span><br><span class="line">[65504] :: madd s7 += (&amp;out[16] * 33)</span><br><span class="line">[65541] :: madd s7 += (&amp;out[17] * 138)</span><br><span class="line">[65589] :: madd s7 += (&amp;out[18] * 51)</span><br><span class="line">[65636] :: madd s7 += (&amp;out[19] * 103)</span><br><span class="line">[65691] :: madd s7 += (&amp;out[20] * 58)</span><br><span class="line">[65738] :: madd s7 += (&amp;out[21] * 68)</span><br><span class="line">[65778] :: madd s7 += (&amp;out[22] * 120)</span><br><span class="line">[65828] :: madd s7 += (&amp;out[23] * 111)</span><br><span class="line">[65888] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[65891] :: mov s2, &amp;s7</span><br><span class="line">[65893] :: add s4, s4, s2</span><br><span class="line"></span><br><span class="line">// flag 16-27 computation</span><br><span class="line">[98563] :: mov s2, &amp;s7</span><br><span class="line">[98565] :: add s4, s4, s2</span><br><span class="line">[98568] :: mov s7, &amp;-62593</span><br><span class="line">[98569] :: madd s7 += (&amp;flag[16] * 162)</span><br><span class="line">[98617] :: aop s7 += (&amp;flag[17] ror 59)</span><br><span class="line">[98634] :: madd s7 += (&amp;flag[18] * 4)</span><br><span class="line">[98657] :: aop s7 += (&amp;flag[19] shl 0)</span><br><span class="line">[98674] :: madd s7 += (&amp;flag[20] * 207)</span><br><span class="line">[98737] :: madd s7 += (&amp;flag[21] * 128)</span><br><span class="line">[98775] :: aop s7 += (&amp;flag[22] ror 21)</span><br><span class="line">[98792] :: aop s7 += (&amp;flag[23] or 72)</span><br><span class="line">[98809] :: madd s7 += (&amp;flag[24] * 23)</span><br><span class="line">[98853] :: aop s7 += (&amp;flag[25] rol 1)</span><br><span class="line">[98870] :: madd s7 += (&amp;flag[26] * 247)</span><br><span class="line">[98938] :: aop s7 += (&amp;flag[27] shr 3)</span><br><span class="line">[98955] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[98958] :: mov s2, &amp;s7</span><br><span class="line">[98960] :: add s4, s4, s2</span><br><span class="line">[98963] :: mov s7, &amp;-80711</span><br><span class="line">[98964] :: madd s7 += (&amp;flag[16] * 62)</span><br><span class="line">[99016] :: aop s7 += (&amp;flag[17] or 139)</span><br><span class="line">[99033] :: madd s7 += (&amp;flag[18] * 21)</span><br><span class="line">[99072] :: madd s7 += (&amp;flag[19] * 239)</span><br><span class="line">[99140] :: madd s7 += (&amp;flag[20] * 145)</span><br><span class="line">[99188] :: madd s7 += (&amp;flag[21] * 103)</span><br><span class="line">[99243] :: aop s7 += (&amp;flag[22] shr 0)</span><br><span class="line">[99260] :: aop s7 += (&amp;flag[23] rol 228)</span><br><span class="line">[99277] :: madd s7 += (&amp;flag[24] * 184)</span><br><span class="line">[99330] :: madd s7 += (&amp;flag[25] * 241)</span><br><span class="line">[99388] :: madd s7 += (&amp;flag[26] * 72)</span><br><span class="line">[99428] :: aop s7 += (&amp;flag[27] xor 38)</span><br><span class="line">[99445] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[99448] :: mov s2, &amp;s7</span><br><span class="line">[99450] :: add s4, s4, s2</span><br><span class="line">[99453] :: mov s7, &amp;-98024</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·Ÿç€èµ°ä¸‹æ¥çªç„¶æ„Ÿè§‰1kæ¡æŒ‡ä»¤å·²ç»ç®—å°‘çš„äº†ğŸ¤£<br>æ€ªä¸å¾—avç¥æ›¾æ›°ï¼šâ€œ<strong>åŒºåŒºå‡ åƒä¸ªå‡½æ•°</strong>â€</p>
</blockquote>
<p>![](&#x2F;img&#x2F;code&#x2F;chall_photo&#x2F;chunk2.png width&#x3D;50% &#x2F;&gt;</p>
<h2 id="Part3-è§£å†³"><a href="#Part3-è§£å†³" class="headerlink" title="Part3 è§£å†³"></a>Part3 è§£å†³</h2><p>æ ¹æ®å‰é¢çš„åæ±‡ç¼–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°çº¦æŸæ£€æŸ¥å™¨(constraint checker)è¢«åˆ†æˆäº†è¿™æ ·çš„å—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[98963] :: mov s7, &amp;-80711</span><br><span class="line">[98964] :: madd s7 += (&amp;flag[16] * 62)</span><br><span class="line">[99016] :: aop s7 += (&amp;flag[17] or 139)</span><br><span class="line">[99033] :: madd s7 += (&amp;flag[18] * 21)</span><br><span class="line">[99072] :: madd s7 += (&amp;flag[19] * 239)</span><br><span class="line">[99140] :: madd s7 += (&amp;flag[20] * 145)</span><br><span class="line">[99188] :: madd s7 += (&amp;flag[21] * 103)</span><br><span class="line">[99243] :: aop s7 += (&amp;flag[22] shr 0)</span><br><span class="line">[99260] :: aop s7 += (&amp;flag[23] rol 228)</span><br><span class="line">[99277] :: madd s7 += (&amp;flag[24] * 184)</span><br><span class="line">[99330] :: madd s7 += (&amp;flag[25] * 241)</span><br><span class="line">[99388] :: madd s7 += (&amp;flag[26] * 72)</span><br><span class="line">[99428] :: aop s7 += (&amp;flag[27] xor 38)</span><br><span class="line">[99445] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[99448] :: mov s2, &amp;s7</span><br><span class="line">[99450] :: add s4, s4, s2</span><br></pre></td></tr></table></figure>

<p>æ¥è¿‘ç»“å°¾çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[101625] :: mov fail(), &amp;0</span><br><span class="line">[101626] :: exec s4 &lt;- 8b0425cc408000f7d819c0c3000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	mov	eax, dword ptr [s4]</span><br><span class="line">    0x7:	neg	eax</span><br><span class="line">    0x9:	sbb	eax, eax</span><br><span class="line">--------------------</span><br><span class="line">[101635] :: mov s2, &amp;s4</span><br><span class="line">[101637] :: mov fail(), s2</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥s4å¿…é¡»ä¿æŒ0ï¼Œå¦åˆ™å°±è®¾ç½®failç¬¦å·ï¼Œè¯´æ˜flagæ˜¯é”™è¯¯çš„ã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢çš„å—è¡¨ç¤ºå¯¹éƒ¨åˆ†flagçš„æ“ä½œï¼Œç„¶åå†åŠ ä¸Š-80711ï¼ˆs7é‡Œï¼‰å¿…é¡»ç­‰äº0</p>
<h3 id="ååŠæ®µflag"><a href="#ååŠæ®µflag" class="headerlink" title="ååŠæ®µflag"></a>ååŠæ®µflag</h3><p><code>flag[16:27]</code>çº¦æŸä¸€ä¸‹ï¼Œz3ä¸€æŠŠæ¢­äº†ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_end_flag</span>(<span class="params">instructions</span>):</span><br><span class="line">    orig = [BitVec(<span class="string">&#x27;f%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>,<span class="number">28</span>)]</span><br><span class="line">    flag = ([<span class="number">0</span>] * <span class="number">16</span>) + [ZeroExt(<span class="number">24</span>, x) <span class="keyword">for</span> x <span class="keyword">in</span> orig]</span><br><span class="line"></span><br><span class="line">    s = Solver()</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> orig:</span><br><span class="line">        s.add(UGT(o, <span class="number">0x20</span>))</span><br><span class="line">        s.add(ULT(o, <span class="number">0x7f</span>))</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(Symbol(<span class="number">7</span>), Ref(v), _, ridx) <span class="keyword">if</span> <span class="built_in">type</span>(v) <span class="keyword">is</span> <span class="built_in">int</span>:</span><br><span class="line">                x = BitVecVal(v, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> MultAdd(Symbol(<span class="number">7</span>), Ref(FlagAddr(f)), k, _):</span><br><span class="line">                            x += (flag[f] * k)</span><br><span class="line">                        <span class="keyword">case</span> Aop(Symbol(<span class="number">7</span>), op, Ref(FlagAddr(f)), k, _):</span><br><span class="line">                            v = <span class="literal">None</span></span><br><span class="line">                            <span class="keyword">match</span> op:</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;and&#x27;</span>: v = flag[f] &amp; k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;xor&#x27;</span>: v = flag[f] ^ k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;or&#x27;</span>: v = flag[f] | k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;rol&#x27;</span>: v = ZeroExt(<span class="number">24</span>, RotateLeft(Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]), k))</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;ror&#x27;</span>: v = ZeroExt(<span class="number">24</span>, RotateRight(Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]), k))</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;shl&#x27;</span>: v = ZeroExt(<span class="number">24</span>, Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]) &lt;&lt; k)</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;shr&#x27;</span>: v = flag[f] &gt;&gt; k</span><br><span class="line">                                <span class="keyword">case</span> _:</span><br><span class="line">                                    <span class="keyword">raise</span> Exception(<span class="string">f&#x27;unknown aop: <span class="subst">&#123;op&#125;</span>&#x27;</span>)</span><br><span class="line">                            x += v</span><br><span class="line">                        <span class="keyword">case</span> Trunc(Symbol(<span class="number">7</span>), k, _):</span><br><span class="line">                            s.add(x == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(s.check())</span><br><span class="line"></span><br><span class="line">    m = s.model()</span><br><span class="line">    flag = <span class="built_in">bytes</span>([m.<span class="built_in">eval</span>(o).as_long() <span class="keyword">for</span> o <span class="keyword">in</span> orig])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">sat</span></span><br><span class="line"><span class="string">b&#x27;3_3LF_m4g1c&#125;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="outputæ•°ç»„"><a href="#outputæ•°ç»„" class="headerlink" title="outputæ•°ç»„"></a>outputæ•°ç»„</h3><p>æˆ‘ç”¨z3å»çº¦æŸoutæ•°ç»„ï¼ˆè¿™æ•°ç»„é‡Œåªç”¨äº†maddï¼‰ï¼Œä½†æ˜¯8å¤ªå½³äºã€‚</p>
<blockquote>
<p>ctferå®æ„¿ç”¨z3è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼Œä¹Ÿä¸æ„¿å­¦ä¹ çŸ©é˜µæ˜¯ä¸ªå•¥ã€‚<br>â€” cts (@gf_256) <a target="_blank" rel="noopener" href="https://twitter.com/gf_256/status/1543321843037310985?ref_src=twsrc%5Etfw">July 2, 2022</a></p>
</blockquote>
<p>æ¯ä¸ªå•ç‹¬çš„çº¦æŸåªæœ‰maddï¼Œç›¸å½“äºçŸ©é˜µé‡Œçš„ä¸€è¡Œï¼Œå› ä¸ºæ­£å¥½æœ‰24ä¸ªoutå€¼å’Œ24ç»„çº¦æŸï¼ˆæ˜¯ä¸ªæ–¹é˜µï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ±‚è§£è¿™ä¸ªçŸ©é˜µã€‚</p>
<p>è¿™æ¬¡ä¸ç”¨z3ï¼Œç”¨<code>np.linalg.solve</code>æ¥æ±‚è§£çŸ©é˜µï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_out_arr</span>(<span class="params">instructions</span>):</span><br><span class="line">    X = []</span><br><span class="line">    Y = []</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(Symbol(<span class="number">7</span>), Ref(v), _, ridx) <span class="keyword">if</span> <span class="built_in">type</span>(v) <span class="keyword">is</span> <span class="built_in">int</span>:</span><br><span class="line">                row = []</span><br><span class="line"></span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> MultAdd(Symbol(<span class="number">7</span>), Ref(OutAddr(_)), k, _):</span><br><span class="line">                            row.append(k)</span><br><span class="line">                        <span class="keyword">case</span> Trunc(Symbol(<span class="number">7</span>), k, _):</span><br><span class="line">                            X.append(row)</span><br><span class="line">                            Y.append(-v)</span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    a = np.array(X, dtype=np.uint32)</span><br><span class="line">    b = np.array(Y, dtype=np.uint32)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> np.linalg.solve(a,b)]</span><br><span class="line"></span><br><span class="line"><span class="comment">#[134, 72, 7, 236, 29, 49, 88, 228, 231, 231, 227, 16, 242, 80, 242, 1, 224, 113, 46, 224, 108, 91, 103, 182]</span></span><br></pre></td></tr></table></figure>

<h3 id="å‰åŠæ®µflag"><a href="#å‰åŠæ®µflag" class="headerlink" title="å‰åŠæ®µflag"></a>å‰åŠæ®µflag</h3><p>è¿™ä¸ªoutæ•°ç»„æ˜¯æ ¹æ®flagçš„å‰16ä¸ªå­—èŠ‚å’Œè¿™äº›å—è®¡ç®—çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: output out[0], &amp;arr[0]</span><br><span class="line">[8071] :: output out[1], &amp;arr[1]</span><br><span class="line">[8113] :: output out[2], &amp;arr[2]</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: output out[3], &amp;arr[0]</span><br><span class="line">[16135] :: output out[4], &amp;arr[1]</span><br><span class="line">[16177] :: output out[5], &amp;arr[2]</span><br><span class="line">[16219] :: reset</span><br><span class="line">[16475] :: mov s4, &amp;0</span><br><span class="line">[16476] :: shuffleblock &amp;flag[4], &amp;flag[5]</span><br><span class="line">[24156] :: mov s4, &amp;0</span><br><span class="line">[24157] :: output out[6], &amp;arr[0]</span><br><span class="line">[24199] :: output out[7], &amp;arr[1]</span><br><span class="line">[24241] :: output out[8], &amp;arr[2]</span><br><span class="line">[24283] :: reset</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æ¥è¯´ï¼Œ<code>out[0:3]</code>ç”±<code>flag[0:2]</code>è®¡ç®—å¾—åˆ°ã€‚<code>out[3:6]</code>ç”±<code>flag[2:4]</code>å¾—åˆ°ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>å¯¹äºæ¯ä¸ª3å…ƒç»„å¯ä»¥ç›´æ¥çˆ†ç ´ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">solve_start_flag</span>(<span class="params">output</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sim</span>(<span class="params">a,b</span>):</span><br><span class="line">        arr = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line"></span><br><span class="line">        z = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            p = a <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> b</span><br><span class="line">            z = (z + arr[i] + p) &amp; <span class="number">0xff</span></span><br><span class="line">            arr[i], arr[z] = arr[z], arr[i]</span><br><span class="line"></span><br><span class="line">        out = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">        z = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            z = (z + arr[i]) &amp; <span class="number">0xff</span></span><br><span class="line">            arr[i], arr[z] = arr[z], arr[i]</span><br><span class="line">            out[i] = arr[(arr[i] + arr[z]) &amp; <span class="number">0xff</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve_chunk</span>(<span class="params">k1,k2,k3</span>):</span><br><span class="line">        <span class="comment"># Brute force chunk.</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>, <span class="number">0x7f</span>):</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>, <span class="number">0x7f</span>):</span><br><span class="line">                out = sim(a,b)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">abs</span>(out[<span class="number">0</span>] - k1) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">abs</span>(out[<span class="number">1</span>] - k2) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">abs</span>(out[<span class="number">2</span>] - k3) &lt;= <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> (a,b)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    f = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(output),<span class="number">3</span>):</span><br><span class="line">        f += <span class="built_in">list</span>(solve_chunk(*output[i:i+<span class="number">3</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(f)</span><br><span class="line"></span><br><span class="line"><span class="comment">#CTF&#123;H0p3_y0u_l1k</span></span><br></pre></td></tr></table></figure>

<h2 id="å®Œç»“æ’’èŠ±"><a href="#å®Œç»“æ’’èŠ±" class="headerlink" title="å®Œç»“æ’’èŠ±"></a>å®Œç»“æ’’èŠ±</h2><p>å®Œæ•´è„šæœ¬ï¼š<a target="_blank" rel="noopener" href="https://gist.github.com/hgarrereyn/9e536e8b3471d3cb8ecbb5932a776b95">https://gist.github.com/hgarrereyn/9e536e8b3471d3cb8ecbb5932a776b95</a></p>

    </div>

    <div class="about">
        <h1>å…³äºæœ¬æ–‡</h1>
        <p>æœ¬æ–‡ä½œè€… äº‘ä¹‹å›, è®¸å¯ç”± <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>

    
        
    
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/CTF" class="item">CTF</a>
                
                <a href="/Learn" class="item">Learn</a>
                
                <a href="/Diary" class="item">Diary</a>
                
                <a href="/friends" class="item">Friends</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/YunZh1Jun" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/25320847" class="item">Bilibili</a>
                
                <a href="mailto:yunzh1jun@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 äº‘ä¹‹å›<br >é©±åŠ¨ç”± <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
    </body>
</html>