<!DOCTYPE html>
<html lang="zh-cn">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>GoogleCTF2022 eldar - 云之君&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/img/fav/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

  
<meta name="generator" content="Hexo 5.4.2"></head>
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">云之君&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">主页</a>
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Learn">Learn</a>
            
            
            
            <a class="nav-item" href="/Diary">Diary</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/YunZh1Jun" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            
            <span>September</span>
            
            
            
            
            <span>22,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">GoogleCTF2022 eldar</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>翻译了国外一个大神的WP，我什么时候能有这么强😭</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://ctf.harrisongreen.me/2022/googlectf/eldar/">GoogleCTF2022 - eldar</a><br>复现强网杯的deeprev的时候知道的这题，本文是照着复现，翻译了一部分，部分名词我会标注英文原文。很多地方翻的很别扭，因为本人的英语水平实在是太🌶️🐔了……<br>墙裂建议阅读原文 <del>不然看我写的可能只会收获一头雾水。</del><br>其实感觉还是搞得不是很明白，以后如果顿悟了再过来补充(x</p>
<p>涉及到的技术：<br><a target="_blank" rel="noopener" href="https://www.cs.dartmouth.edu/~sergey/wm/woot13-shapiro.pdf">“Weird Machines” in ELF: A Spotlight on the Underappreciated Metadata</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YgtxxLCVD-o">Programming Weird Machines with ELF Metadata</a></p>
<h2 id="ELF重定位"><a href="#ELF重定位" class="headerlink" title="ELF重定位"></a>ELF重定位</h2><p>ELF动态重定位的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr      r_offset;</span><br><span class="line">    Elf64_Xword     r_info;</span><br><span class="line">    Elf64_Sxword    r_addend;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p>info包括一个type和symble(可选)索引：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM(info)             ((info)&gt;&gt;32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE(info)            ((Elf64_Word)(info))</span></span><br></pre></td></tr></table></figure>

<p>动态符号表也是相关的，结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Word      st_name;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_info;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_other;</span><br><span class="line">    Elf64_Half      st_shndx;</span><br><span class="line">    Elf64_Addr      st_value;</span><br><span class="line">    Elf64_Xword     st_size;</span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure>

<p>所有重定位信息都写入<code>r_offset</code>指向的地址。写入的值取决于重定位类型。</p>
<p>eldar使用了以下4种重定位信息：</p>
<h3 id="REL-type-8"><a href="#REL-type-8" class="headerlink" title="REL (type 8)"></a>REL (type 8)</h3><p>将重定位信息设置为一个相对基址的值（但是基址始终为0）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="R64-type-1"><a href="#R64-type-1" class="headerlink" title="R64(type 1)"></a>R64(type 1)</h3><p>将重定位信息设置为 符号值+常数 <em>（原文中是addend）</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = symbols[ELF64_R_SYM(r.r_info)] + r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="R32-type-10"><a href="#R32-type-10" class="headerlink" title="R32 (type 10)"></a>R32 (type 10)</h3><p>和R64一样，只不过被截断为32位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint32_t</span> *)r.r_offset = symbols[ELF64_R_SYM(r.r_info)].st_value + r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="CPY-type-5"><a href="#CPY-type-5" class="headerlink" title="CPY(type 5)"></a>CPY(type 5)</h3><p>从符号地址复制n字节到重定位地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Elf64_Sym sym = symbols[ELF64_R_SYM(r.r_info)];</span><br><span class="line"><span class="built_in">memcpy</span>(r.r_offset, sym.st_value, sym.st_size);</span><br></pre></td></tr></table></figure>

<h2 id="Part1-解析"><a href="#Part1-解析" class="headerlink" title="Part1 解析"></a>Part1 解析</h2><p>我发现lief解析重定位数据和符号信息非常方便</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">b = lief.ELF.parse(<span class="string">&#x27;./eldar&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_sym</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(name) == <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ord</span>(name[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">Rel = namedtuple(<span class="string">&#x27;REL&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;val&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">Copy = namedtuple(<span class="string">&#x27;CPY&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;symbol&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">R64 = namedtuple(<span class="string">&#x27;R64&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;symbol&#x27;</span>,<span class="string">&#x27;addend&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">R32 = namedtuple(<span class="string">&#x27;R32&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>,<span class="string">&#x27;symbol&#x27;</span>,<span class="string">&#x27;addend&#x27;</span>,<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">b</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Loading relocations...&#x27;</span>)</span><br><span class="line">    relocs = <span class="built_in">list</span>(b.relocations)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Parsing...&#x27;</span>)</span><br><span class="line">    instructions = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="built_in">len</span>(relocs)):</span><br><span class="line">        r = relocs[i]</span><br><span class="line">        <span class="keyword">match</span> r.<span class="built_in">type</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: <span class="comment"># R64</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    R64(r.address, to_sym(r.symbol.name), r.addend, i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: <span class="comment"># CPY</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    Copy(r.address, to_sym(r.symbol.name), i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="comment"># REL</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    Rel(r.address, r.addend, i))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>: <span class="comment"># R32</span></span><br><span class="line">                instructions.append(</span><br><span class="line">                    R32(r.address, to_sym(r.symbol.name), r.addend, i))</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="keyword">for</span> op <span class="keyword">in</span> instructions:</span><br><span class="line">        <span class="keyword">match</span> op:</span><br><span class="line">            <span class="keyword">case</span> Rel(dst, val, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: rel <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;val&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Copy(dst, symbol, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: copy <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> R64(dst, symbol, addend, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: r64 <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span> + <span class="subst">&#123;addend&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> R32(dst, symbol, addend, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: r64 <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;symbol&#125;</span> + <span class="subst">&#123;addend&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">instructions = parse(b)</span><br><span class="line">dump(instructions)</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[0354] :: copy 8405268, 2</span><br><span class="line">[0355] :: rel 8405148, 8405268</span><br><span class="line">[0356] :: rel 8405156, 8</span><br><span class="line">[0357] :: copy 8414226, 2</span><br><span class="line">[0358] :: r64 8405196, 4 + 0</span><br><span class="line">[0359] :: rel 8414226, 0</span><br><span class="line">[0360] :: r64 8405197, 1 + 0</span><br><span class="line">[0361] :: rel 8405148, 8405690</span><br><span class="line">[0362] :: copy 8405244, 2</span><br><span class="line">[0363] :: rel 8405148, 8405196</span><br><span class="line">[0364] :: copy 8414394, 2</span><br><span class="line">[0365] :: r64 8405220, 4 + 0</span><br><span class="line">[0366] :: rel 8414394, 0</span><br><span class="line">[0367] :: rel 8405148, 8405220</span><br><span class="line">[0368] :: copy 8414490, 2</span><br><span class="line">[0369] :: r64 8405220, 5 + 0</span><br><span class="line">[0370] :: rel 8414490, 0</span><br><span class="line">[0371] :: copy 8414562, 2</span><br><span class="line">[0372] :: r64 8405220, 5 + 0</span><br><span class="line">[0373] :: rel 8414562, 0</span><br><span class="line">[0374] :: r64 8405220, 5 + 8405690</span><br><span class="line">[0375] :: copy 8405690, 5</span><br><span class="line">[0376] :: copy 8414666, 2</span><br><span class="line">[0377] :: r64 0, 6 + 0</span><br><span class="line">[0378] :: rel 8405148, 8405698</span><br><span class="line">...</span><br><span class="line">[101463] :: copy 10840770, 2</span><br><span class="line">[101464] :: r64 8405244, 6 + 0</span><br><span class="line">[101465] :: rel 10840770, 0</span><br><span class="line">[101466] :: rel 8405148, 8405244</span><br><span class="line">[101467] :: copy 10840866, 2</span><br><span class="line">[101468] :: r64 8405244, 6 + 0</span><br><span class="line">[101469] :: rel 10840866, 0</span><br><span class="line">[101470] :: rel 8405148, 8405220</span><br><span class="line">[101471] :: copy 10840962, 2</span><br><span class="line">[101472] :: r64 8405244, 6 + 0</span><br><span class="line">[101473] :: rel 10840962, 0</span><br><span class="line">[101474] :: rel 8405148, 8405244</span><br><span class="line">[101475] :: copy 10841058, 2</span><br><span class="line">[101476] :: r64 8405244, 6 + 0</span><br><span class="line">[101477] :: rel 10841058, 0</span><br><span class="line">[101478] :: copy 10841130, 2</span><br><span class="line">[101479] :: r64 8405244, 6 + 0</span><br><span class="line">[101480] :: rel 10841130, 0</span><br><span class="line">[101481] :: rel 8405148, 8405220</span><br></pre></td></tr></table></figure>

<p>10w多行重定位信息对于人类来说还是太抽象了 <del>（这句话是我写的</del><br>这时我注意到了一些奇怪的重定位信息：<code>[0377] :: r64 0, 6 + 0</code><br>这是往一个空指针里写东西，但是程序没🐔，所以可能是一些重定位信息在执行时会被修改。</p>
<p>我们可以检查数字落在哪个范围内，如果它位于<code>.rela.dyn</code>或<code>.dynsym</code>部分内，则为其分配一个符号值，而不是使用原始数字。我们也知道flag（<code>serial</code>符号）在<code>[0x404040:0x40405d]</code>，<code>fail</code>在<code>0x404060</code>。</p>
<p>定义我们的符号值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Symbol</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;s<span class="subst">&#123;self.idx&#125;</span>&#x27;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Reloc</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;r<span class="subst">&#123;self.idx&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ref</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    val: <span class="type">Any</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&amp;<span class="subst">&#123;self.val&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SymAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    sym: Symbol</span><br><span class="line">    field: <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;self.sym&#125;</span>.<span class="subst">&#123;self.field&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RelocAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    reloc: Reloc</span><br><span class="line">    field: <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;self.reloc&#125;</span>.<span class="subst">&#123;self.field&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">vaddr</span>(<span class="params">self</span>):</span><br><span class="line">        off = <span class="number">0</span></span><br><span class="line">        <span class="keyword">match</span> self.field:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_address&#x27;</span>:off = <span class="number">0</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_info&#x27;</span>: off = <span class="number">8</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r_addend&#x27;</span>: off = <span class="number">16</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (self.reloc.idx * <span class="number">24</span>) + off + rela.virtual_address</span><br><span class="line">    </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlagAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;flag[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line"></span><br><span class="line">BaseAddr = namedtuple(<span class="string">&#x27;baseaddr&#x27;</span>, [])</span><br><span class="line">FailAddr = namedtuple(<span class="string">&#x27;fail&#x27;</span>, [])</span><br></pre></td></tr></table></figure>

<p>然后再写一个函数<code>format_addr</code>把虚拟地址转为符号值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rela = [x <span class="keyword">for</span> x <span class="keyword">in</span> b.sections <span class="keyword">if</span> x.name == <span class="string">&#x27;.rela.dyn&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">dynsym = [x <span class="keyword">for</span> x <span class="keyword">in</span> b.sections <span class="keyword">if</span> x.name == <span class="string">&#x27;.dynsym&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_addr</span>(<span class="params">addr: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= rela.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; rela.virtual_address + rela.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - rela.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_address&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_info&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), <span class="string">&#x27;r_addend&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> _: <span class="keyword">return</span> RelocAddr(Reloc(r_offset), r_rem)</span><br><span class="line">    <span class="keyword">elif</span> (addr &gt; dynsym.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; dynsym.virtual_address + dynsym.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - dynsym.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> SymAddr(Symbol(r_offset), <span class="string">&#x27;st_name&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> Symbol(r_offset)</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>: <span class="keyword">return</span> SymAddr(Symbol(r_offset), <span class="string">&#x27;st_size&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> _: <span class="keyword">return</span> SymAddr(Symbol(r_offset), r_rem)</span><br><span class="line">    <span class="keyword">elif</span> addr &gt;= <span class="number">0x404040</span> <span class="keyword">and</span> addr &lt; <span class="number">0x404040</span>+<span class="number">29</span>:</span><br><span class="line">        off = addr-<span class="number">0x404040</span></span><br><span class="line">        <span class="keyword">return</span> FlagAddr(off)</span><br><span class="line">    <span class="keyword">elif</span> addr == <span class="number">0x804000</span>:</span><br><span class="line">        <span class="keyword">return</span> BaseAddr()</span><br><span class="line">    <span class="keyword">elif</span> addr == <span class="number">0x404060</span>:</span><br><span class="line">        <span class="keyword">return</span> FailAddr()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure>

<p>解析时，对每一个数值先调用函数<code>format_addr</code>（此处未展示）。可以得到以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interesting section of NOPs:</span></span><br><span class="line">[<span class="number">0083</span>] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0084] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0085] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0086] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0087] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0088] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line">[0089] :: rel <span class="title function_">baseaddr</span><span class="params">()</span>, 0</span><br><span class="line"></span><br><span class="line"><span class="comment">// Writing some consecutive values into previously</span></span><br><span class="line"><span class="comment">// applied relocations:</span></span><br><span class="line">[0090] :: rel r3.r_address, 0</span><br><span class="line">[0091] :: rel r3.r_info, 1</span><br><span class="line">[0092] :: rel r3.r_addend, 2</span><br><span class="line">[0093] :: rel r4.r_address, 3</span><br><span class="line">[0094] :: rel r4.r_info, 4</span><br><span class="line">[0095] :: rel r4.r_addend, 5</span><br><span class="line">[0096] :: rel r5.r_address, 6</span><br><span class="line">[0097] :: rel r5.r_info, 7</span><br><span class="line">[0098] :: rel r5.r_addend, 8</span><br><span class="line">[0099] :: rel r6.r_address, 9</span><br><span class="line">[0100] :: rel r6.r_info, 10</span><br><span class="line">[0101] :: rel r6.r_addend, 11</span><br><span class="line"></span><br><span class="line"><span class="comment">// Much more readable code!</span></span><br><span class="line">[0343] :: rel r87.r_info, 253</span><br><span class="line">[0344] :: rel r87.r_addend, 254</span><br><span class="line">[0345] :: rel r88.r_address, 255</span><br><span class="line">[0346] :: rel s4, 0</span><br><span class="line">[0347] :: rel s2, r3.r_address</span><br><span class="line">[0348] :: rel s2.st_size, 8</span><br><span class="line">[0349] :: copy r350.r_addend, s2</span><br><span class="line">[0350] :: r64 s4, s4 + 0</span><br><span class="line">[0351] :: rel r350.r_addend, 0</span><br><span class="line">[0352] :: rel s2, flag[0]</span><br><span class="line">[0353] :: rel s2.st_size, 1</span><br></pre></td></tr></table></figure>

<p>我们还能看到类似的东西：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0349</span>] :: copy r350.r_addend, s2</span><br><span class="line">[<span class="number">0350</span>] :: r64 s4, s4 + <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>349覆写了350中的加数。实际上，这两句话应该是<code>s4 += s2</code>（0被覆写为s2）</p>
<p>下面也有相似的覆写地址的操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0376</span>] :: copy r377.r_address, s2</span><br><span class="line">[<span class="number">0377</span>] :: r64 <span class="number">0</span>, s6 + <span class="number">0</span></span><br><span class="line"><span class="comment">//s2 = s6</span></span><br></pre></td></tr></table></figure>

<p>如果我们对这些结构进行模式匹配并定义更高级别的操作，我们可能会得到一些更简洁的代码</p>
<h2 id="Part2"><a href="#Part2" class="headerlink" title="Part2"></a>Part2</h2><p><del>不要问我为什么不翻译标题，因为这句话我也没看懂！😭（如果有知道是什么意思的师傅请务必告诉我</del></p>
<h3 id="Arr-Out-references"><a href="#Arr-Out-references" class="headerlink" title="Arr + Out references"></a>Arr + Out references</h3><p>在解析过程中，我注意到一些重定位信息被作为NOP使用（向固定地址写入0）。其他重定位信息也会向那些重定位点（如一个<code>uint64_t</code>数组）写入任意的值。</p>
<p>特别指出，r3到r88似乎被用作一个数组。r89似乎是某种输出值（之后会说）。</p>
<p>我们可以修改<code>format_addr</code>来理解这些引用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;out[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArrAddr</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    idx: <span class="built_in">int</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;arr[<span class="subst">&#123;self.idx&#125;</span>]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_addr</span>(<span class="params">addr: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= rela.virtual_address </span><br><span class="line">        <span class="keyword">and</span> addr &lt; rela.virtual_address + rela.size</span><br><span class="line">    ):</span><br><span class="line">        offset = addr - rela.virtual_address</span><br><span class="line">        r_offset = (offset // <span class="number">24</span>)</span><br><span class="line">        r_rem = offset % <span class="number">24</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># --- NEW ---</span></span><br><span class="line">        <span class="keyword">if</span> r_offset &gt;= <span class="number">3</span> <span class="keyword">and</span> r_offset &lt;= <span class="number">88</span>:</span><br><span class="line">            arr_idx = (r_offset - <span class="number">3</span>) * <span class="number">3</span> + (r_rem // <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">return</span> ArrAddr(arr_idx)</span><br><span class="line">        <span class="keyword">elif</span> r_offset == <span class="number">89</span>:</span><br><span class="line">            <span class="keyword">return</span> OutAddr(r_rem)</span><br><span class="line">        <span class="comment"># --- END ---</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">match</span> r_rem:</span><br><span class="line">            <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>样例1（102000条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// Nice array references!</span><br><span class="line">[0338] :: rel arr[248], 248</span><br><span class="line">[0339] :: rel arr[249], 249</span><br><span class="line">[0340] :: rel arr[250], 250</span><br><span class="line">[0341] :: rel arr[251], 251</span><br><span class="line">[0342] :: rel arr[252], 252</span><br><span class="line">[0343] :: rel arr[253], 253</span><br><span class="line">[0344] :: rel arr[254], 254</span><br><span class="line">[0345] :: rel arr[255], 255</span><br><span class="line">[0346] :: rel s4, 0</span><br><span class="line">[0347] :: rel s2, arr[0]            // neat</span><br><span class="line">[0348] :: rel s2.st_size, 8</span><br><span class="line">[0349] :: copy r350.r_addend, s2</span><br><span class="line">[0350] :: r64 s4, s4 + 0</span><br><span class="line">[0351] :: rel r350.r_addend, 0</span><br><span class="line">[0352] :: rel s2, flag[0]           // flag!</span><br><span class="line">[0353] :: rel s2.st_size, 1</span><br><span class="line">[0354] :: copy s7, s2</span><br><span class="line">[0355] :: rel s2, s7</span><br><span class="line">[0356] :: rel s2.st_size, 8</span><br><span class="line">[0357] :: copy r358.r_addend, s2</span><br><span class="line">[0358] :: r64 s4, s4 + 0</span><br><span class="line">[0359] :: rel r358.r_addend, 0</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: rel s2, arr[0]</span><br><span class="line">[0362] :: copy s6, s2</span><br></pre></td></tr></table></figure>

<p>好看多了！</p>
<h3 id="Mov-Add"><a href="#Mov-Add" class="headerlink" title="Mov + Add"></a>Mov + Add</h3><p>下一步我们可以把<code>Rel</code>，<code>R64</code>和<code>Copy</code>使用更容易理解的<code>Mov</code>和<code>Add</code>替换</p>
<p>为了知道mov的大小（根据<code>Copy</code>变化），我们需要追踪所有指令，然后跟踪每个偏移处的符号大小。我们可以只看向符号<code>st_size</code>写的部分来观察这些变化。幸运的是，它们在这个程序里是确定的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Mov = namedtuple(<span class="string">&#x27;mov&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;sz&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">Add = namedtuple(<span class="string">&#x27;add&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;addend&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_mov_add</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    sizes = []</span><br><span class="line">    curr = [<span class="number">8</span>] * <span class="number">8</span></span><br><span class="line">    sizes.append(curr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Trace instructions and monitor the size of every symbol.</span></span><br><span class="line">    <span class="keyword">for</span> instr <span class="keyword">in</span> instructions:</span><br><span class="line">        c = <span class="built_in">list</span>(curr)</span><br><span class="line">        <span class="keyword">match</span> instr:</span><br><span class="line">            <span class="keyword">case</span> Rel(SymAddr(Symbol(idx), <span class="string">&#x27;st_size&#x27;</span>), val, ridx):</span><br><span class="line">                c[idx] = val</span><br><span class="line">        sizes.append(c)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Iterate and find Mov/Add patterns.</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Rel(dst, val, ridx):</span><br><span class="line">                instructions[idx] = Mov(dst, Ref(val), <span class="number">8</span>, ridx)</span><br><span class="line">            <span class="keyword">case</span> Copy(dst, sym, ridx):</span><br><span class="line">                instructions[idx] = Mov(</span><br><span class="line">                    dst, sym, sizes[idx][sym.idx], ridx)</span><br><span class="line">            <span class="keyword">case</span> R64(dst, sym, add, ridx):</span><br><span class="line">                instructions[idx] = Add(dst, sym, add, ridx)</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_sizes</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="comment"># Sizes are now nops.</span></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(SymAddr(Symbol(s), <span class="string">&#x27;st_size&#x27;</span>), _, _, _):</span><br><span class="line">                instructions[idx:idx+<span class="number">1</span>] = []</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>我们还需要更新我们的dump函数以支持这些新类型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="keyword">for</span> op <span class="keyword">in</span> instructions:</span><br><span class="line">        <span class="keyword">match</span> op:</span><br><span class="line">            <span class="comment"># --- snip ---</span></span><br><span class="line">            <span class="keyword">case</span> Mov(dst, src, <span class="number">8</span>, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: mov <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Mov(dst, src, sz, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: mov(<span class="subst">&#123;sz&#125;</span>) <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">case</span> Add(dst, src, add, ridx):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: add <span class="subst">&#123;dst&#125;</span>, <span class="subst">&#123;src&#125;</span>, <span class="subst">&#123;add&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>示例2（96179条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// smoooth</span><br><span class="line">[0336] :: mov arr[246], &amp;246</span><br><span class="line">[0337] :: mov arr[247], &amp;247</span><br><span class="line">[0338] :: mov arr[248], &amp;248</span><br><span class="line">[0339] :: mov arr[249], &amp;249</span><br><span class="line">[0340] :: mov arr[250], &amp;250</span><br><span class="line">[0341] :: mov arr[251], &amp;251</span><br><span class="line">[0342] :: mov arr[252], &amp;252</span><br><span class="line">[0343] :: mov arr[253], &amp;253</span><br><span class="line">[0344] :: mov arr[254], &amp;254</span><br><span class="line">[0345] :: mov arr[255], &amp;255</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: mov s2, &amp;arr[0]</span><br><span class="line">[0349] :: mov r350.r_addend, s2</span><br><span class="line">[0350] :: add s4, s4, 0</span><br><span class="line">[0351] :: mov r350.r_addend, &amp;0</span><br><span class="line">[0352] :: mov s2, &amp;flag[0]</span><br><span class="line">[0354] :: mov(1) s7, s2</span><br><span class="line">[0355] :: mov s2, &amp;s7</span><br><span class="line">[0357] :: mov r358.r_addend, s2</span><br><span class="line">[0358] :: add s4, s4, 0</span><br><span class="line">[0359] :: mov r358.r_addend, &amp;0</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: mov s2, &amp;arr[0]</span><br><span class="line">[0362] :: mov s6, s2</span><br><span class="line">[0363] :: mov s2, &amp;s4</span><br></pre></td></tr></table></figure>

<h3 id="间接mov"><a href="#间接mov" class="headerlink" title="间接mov"></a>间接mov</h3><p>前面提到过，某些重定位里的<code>r_addend</code>会在用到之前被修改。举个🌰：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[0349] :: mov r350.r_addend, s2</span><br><span class="line">[0350] :: add s4, s4, 0</span><br><span class="line">[0351] :: mov r350.r_addend, &amp;0</span><br></pre></td></tr></table></figure>

<p>这3句指令其实就是<code>s4 = s2</code>。我感觉产生第3条指令是程序编译方式的问题，这玩意其实应该没什么用。</p>
<p>用python3.10来match，我们可以对这种类型的结构执行清晰的模式匹配，并用一条Add指令替换它：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lift_indirect</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">3</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(RelocAddr(Reloc(r1), <span class="string">&#x27;r_addend&#x27;</span>), sym, _, ridx_1),</span><br><span class="line">                Add(dst_2, sym_2, _, ridx_2),</span><br><span class="line">                Mov(RelocAddr(Reloc(r3), <span class="string">&#x27;r_addend&#x27;</span>), Ref(<span class="number">0</span>), _, _),</span><br><span class="line">            ] <span class="keyword">if</span> (</span><br><span class="line">                (r1 == ridx_2) <span class="keyword">and</span> (r3 == ridx_2)</span><br><span class="line">            ):</span><br><span class="line">                instructions[idx:idx+<span class="number">3</span>] = [</span><br><span class="line">                    Add(dst_2, sym_2, sym, ridx_1)</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例3 （58155条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: mov s2, &amp;arr[0]</span><br><span class="line">[0349] :: add s4, s4, s2     // wow</span><br><span class="line">[0352] :: mov s2, &amp;flag[0]</span><br><span class="line">[0354] :: mov(1) s7, s2</span><br><span class="line">[0355] :: mov s2, &amp;s7</span><br><span class="line">[0357] :: add s4, s4, s2     // cool</span><br><span class="line">[0360] :: r64 s4.9, s1 + 0</span><br><span class="line">[0361] :: mov s2, &amp;arr[0]</span><br><span class="line">[0362] :: mov s6, s2</span><br><span class="line">[0363] :: mov s2, &amp;s4</span><br><span class="line">[0364] :: add s5, s4, s2     // amazing</span><br><span class="line">[0367] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>


<h3 id="分块"><a href="#分块" class="headerlink" title="分块"></a>分块</h3><p>检查汇编代码，我们可以发现重复的代码块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// ---------------</span><br><span class="line">[0378] :: mov s2, &amp;arr[1]</span><br><span class="line">[0379] :: add s4, s4, s2</span><br><span class="line">[0382] :: mov s2, &amp;flag[1]</span><br><span class="line">[0384] :: mov(1) s7, s2</span><br><span class="line">[0385] :: mov s2, &amp;s7</span><br><span class="line">[0387] :: add s4, s4, s2</span><br><span class="line">[0390] :: r64 s4.9, s1 + 0</span><br><span class="line">[0391] :: mov s2, &amp;arr[1]</span><br><span class="line">[0392] :: mov s6, s2</span><br><span class="line">[0393] :: mov s2, &amp;s4</span><br><span class="line">[0394] :: add s5, s4, s2</span><br><span class="line">[0397] :: mov s2, &amp;s5</span><br><span class="line">[0398] :: add s5, s5, s2</span><br><span class="line">[0401] :: add s5, s5, s2</span><br><span class="line">[0404] :: add s5, s5, arr[0]</span><br><span class="line">[0405] :: mov arr[1], s5</span><br><span class="line">[0406] :: mov r407.r_address, s2</span><br><span class="line">[0407] :: add 0, s6, 0</span><br><span class="line">// ---------------</span><br><span class="line">[0408] :: mov s2, &amp;arr[2]</span><br><span class="line">[0409] :: add s4, s4, s2</span><br><span class="line">[0412] :: mov s2, &amp;flag[0]</span><br><span class="line">[0414] :: mov(1) s7, s2</span><br><span class="line">[0415] :: mov s2, &amp;s7</span><br><span class="line">[0417] :: add s4, s4, s2</span><br><span class="line">[0420] :: r64 s4.9, s1 + 0</span><br><span class="line">[0421] :: mov s2, &amp;arr[2]</span><br><span class="line">[0422] :: mov s6, s2</span><br><span class="line">[0423] :: mov s2, &amp;s4</span><br><span class="line">[0424] :: add s5, s4, s2</span><br><span class="line">[0427] :: mov s2, &amp;s5</span><br><span class="line">[0428] :: add s5, s5, s2</span><br><span class="line">[0431] :: add s5, s5, s2</span><br><span class="line">[0434] :: add s5, s5, arr[0]</span><br><span class="line">[0435] :: mov arr[2], s5</span><br><span class="line">[0436] :: mov r437.r_address, s2</span><br><span class="line">[0437] :: add 0, s6, 0</span><br><span class="line">// ---------------</span><br></pre></td></tr></table></figure>

<p>这些块干的事情就是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ---</span><br><span class="line">s6 = (s6 + arr[1] + flag[1]) &amp; 0xff</span><br><span class="line">arr[1], arr[s6] = arr[s6], arr[1]</span><br><span class="line"># ---</span><br><span class="line">s6 = (s6 + arr[2] + flag[0]) &amp; 0xff</span><br><span class="line">arr[2], arr[s6] = arr[s6], arr[2]</span><br><span class="line"># ---</span><br></pre></td></tr></table></figure>

<p>似乎只有arr和flag的索引改变了。改一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Block = namedtuple(&#x27;block&#x27;, [&#x27;arr&#x27;, &#x27;flag&#x27;, &#x27;ridx&#x27;])</span><br><span class="line"></span><br><span class="line">def lift_block(instructions):</span><br><span class="line">    idx = 0</span><br><span class="line">    while idx &lt; len(instructions):</span><br><span class="line">        match instructions[idx:idx+18]:</span><br><span class="line">            case [</span><br><span class="line">                Mov(_,arr,_,ridx),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,flag,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+18] = [</span><br><span class="line">                    Block(arr, flag, ridx)</span><br><span class="line">                ]</span><br><span class="line">        idx += 1</span><br><span class="line">    return instructions</span><br></pre></td></tr></table></figure>

<p>样例4（23339条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// array set</span><br><span class="line">[0342] :: mov arr[252], &amp;252</span><br><span class="line">[0343] :: mov arr[253], &amp;253</span><br><span class="line">[0344] :: mov arr[254], &amp;254</span><br><span class="line">[0345] :: mov arr[255], &amp;255</span><br><span class="line"></span><br><span class="line">// s4 = 0</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line"></span><br><span class="line">// repeating shuffles...</span><br><span class="line">[0347] :: shuffle &amp;arr[0], &amp;flag[0]</span><br><span class="line">[0378] :: shuffle &amp;arr[1], &amp;flag[1]</span><br><span class="line">[0408] :: shuffle &amp;arr[2], &amp;flag[0]</span><br><span class="line">[0438] :: shuffle &amp;arr[3], &amp;flag[1]</span><br><span class="line">[0468] :: shuffle &amp;arr[4], &amp;flag[0]</span><br><span class="line">[0498] :: shuffle &amp;arr[5], &amp;flag[1]</span><br><span class="line">[0528] :: shuffle &amp;arr[6], &amp;flag[0]</span><br><span class="line"></span><br><span class="line">// later</span><br><span class="line">[24275] :: add s5, s5, s2</span><br><span class="line">[24278] :: add s5, s5, s2</span><br><span class="line">[24281] :: add s5, s5, arr[0]</span><br><span class="line">[24282] :: mov out[8], s5</span><br><span class="line"></span><br><span class="line">// array is reset again...</span><br><span class="line">[24283] :: mov arr[0], &amp;0</span><br><span class="line">[24284] :: mov arr[1], &amp;1</span><br><span class="line">[24285] :: mov arr[2], &amp;2</span><br><span class="line">[24286] :: mov arr[3], &amp;3</span><br><span class="line">[24287] :: mov arr[4], &amp;4</span><br><span class="line">[24288] :: mov arr[5], &amp;5</span><br><span class="line">[24289] :: mov arr[6], &amp;6</span><br><span class="line">[24290] :: mov arr[7], &amp;7</span><br><span class="line">[24291] :: mov arr[8], &amp;8</span><br><span class="line">[24292] :: mov arr[9], &amp;9</span><br><span class="line">[24293] :: mov arr[10], &amp;10</span><br><span class="line">[24294] :: mov arr[11], &amp;11</span><br></pre></td></tr></table></figure>

<h3 id="重置-Reset-和块移动-ShuffleBlock"><a href="#重置-Reset-和块移动-ShuffleBlock" class="headerlink" title="重置(Reset)和块移动(ShuffleBlock)"></a>重置(Reset)和块移动(ShuffleBlock)</h3><p>（这里的重置就是清零的意思，块移动看看样例就懂了（雾）</p>
<p>很多指令是用于数组初始化的，我们可以把它们淦掉（雾<br>还可以淦掉很多用于移动的指令（lift和shuffle不知道怎么翻译了，不过看了样例就知道什么意思了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Reset = namedtuple(<span class="string">&#x27;reset&#x27;</span>, [<span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line">ShuffleBlock = namedtuple(<span class="string">&#x27;shuffleblock&#x27;</span>, [<span class="string">&#x27;f1&#x27;</span>, <span class="string">&#x27;f2&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_reset</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions) - <span class="number">256</span>:</span><br><span class="line">        good = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            op = instructions[idx+i]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(op) == Mov:</span><br><span class="line">                dst, src, _, _ = op</span><br><span class="line">                <span class="keyword">if</span> dst != ArrAddr(i) <span class="keyword">or</span> src != Ref(i):</span><br><span class="line">                    good = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                good = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> good:</span><br><span class="line">            instructions[idx:idx+<span class="number">256</span>] = [</span><br><span class="line">                Reset(instructions[idx].ridx)</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_shuffle_block</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions) - <span class="number">256</span>:</span><br><span class="line">        good = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            op = instructions[idx+i]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(op) == Block:</span><br><span class="line">                arr, flag, ridx = op</span><br><span class="line">                <span class="keyword">if</span> arr != Ref(ArrAddr(i)):</span><br><span class="line">                    good = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                good = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> good:</span><br><span class="line">            instructions[idx:idx+<span class="number">256</span>] = [</span><br><span class="line">                ShuffleBlock(</span><br><span class="line">                    instructions[idx].flag,</span><br><span class="line">                    instructions[idx+<span class="number">1</span>].flag,</span><br><span class="line">                    instructions[idx].ridx)]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例5（19259条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[0090] :: reset                             // wow</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]   // so smol</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: mov s2, &amp;arr[0]</span><br><span class="line">[8030] :: add s4, s4, s2</span><br><span class="line">[8033] :: r32 s4.9, s1, 0</span><br><span class="line">// ...</span><br><span class="line">[8154] :: mov out[2], s5</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]   // another!</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: mov s2, &amp;arr[0]</span><br><span class="line">[16094] :: add s4, s4, s2</span><br><span class="line">[16097] :: r32 s4.9, s1, 0</span><br></pre></td></tr></table></figure>

<h3 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h3><p>在每个<code>reset</code>&#x2F;<code>shuffleblock</code>对之间，似乎有三个重复的指令块写入该<code>out</code>区域：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// ---------------</span><br><span class="line">[8029] :: mov s2, &amp;arr[0]</span><br><span class="line">[8030] :: add s4, s4, s2</span><br><span class="line">[8033] :: r32 s4.9, s1, 0</span><br><span class="line">[8034] :: mov s6, s2</span><br><span class="line">[8035] :: mov s2, &amp;s4</span><br><span class="line">[8036] :: add s5, s4, s2</span><br><span class="line">[8039] :: mov s2, &amp;s5</span><br><span class="line">[8040] :: add s5, s5, s2</span><br><span class="line">[8043] :: add s5, s5, s2</span><br><span class="line">[8046] :: add s5, s5, arr[0]</span><br><span class="line">[8047] :: mov arr[0], s5</span><br><span class="line">[8048] :: mov s2, &amp;arr[0]</span><br><span class="line">[8049] :: mov s7, s2</span><br><span class="line">[8050] :: mov s2, &amp;s5</span><br><span class="line">[8051] :: mov r8052.r_address, s2</span><br><span class="line">[8052] :: add 0, s6, 0</span><br><span class="line">[8053] :: mov s2, &amp;s7</span><br><span class="line">[8054] :: add s6, s6, s2</span><br><span class="line">[8057] :: r32 s6.9, s1, 0</span><br><span class="line">[8058] :: mov s2, &amp;s6</span><br><span class="line">[8059] :: add s5, s6, s2</span><br><span class="line">[8062] :: mov s2, &amp;s5</span><br><span class="line">[8063] :: add s5, s5, s2</span><br><span class="line">[8066] :: add s5, s5, s2</span><br><span class="line">[8069] :: add s5, s5, arr[0]</span><br><span class="line">[8070] :: mov out[0], s5</span><br><span class="line">// ---------------</span><br><span class="line">[8071] :: mov s2, &amp;arr[1]</span><br><span class="line">[8072] :: add s4, s4, s2</span><br><span class="line">[8075] :: r32 s4.9, s1, 0</span><br><span class="line">[8076] :: mov s6, s2</span><br><span class="line">[8077] :: mov s2, &amp;s4</span><br><span class="line">[8078] :: add s5, s4, s2</span><br><span class="line">[8081] :: mov s2, &amp;s5</span><br><span class="line">[8082] :: add s5, s5, s2</span><br><span class="line">[8085] :: add s5, s5, s2</span><br><span class="line">[8088] :: add s5, s5, arr[0]</span><br><span class="line">[8089] :: mov arr[1], s5</span><br><span class="line">[8090] :: mov s2, &amp;arr[1]</span><br><span class="line">[8091] :: mov s7, s2</span><br><span class="line">[8092] :: mov s2, &amp;s5</span><br><span class="line">[8093] :: mov r8094.r_address, s2</span><br><span class="line">[8094] :: add 0, s6, 0</span><br><span class="line">[8095] :: mov s2, &amp;s7</span><br><span class="line">[8096] :: add s6, s6, s2</span><br><span class="line">[8099] :: r32 s6.9, s1, 0</span><br><span class="line">[8100] :: mov s2, &amp;s6</span><br><span class="line">[8101] :: add s5, s6, s2</span><br><span class="line">[8104] :: mov s2, &amp;s5</span><br><span class="line">[8105] :: add s5, s5, s2</span><br><span class="line">[8108] :: add s5, s5, s2</span><br><span class="line">[8111] :: add s5, s5, arr[0]</span><br><span class="line">[8112] :: mov out[1], s5</span><br><span class="line">// ---------------</span><br></pre></td></tr></table></figure>

<p>它们干的事情就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---</span></span><br><span class="line">s4 = (s4 + arr[<span class="number">0</span>]) &amp; <span class="number">0xff</span></span><br><span class="line">arr[<span class="number">0</span>], arr[s4] = arr[s4], arr[<span class="number">0</span>]</span><br><span class="line">out[<span class="number">0</span>] = arr[(arr[<span class="number">0</span>] + arr[s4]) &amp; <span class="number">0xff</span>]</span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line">s4 = (s4 + arr[<span class="number">1</span>]) &amp; <span class="number">0xff</span></span><br><span class="line">arr[<span class="number">1</span>], arr[s4] = arr[s4], arr[<span class="number">1</span>]</span><br><span class="line">out[<span class="number">1</span>] = arr[(arr[<span class="number">1</span>] + arr[s4]) &amp; <span class="number">0xff</span>]</span><br><span class="line"><span class="comment"># ---</span></span><br></pre></td></tr></table></figure>

<p>我们把它淦掉：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Output = namedtuple(<span class="string">&#x27;output&#x27;</span>, [<span class="string">&#x27;out&#x27;</span>, <span class="string">&#x27;arr&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_output</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">26</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(_,arr,_,ridx),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                R32(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Add(_,_,_,_),</span><br><span class="line">                Mov(out,_,_,_),</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+<span class="number">26</span>] = [Output(out, arr, ridx)]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例6（18659条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// hey this is looking almost readable</span><br><span class="line">[0090] :: reset</span><br><span class="line">[0346] :: mov s4, &amp;0</span><br><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: output out[0], &amp;arr[0]        // neat</span><br><span class="line">[8071] :: output out[1], &amp;arr[1]</span><br><span class="line">[8113] :: output out[2], &amp;arr[2]</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: output out[3], &amp;arr[0]</span><br><span class="line">[16135] :: output out[4], &amp;arr[1]</span><br><span class="line">[16177] :: output out[5], &amp;arr[2]</span><br><span class="line">[16219] :: reset</span><br><span class="line">[16475] :: mov s4, &amp;0</span><br><span class="line">[16476] :: shuffleblock &amp;flag[4], &amp;flag[5]</span><br><span class="line">[24156] :: mov s4, &amp;0</span><br><span class="line">[24157] :: output out[6], &amp;arr[0]</span><br><span class="line">[24199] :: output out[7], &amp;arr[1]</span><br><span class="line">[24241] :: output out[8], &amp;arr[2]</span><br><span class="line">[24283] :: reset</span><br><span class="line">[24539] :: mov s4, &amp;0</span><br><span class="line">[24540] :: shuffleblock &amp;flag[6], &amp;flag[7]</span><br><span class="line">[32220] :: mov s4, &amp;0</span><br><span class="line">[32221] :: output out[9], &amp;arr[0]</span><br><span class="line">[32263] :: output out[10], &amp;arr[1]</span><br><span class="line">[32305] :: output out[11], &amp;arr[2]</span><br><span class="line">[32347] :: reset</span><br><span class="line">[32603] :: mov s4, &amp;0</span><br></pre></td></tr></table></figure>

<h3 id="MultAdd"><a href="#MultAdd" class="headerlink" title="MultAdd"></a>MultAdd</h3><p>（就是多次加法）</p>
<p>check到<code>flag[16]</code>之后，上面那种代码没了，换了新的加密方式。<br>遇到一些新的块，它们似乎不太一样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">/ ----------</span><br><span class="line">[64730] :: mov s2, &amp;out[2]</span><br><span class="line">[64732] :: mov(1) s5, s2</span><br><span class="line">[64733] :: mov s6, &amp;0</span><br><span class="line">[64734] :: mov s2, &amp;s6</span><br><span class="line">[64736] :: add s6, s6, s2</span><br><span class="line">[64739] :: mov s2, &amp;s5</span><br><span class="line">[64740] :: add s6, s6, s2</span><br><span class="line">[64743] :: mov s2, &amp;s6</span><br><span class="line">[64744] :: add s6, s6, s2</span><br><span class="line">[64747] :: mov s2, &amp;s5</span><br><span class="line">[64748] :: add s6, s6, s2</span><br><span class="line">[64751] :: mov s2, &amp;s6</span><br><span class="line">[64752] :: add s6, s6, s2</span><br><span class="line">[64755] :: add s6, s6, s2</span><br><span class="line">[64758] :: mov s2, &amp;s5</span><br><span class="line">[64759] :: add s6, s6, s2</span><br><span class="line">[64762] :: mov s2, &amp;s6</span><br><span class="line">[64763] :: add s6, s6, s2</span><br><span class="line">[64766] :: add s6, s6, s2</span><br><span class="line">[64769] :: add s6, s6, s2</span><br><span class="line">[64772] :: add s6, s6, s2</span><br><span class="line">[64775] :: add s7, s7, s2</span><br><span class="line">// ----------</span><br><span class="line">[64778] :: mov s2, &amp;out[3]</span><br><span class="line">[64780] :: mov(1) s5, s2</span><br><span class="line">[64781] :: mov s6, &amp;0</span><br><span class="line">[64782] :: mov s2, &amp;s6</span><br><span class="line">[64784] :: add s6, s6, s2</span><br><span class="line">[64787] :: mov s2, &amp;s5</span><br><span class="line">[64788] :: add s6, s6, s2</span><br><span class="line">[64791] :: mov s2, &amp;s6</span><br><span class="line">[64792] :: add s6, s6, s2</span><br><span class="line">[64795] :: mov s2, &amp;s5</span><br><span class="line">[64796] :: add s6, s6, s2</span><br><span class="line">[64799] :: mov s2, &amp;s6</span><br><span class="line">[64800] :: add s6, s6, s2</span><br><span class="line">[64803] :: mov s2, &amp;s5</span><br><span class="line">[64804] :: add s6, s6, s2</span><br><span class="line">[64807] :: mov s2, &amp;s6</span><br><span class="line">[64808] :: add s6, s6, s2</span><br><span class="line">[64811] :: mov s2, &amp;s5</span><br><span class="line">[64812] :: add s6, s6, s2</span><br><span class="line">[64815] :: mov s2, &amp;s6</span><br><span class="line">[64816] :: add s6, s6, s2</span><br><span class="line">[64819] :: add s6, s6, s2</span><br><span class="line">[64822] :: mov s2, &amp;s5</span><br><span class="line">[64823] :: add s6, s6, s2</span><br><span class="line">[64826] :: mov s2, &amp;s6</span><br><span class="line">[64827] :: add s6, s6, s2</span><br><span class="line">[64830] :: mov s2, &amp;s5</span><br><span class="line">[64831] :: add s6, s6, s2</span><br><span class="line">[64834] :: mov s2, &amp;s6</span><br><span class="line">[64835] :: add s7, s7, s2</span><br><span class="line">/ ----------</span><br></pre></td></tr></table></figure>

<p>这些块干的事情就是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// s5 = out[3]</span><br><span class="line">[64778] :: mov s2, &amp;out[3]</span><br><span class="line">[64780] :: mov(1) s5, s2</span><br><span class="line">[64781] :: mov s6, &amp;0</span><br><span class="line"></span><br><span class="line">// compute some multiple of s5</span><br><span class="line"></span><br><span class="line">// add result to s7</span><br><span class="line">[64835] :: add s7, s7, s2</span><br></pre></td></tr></table></figure>

<p>内部的一些代码执行的就是<code>s6 += s5</code>（+）或<code>s6 += s6</code>（×2）</p>
<p>举个🌰：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[64730] :: mov s2, &amp;out[2]</span><br><span class="line">[64732] :: mov(1) s5, s2    // s5 = out[2]</span><br><span class="line">[64733] :: mov s6, &amp;0       // s6 = 0</span><br><span class="line"></span><br><span class="line">[64734] :: mov s2, &amp;s6</span><br><span class="line">[64736] :: add s6, s6, s2   // s6 = 0</span><br><span class="line">[64739] :: mov s2, &amp;s5</span><br><span class="line">[64740] :: add s6, s6, s2   // s6 = out[2]</span><br><span class="line">[64743] :: mov s2, &amp;s6</span><br><span class="line">[64744] :: add s6, s6, s2   // s6 = 2 * out[2]</span><br><span class="line">[64747] :: mov s2, &amp;s5</span><br><span class="line">[64748] :: add s6, s6, s2   // s6 = 3 * out[2]</span><br><span class="line">[64751] :: mov s2, &amp;s6</span><br><span class="line">[64752] :: add s6, s6, s2   // s6 = 6 * out[2]</span><br><span class="line">[64755] :: add s6, s6, s2   // s6 = 12 * out[2]</span><br><span class="line">[64758] :: mov s2, &amp;s5</span><br><span class="line">[64759] :: add s6, s6, s2   // s6 = 13 * out[2]</span><br><span class="line">[64762] :: mov s2, &amp;s6</span><br><span class="line">[64763] :: add s6, s6, s2   // s6 = 26 * out[2]</span><br><span class="line">[64766] :: add s6, s6, s2   // s6 = 52 * out[2]</span><br><span class="line">[64769] :: add s6, s6, s2   // s6 = 104 * out[2]</span><br><span class="line">[64772] :: add s6, s6, s2   // s6 = 208 * out[2]</span><br><span class="line"></span><br><span class="line">[64775] :: add s7, s7, s2   // s7 += (208 * out[2])</span><br></pre></td></tr></table></figure>

<p>虽然有点麻烦，但我们还是可以把它淦掉：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">MultAdd = namedtuple(<span class="string">&#x27;multadd&#x27;</span>, [<span class="string">&#x27;out&#x27;</span>, <span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_multadd</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">3</span>]:</span><br><span class="line">            <span class="comment"># block prefix</span></span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), out, _, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">5</span>), Symbol(<span class="number">2</span>), _, _),</span><br><span class="line">                Mov(Symbol(<span class="number">6</span>), Ref(<span class="number">0</span>), _, _),</span><br><span class="line">            ]:</span><br><span class="line">                k = <span class="number">0</span></span><br><span class="line">                double = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                ptr = idx + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">                good = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">6</span>)), _, _):</span><br><span class="line">                            double = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">case</span> Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">5</span>)), _, _):</span><br><span class="line">                            double = <span class="literal">False</span></span><br><span class="line">                        <span class="keyword">case</span> Add(Symbol(<span class="number">6</span>), Symbol(<span class="number">6</span>), Symbol(<span class="number">2</span>), _):</span><br><span class="line">                            k = (k * <span class="number">2</span>) <span class="keyword">if</span> double <span class="keyword">else</span> (k + <span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">case</span> Add(Symbol(<span class="number">7</span>), Symbol(<span class="number">7</span>), Symbol(<span class="number">2</span>), _):</span><br><span class="line">                            ptr += <span class="number">1</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            good = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> good:</span><br><span class="line">                    instructions[idx:ptr] = [</span><br><span class="line">                        MultAdd(Symbol(<span class="number">7</span>), out, k, ridx)</span><br><span class="line">                    ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例7（2377条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[56795] :: mov s4, &amp;0</span><br><span class="line">[56796] :: shuffleblock &amp;flag[14], &amp;flag[15]</span><br><span class="line">[64476] :: mov s4, &amp;0</span><br><span class="line">[64477] :: output out[21], &amp;arr[0]</span><br><span class="line">[64519] :: output out[22], &amp;arr[1]</span><br><span class="line">[64561] :: output out[23], &amp;arr[2]</span><br><span class="line">[64603] :: mov s2, &amp;r101917.r_address</span><br><span class="line">[64605] :: mov(2064) arr[0], s2</span><br><span class="line">[64606] :: mov s4, &amp;0</span><br><span class="line">[64607] :: mov s5, &amp;0</span><br><span class="line">[64608] :: mov s7, &amp;-393039</span><br><span class="line">[64609] :: madd s7 += (&amp;out[0] * 155)   // math!</span><br><span class="line">[64667] :: madd s7 += (&amp;out[1] * 190)</span><br><span class="line">[64730] :: madd s7 += (&amp;out[2] * 208)</span><br><span class="line">[64778] :: madd s7 += (&amp;out[3] * 123)</span><br><span class="line">[64838] :: madd s7 += (&amp;out[4] * 214)</span><br><span class="line">[64896] :: madd s7 += (&amp;out[5] * 146)</span><br><span class="line">[64944] :: madd s7 += (&amp;out[6] * 211)</span><br><span class="line">[65002] :: madd s7 += (&amp;out[7] * 85)</span><br><span class="line">[65052] :: madd s7 += (&amp;out[8] * 87)</span><br><span class="line">[65107] :: madd s7 += (&amp;out[9] * 251)</span><br><span class="line">[65175] :: madd s7 += (&amp;out[10] * 122)</span><br><span class="line">[65230] :: madd s7 += (&amp;out[11] * 60)</span><br><span class="line">[65277] :: madd s7 += (&amp;out[12] * 237)</span><br><span class="line">[65340] :: madd s7 += (&amp;out[13] * 27)</span><br><span class="line">[65384] :: madd s7 += (&amp;out[14] * 63)</span><br><span class="line">[65441] :: madd s7 += (&amp;out[15] * 207)</span><br><span class="line">[65504] :: madd s7 += (&amp;out[16] * 33)</span><br><span class="line">[65541] :: madd s7 += (&amp;out[17] * 138)</span><br><span class="line">[65589] :: madd s7 += (&amp;out[18] * 51)</span><br><span class="line">[65636] :: madd s7 += (&amp;out[19] * 103)</span><br><span class="line">[65691] :: madd s7 += (&amp;out[20] * 58)</span><br><span class="line">[65738] :: madd s7 += (&amp;out[21] * 68)</span><br><span class="line">[65778] :: madd s7 += (&amp;out[22] * 120)</span><br><span class="line">[65828] :: madd s7 += (&amp;out[23] * 111)</span><br><span class="line">[65888] :: mov s2, &amp;s5.11</span><br><span class="line">[65890] :: mov(5) s7.11, s2</span><br><span class="line">[65891] :: mov s2, &amp;s7</span><br><span class="line">[65893] :: add s4, s4, s2</span><br><span class="line">[65896] :: mov s7, &amp;-368502</span><br><span class="line">[65897] :: madd s7 += (&amp;out[0] * 254)</span><br><span class="line">[65965] :: madd s7 += (&amp;out[1] * 21)</span><br><span class="line">[66004] :: madd s7 += (&amp;out[2] * 157)</span><br><span class="line">[66062] :: madd s7 += (&amp;out[3] * 204)</span><br><span class="line">[66115] :: madd s7 += (&amp;out[4] * 56)</span><br><span class="line">[66157] :: madd s7 += (&amp;out[5] * 134)</span><br></pre></td></tr></table></figure>

<h3 id="Trunc"><a href="#Trunc" class="headerlink" title="Trunc"></a>Trunc</h3><p>每组<code>madd</code>指令之后，我们看到一些奇怪的指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[65888] :: mov s2, &amp;s5.11</span><br><span class="line">[65890] :: mov(5) s7.11, s2</span><br></pre></td></tr></table></figure>

<p>我们正在往一个符号值的偏移为11的地方（就是<code>&amp;sym.st_value + 3</code>）写入值。</p>
<p>检查这些代码，可以发现s5总为0。所以这个指令就是把这个符号值的高5字节清零，即<code>sym &amp;= 0xffffff</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Trunc = namedtuple(<span class="string">&#x27;trunc&#x27;</span>, [<span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line">def lift_truncate(instructions):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; len(instructions):</span><br><span class="line">        match instructions[idx:idx+<span class="number">2</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), Ref(SymAddr(Symbol(<span class="number">5</span>), <span class="number">11</span>)), _, ridx),</span><br><span class="line">                Mov(SymAddr(Symbol(<span class="number">7</span>), <span class="number">11</span>), Symbol(<span class="number">2</span>), <span class="number">5</span>, _)</span><br><span class="line">            ]:</span><br><span class="line">                instructions[idx:idx+<span class="number">2</span>] = [</span><br><span class="line">                    Trunc(Symbol(<span class="number">7</span>), <span class="number">0xffffff</span>, ridx)]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例8（2336条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[80967] :: madd s7 += (&amp;out[17] * 219)</span><br><span class="line">[81030] :: madd s7 += (&amp;out[18] * 74)</span><br><span class="line">[81075] :: madd s7 += (&amp;out[19] * 223)</span><br><span class="line">[81143] :: madd s7 += (&amp;out[20] * 220)</span><br><span class="line">[81201] :: madd s7 += (&amp;out[21] * 235)</span><br><span class="line">[81264] :: madd s7 += (&amp;out[22] * 151)</span><br><span class="line">[81322] :: madd s7 += (&amp;out[23] * 165)</span><br><span class="line">[81375] :: trunc s7 &amp;= 0xffffff         // yay</span><br><span class="line">[81378] :: mov s2, &amp;s7</span><br><span class="line">[81380] :: add s4, s4, s2</span><br><span class="line">[81383] :: mov s7, &amp;-488931</span><br><span class="line">[81384] :: madd s7 += (&amp;out[0] * 207)</span><br><span class="line">[81447] :: madd s7 += (&amp;out[1] * 123)</span><br><span class="line">[81507] :: madd s7 += (&amp;out[2] * 9)</span><br></pre></td></tr></table></figure>

<h3 id="Array-slots"><a href="#Array-slots" class="headerlink" title="Array slots"></a>Array slots</h3><p>在新的字节码里，我们发现了巨多常量。还有一些像数组的新地方：</p>
<p>注意：setinfo只是一个进入st_name设置其他字段的8字节mov。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// NOP relocations for array space</span><br><span class="line">[93678] :: mov baseaddr(), &amp;0</span><br><span class="line">[93679] :: mov baseaddr(), &amp;0</span><br><span class="line">[93680] :: mov baseaddr(), &amp;0</span><br><span class="line">[93681] :: mov baseaddr(), &amp;0</span><br><span class="line">[93682] :: mov baseaddr(), &amp;0</span><br><span class="line">[93683] :: mov baseaddr(), &amp;0</span><br><span class="line">// Array data...</span><br><span class="line">[93684] :: mov r93678.r_address, &amp;6124966137932793672</span><br><span class="line">[93685] :: mov r93678.r_info, &amp;-4041842636978026168</span><br><span class="line">[93686] :: mov r93678.r_addend, &amp;5027987508982512709</span><br><span class="line">[93687] :: mov r93679.r_address, &amp;-8413873093579112200</span><br><span class="line">[93688] :: mov r93679.r_info, &amp;5011179070235933765</span><br><span class="line">[93689] :: mov r93679.r_addend, &amp;4323655821306185960</span><br><span class="line">[93690] :: mov r93680.r_address, &amp;7154245383694349856</span><br><span class="line">[93691] :: mov r93680.r_info, &amp;-3458402876407461680</span><br><span class="line">[93692] :: mov r93680.r_addend, &amp;-5186046161349200369</span><br><span class="line">[93693] :: mov r93681.r_address, &amp;51797902590214145</span><br><span class="line">[93694] :: mov r93681.r_info, &amp;5009120185953550336</span><br><span class="line">[93695] :: mov r93681.r_addend, &amp;-4648246994148326916</span><br><span class="line">[93696] :: mov r93682.r_address, &amp;-8410243179269569141</span><br><span class="line">[93697] :: mov r93682.r_info, &amp;51245831810508869</span><br><span class="line">[93698] :: mov r93682.r_addend, &amp;5011371985779865103</span><br><span class="line">[93699] :: mov r93683.r_address, &amp;215243856300280</span><br><span class="line">[93700] :: mov s3, &amp;r93678.r_address</span><br><span class="line">[93701] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93702] :: add s5, s3, 0</span><br><span class="line">[93703] :: mov s2, &amp;r101997.r_address</span><br><span class="line">[93705] :: mov(144) r93678.r_address, s2</span><br><span class="line">[93706] :: mov s2, &amp;s5</span><br><span class="line">[93708] :: add s4, s4, s2</span><br><span class="line">[93711] :: mov s5, &amp;0</span><br><span class="line">[93712] :: mov s7, &amp;-55708</span><br><span class="line">[93713] :: madd s7 += (&amp;flag[16] * 76)</span><br><span class="line">[93758] :: madd s7 += (&amp;flag[17] * 104)</span><br><span class="line">[93803] :: mov s2, &amp;flag[18]</span><br><span class="line">[93805] :: mov(1) s5, s2</span><br><span class="line">// Array space?</span><br><span class="line">[93806] :: mov baseaddr(), &amp;0</span><br><span class="line">// Array data...</span><br><span class="line">[93807] :: mov r93806.r_address, &amp;-6989445605485108096</span><br><span class="line">[93808] :: mov r93806.r_info, &amp;195</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br><span class="line">[93814] :: mov(24) r93806.r_address, s2</span><br><span class="line">[93815] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>

<p>这些数组似乎总是由一堆nop指令(<code>mov baseaddr(), &amp;0</code>)组成，后面跟着一堆mov来给数组赋值。</p>
<p>我们可以扫描这种字节码并放到一个固定的常量数组中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ArraySlots = namedtuple(<span class="string">&#x27;arr&#x27;</span>, [<span class="string">&#x27;values&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_array_slots</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(BaseAddr(), Ref(<span class="number">0</span>), _, ridx):</span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    op = instructions[ptr]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(op) != Mov <span class="keyword">or</span> op.dst != BaseAddr():</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                start = idx</span><br><span class="line">                end = ptr</span><br><span class="line"></span><br><span class="line">                data = []</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Check for movs into array.</span></span><br><span class="line">                vstart = RelocAddr(Reloc(ridx), <span class="string">&#x27;r_address&#x27;</span>).vaddr()</span><br><span class="line">                offset = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> end + offset &lt; <span class="built_in">len</span>(instructions) <span class="keyword">and</span> offset &lt; ((end - start) * <span class="number">3</span>):</span><br><span class="line">                    op = instructions[end + offset]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(op) == Mov <span class="keyword">and</span> <span class="built_in">type</span>(op.dst) <span class="keyword">is</span> RelocAddr <span class="keyword">and</span> op.dst.vaddr() == vstart + (offset * <span class="number">8</span>):</span><br><span class="line">                        data.append(op.src.val)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    offset += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span>:</span><br><span class="line">                    data += [<span class="number">0</span>] * (((end - start) * <span class="number">3</span>) - <span class="built_in">len</span>(data))   </span><br><span class="line">                    instructions[idx:end+offset] = [</span><br><span class="line">                        ArraySlots(data, ridx)</span><br><span class="line">                    ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例9（2161条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[93677] :: mov s5, &amp;0</span><br><span class="line">// what a chonker</span><br><span class="line">[93678] :: array [0x5500404040c7c748, -0x38178276b71a76b8, 0x45c700000000fc45, -0x74c414ffffffff08, 0x458b48d06348fc45, 0x3c00b60fd00148e8, 0x6348fc458b147620, -0x2ffeb717ba74b730, -0x47f88981c3ff49f1, 0xb805eb00000001, 0x4583f84509000000, -0x4081e403827cfe04, -0x74b72f9cb703ba75, 0xb60fd00148e845, 0x458bf84509c0b60f, 0xc3c35d9848f8, 0x0, 0x0]</span><br><span class="line">[93700] :: mov s3, &amp;r93678.r_address</span><br><span class="line">[93701] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93702] :: add s5, s3, 0</span><br><span class="line">[93703] :: mov s2, &amp;r101997.r_address</span><br><span class="line">[93705] :: mov(144) r93678.r_address, s2</span><br><span class="line">[93706] :: mov s2, &amp;s5</span><br><span class="line">[93708] :: add s4, s4, s2</span><br><span class="line">[93711] :: mov s5, &amp;0</span><br><span class="line">[93712] :: mov s7, &amp;-55708</span><br><span class="line">[93713] :: madd s7 += (&amp;flag[16] * 76)</span><br><span class="line">[93758] :: madd s7 += (&amp;flag[17] * 104)</span><br><span class="line">[93803] :: mov s2, &amp;flag[18]</span><br><span class="line">[93805] :: mov(1) s5, s2</span><br><span class="line">// smol</span><br><span class="line">[93806] :: array [-0x60ff7fbf1bdadb80, 0xc3, 0x0]</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br></pre></td></tr></table></figure>

<h3 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h3><p>现在问题是那些值是啥东西？我刚开始以为它们是某些矩阵算出来的值。</p>
<p>但是我注意到<code>0x48</code>前缀和<code>0xc3</code>后缀，并对字节码产生了怀疑。我之前还注意到，重新定位部分被标记了rwx。</p>
<p>所以让我们把第一个块扔进 Binary Ninja，看看会发生什么……</p>
<p><img src="/img/code/chall_photo/chunk1.png"></p>
<p>彳亍，那肯定是字节码了。第一个大函数似乎只是检查所有标志字节是否在<code>(0x20, 0x7e)</code>范围内。</p>
<p>这也是唯一的大功能，其余的似乎都是9字节的shellcode数据。</p>
<p>我不太了解shellcode 是如何在这里实际执行的，但它与加载指向 shellcode 的符号有关。我们可以将以下块识别为“执行 shellcode”块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[93806] :: array [-0x60ff7fbf1bdadb80, 0xc3, 0x0]</span><br><span class="line">[93809] :: mov s3, &amp;r93806.r_address</span><br><span class="line">[93810] :: setinfo s3, name=0x1a, info=0x1, other=0x0, shndx=0x0</span><br><span class="line">[93811] :: add r93806.r_address, s3, 0</span><br><span class="line">[93812] :: mov s2, &amp;r102002.r_address</span><br><span class="line">[93814] :: mov(24) r93806.r_address, s2</span><br></pre></td></tr></table></figure>

<p>把它淦掉：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line"></span><br><span class="line">Shellcode = namedtuple(<span class="string">&#x27;shellcode&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_shellcode</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">6</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                ArraySlots(values, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">3</span>), Ref(RelocAddr(Reloc(rel2), <span class="string">&#x27;r_address&#x27;</span>)), _, _),</span><br><span class="line">                Mov(SymAddr(Symbol(<span class="number">3</span>), <span class="string">&#x27;st_name&#x27;</span>), _, _, _),</span><br><span class="line">                Add(dst, Symbol(<span class="number">3</span>), _, _),</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), _, _, _),</span><br><span class="line">                Mov(RelocAddr(Reloc(rel6), <span class="string">&#x27;r_address&#x27;</span>), Symbol(<span class="number">2</span>), _, _)</span><br><span class="line">            ] <span class="keyword">if</span> (rel2 == ridx) <span class="keyword">and</span> (rel6 == ridx):</span><br><span class="line">                instructions[idx:idx+<span class="number">6</span>] = [</span><br><span class="line">                    Shellcode(dst, <span class="string">b&#x27;&#x27;</span>.join([(x &amp; <span class="number">0xffffffffffffffff</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> values]), ridx)</span><br><span class="line">                ]</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>dump的时候可以通过<code>capstone</code>得到漂亮的反汇编代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">instructions</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">case</span> Shellcode(dst, code, ridx):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;[<span class="subst">&#123;ridx:04d&#125;</span>] :: exec <span class="subst">&#123;dst&#125;</span> &lt;- <span class="subst">&#123;code.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(code, <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">if</span> i.mnemonic == <span class="string">&#x27;ret&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;    0x%x:\t%s\t%s&quot;</span> % (</span><br><span class="line">                i.address, </span><br><span class="line">                i.mnemonic, </span><br><span class="line">                i.op_str.replace(<span class="string">&#x27;0x8040e4&#x27;</span>, <span class="string">&#x27;s5&#x27;</span>)</span><br><span class="line">                        .replace(<span class="string">&#x27;0x8040cc&#x27;</span>, <span class="string">&#x27;s4&#x27;</span>)))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>样例10（1771条指令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// have you seen sexier disassembly?</span><br><span class="line"></span><br><span class="line">[100408] :: add s4, s4, s2</span><br><span class="line">[100411] :: mov s7, &amp;-30801</span><br><span class="line">[100412] :: madd s7 += (&amp;flag[16] * 15)</span><br><span class="line">[100453] :: madd s7 += (&amp;flag[17] * 41)</span><br><span class="line">[100495] :: mov s2, &amp;flag[18]</span><br><span class="line">[100497] :: mov(1) s5, s2</span><br><span class="line">[100498] :: exec r100498.r_address &lt;- c00425e4408000b4c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	rol	byte ptr [s5], 0xb4</span><br><span class="line">--------------------</span><br><span class="line">[100507] :: mov s2, &amp;s5</span><br><span class="line">[100509] :: add s7, s7, s2</span><br><span class="line">[100512] :: mov s2, &amp;flag[19]</span><br><span class="line">[100514] :: mov(1) s5, s2</span><br><span class="line">[100515] :: exec r100515.r_address &lt;- c02c25e440800003c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	shr	byte ptr [s5], 3</span><br><span class="line">--------------------</span><br><span class="line">[100524] :: mov s2, &amp;s5</span><br><span class="line">[100526] :: add s7, s7, s2</span><br><span class="line">[100529] :: mov s2, &amp;flag[20]</span><br><span class="line">[100531] :: mov(1) s5, s2</span><br><span class="line">[100532] :: exec r100532.r_address &lt;- c00c25e440800064c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	ror	byte ptr [s5], 0x64</span><br><span class="line">--------------------</span><br><span class="line">[100541] :: mov s2, &amp;s5</span><br><span class="line">[100543] :: add s7, s7, s2</span><br><span class="line">[100546] :: madd s7 += (&amp;flag[21] * 167)</span><br><span class="line">[100604] :: mov s2, &amp;flag[22]</span><br><span class="line">[100606] :: mov(1) s5, s2</span><br><span class="line">[100607] :: exec r100607.r_address &lt;- c00425e440800051c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	rol	byte ptr [s5], 0x51</span><br><span class="line">--------------------</span><br><span class="line">[100616] :: mov s2, &amp;s5</span><br></pre></td></tr></table></figure>

<h3 id="Aop"><a href="#Aop" class="headerlink" title="Aop"></a>Aop</h3><p>所以这个shellcode只是被用来做更多类型的操作的一种机制。</p>
<p>举个🌰：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[100512] :: mov s2, &amp;flag[19]</span><br><span class="line">[100514] :: mov(1) s5, s2</span><br><span class="line">[100515] :: exec r100515.r_address &lt;- c02c25e440800003c3000000000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	shr	byte ptr [s5], 3</span><br><span class="line">--------------------</span><br><span class="line">[100524] :: mov s2, &amp;s5</span><br><span class="line">[100526] :: add s7, s7, s2</span><br></pre></td></tr></table></figure>

<p>这个块就是<code>s7 += (flag[19] &gt;&gt; 3)</code></p>
<p>我们可以定义一个类似于madd的aop（加操作），不过它多了一个操作符号：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Aop = namedtuple(<span class="string">&#x27;aop&#x27;</span>, [<span class="string">&#x27;dst&#x27;</span>, <span class="string">&#x27;op&#x27;</span>, <span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;ridx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_aop</span>(<span class="params">instructions</span>):</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx:idx+<span class="number">5</span>]:</span><br><span class="line">            <span class="keyword">case</span> [</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), val, _, ridx),</span><br><span class="line">                Mov(Symbol(<span class="number">5</span>), Symbol(<span class="number">2</span>), _, _),</span><br><span class="line">                Shellcode(_, data, _),</span><br><span class="line">                Mov(Symbol(<span class="number">2</span>), Ref(Symbol(<span class="number">5</span>)), _, _),</span><br><span class="line">                Add(dst, dst2, Symbol(<span class="number">2</span>), _)</span><br><span class="line">            ] <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">24</span> <span class="keyword">and</span> (dst == dst2):</span><br><span class="line">                op = <span class="built_in">next</span>(md.disasm(data, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">                t = op.mnemonic</span><br><span class="line">                k = <span class="built_in">int</span>(op.op_str.split(<span class="string">&#x27;, &#x27;</span>)[-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">                instructions[idx:idx+<span class="number">5</span>] = [</span><br><span class="line">                    Aop(dst, t, val, k, ridx)</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> instructions</span><br></pre></td></tr></table></figure>

<p>样例11（1147条指令）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// out madd computation</span><br><span class="line">[64607] :: mov s5, &amp;0</span><br><span class="line">[64608] :: mov s7, &amp;-393039</span><br><span class="line">[64609] :: madd s7 += (&amp;out[0] * 155)</span><br><span class="line">[64667] :: madd s7 += (&amp;out[1] * 190)</span><br><span class="line">[64730] :: madd s7 += (&amp;out[2] * 208)</span><br><span class="line">[64778] :: madd s7 += (&amp;out[3] * 123)</span><br><span class="line">[64838] :: madd s7 += (&amp;out[4] * 214)</span><br><span class="line">[64896] :: madd s7 += (&amp;out[5] * 146)</span><br><span class="line">[64944] :: madd s7 += (&amp;out[6] * 211)</span><br><span class="line">[65002] :: madd s7 += (&amp;out[7] * 85)</span><br><span class="line">[65052] :: madd s7 += (&amp;out[8] * 87)</span><br><span class="line">[65107] :: madd s7 += (&amp;out[9] * 251)</span><br><span class="line">[65175] :: madd s7 += (&amp;out[10] * 122)</span><br><span class="line">[65230] :: madd s7 += (&amp;out[11] * 60)</span><br><span class="line">[65277] :: madd s7 += (&amp;out[12] * 237)</span><br><span class="line">[65340] :: madd s7 += (&amp;out[13] * 27)</span><br><span class="line">[65384] :: madd s7 += (&amp;out[14] * 63)</span><br><span class="line">[65441] :: madd s7 += (&amp;out[15] * 207)</span><br><span class="line">[65504] :: madd s7 += (&amp;out[16] * 33)</span><br><span class="line">[65541] :: madd s7 += (&amp;out[17] * 138)</span><br><span class="line">[65589] :: madd s7 += (&amp;out[18] * 51)</span><br><span class="line">[65636] :: madd s7 += (&amp;out[19] * 103)</span><br><span class="line">[65691] :: madd s7 += (&amp;out[20] * 58)</span><br><span class="line">[65738] :: madd s7 += (&amp;out[21] * 68)</span><br><span class="line">[65778] :: madd s7 += (&amp;out[22] * 120)</span><br><span class="line">[65828] :: madd s7 += (&amp;out[23] * 111)</span><br><span class="line">[65888] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[65891] :: mov s2, &amp;s7</span><br><span class="line">[65893] :: add s4, s4, s2</span><br><span class="line"></span><br><span class="line">// flag 16-27 computation</span><br><span class="line">[98563] :: mov s2, &amp;s7</span><br><span class="line">[98565] :: add s4, s4, s2</span><br><span class="line">[98568] :: mov s7, &amp;-62593</span><br><span class="line">[98569] :: madd s7 += (&amp;flag[16] * 162)</span><br><span class="line">[98617] :: aop s7 += (&amp;flag[17] ror 59)</span><br><span class="line">[98634] :: madd s7 += (&amp;flag[18] * 4)</span><br><span class="line">[98657] :: aop s7 += (&amp;flag[19] shl 0)</span><br><span class="line">[98674] :: madd s7 += (&amp;flag[20] * 207)</span><br><span class="line">[98737] :: madd s7 += (&amp;flag[21] * 128)</span><br><span class="line">[98775] :: aop s7 += (&amp;flag[22] ror 21)</span><br><span class="line">[98792] :: aop s7 += (&amp;flag[23] or 72)</span><br><span class="line">[98809] :: madd s7 += (&amp;flag[24] * 23)</span><br><span class="line">[98853] :: aop s7 += (&amp;flag[25] rol 1)</span><br><span class="line">[98870] :: madd s7 += (&amp;flag[26] * 247)</span><br><span class="line">[98938] :: aop s7 += (&amp;flag[27] shr 3)</span><br><span class="line">[98955] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[98958] :: mov s2, &amp;s7</span><br><span class="line">[98960] :: add s4, s4, s2</span><br><span class="line">[98963] :: mov s7, &amp;-80711</span><br><span class="line">[98964] :: madd s7 += (&amp;flag[16] * 62)</span><br><span class="line">[99016] :: aop s7 += (&amp;flag[17] or 139)</span><br><span class="line">[99033] :: madd s7 += (&amp;flag[18] * 21)</span><br><span class="line">[99072] :: madd s7 += (&amp;flag[19] * 239)</span><br><span class="line">[99140] :: madd s7 += (&amp;flag[20] * 145)</span><br><span class="line">[99188] :: madd s7 += (&amp;flag[21] * 103)</span><br><span class="line">[99243] :: aop s7 += (&amp;flag[22] shr 0)</span><br><span class="line">[99260] :: aop s7 += (&amp;flag[23] rol 228)</span><br><span class="line">[99277] :: madd s7 += (&amp;flag[24] * 184)</span><br><span class="line">[99330] :: madd s7 += (&amp;flag[25] * 241)</span><br><span class="line">[99388] :: madd s7 += (&amp;flag[26] * 72)</span><br><span class="line">[99428] :: aop s7 += (&amp;flag[27] xor 38)</span><br><span class="line">[99445] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[99448] :: mov s2, &amp;s7</span><br><span class="line">[99450] :: add s4, s4, s2</span><br><span class="line">[99453] :: mov s7, &amp;-98024</span><br></pre></td></tr></table></figure>

<blockquote>
<p>跟着走下来突然感觉1k条指令已经算少的了🤣<br>怪不得av神曾曰：“<strong>区区几千个函数</strong>”</p>
</blockquote>
<p>![](&#x2F;img&#x2F;code&#x2F;chall_photo&#x2F;chunk2.png width&#x3D;50% &#x2F;&gt;</p>
<h2 id="Part3-解决"><a href="#Part3-解决" class="headerlink" title="Part3 解决"></a>Part3 解决</h2><p>根据前面的反汇编，我们可以看到约束检查器(constraint checker)被分成了这样的块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[98963] :: mov s7, &amp;-80711</span><br><span class="line">[98964] :: madd s7 += (&amp;flag[16] * 62)</span><br><span class="line">[99016] :: aop s7 += (&amp;flag[17] or 139)</span><br><span class="line">[99033] :: madd s7 += (&amp;flag[18] * 21)</span><br><span class="line">[99072] :: madd s7 += (&amp;flag[19] * 239)</span><br><span class="line">[99140] :: madd s7 += (&amp;flag[20] * 145)</span><br><span class="line">[99188] :: madd s7 += (&amp;flag[21] * 103)</span><br><span class="line">[99243] :: aop s7 += (&amp;flag[22] shr 0)</span><br><span class="line">[99260] :: aop s7 += (&amp;flag[23] rol 228)</span><br><span class="line">[99277] :: madd s7 += (&amp;flag[24] * 184)</span><br><span class="line">[99330] :: madd s7 += (&amp;flag[25] * 241)</span><br><span class="line">[99388] :: madd s7 += (&amp;flag[26] * 72)</span><br><span class="line">[99428] :: aop s7 += (&amp;flag[27] xor 38)</span><br><span class="line">[99445] :: trunc s7 &amp;= 0xffffff</span><br><span class="line">[99448] :: mov s2, &amp;s7</span><br><span class="line">[99450] :: add s4, s4, s2</span><br></pre></td></tr></table></figure>

<p>接近结尾的时候可以看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[101625] :: mov fail(), &amp;0</span><br><span class="line">[101626] :: exec s4 &lt;- 8b0425cc408000f7d819c0c3000000000000000000000000</span><br><span class="line">--------------------</span><br><span class="line">    0x0:	mov	eax, dword ptr [s4]</span><br><span class="line">    0x7:	neg	eax</span><br><span class="line">    0x9:	sbb	eax, eax</span><br><span class="line">--------------------</span><br><span class="line">[101635] :: mov s2, &amp;s4</span><br><span class="line">[101637] :: mov fail(), s2</span><br></pre></td></tr></table></figure>

<p>所以s4必须保持0，否则就设置fail符号，说明flag是错误的。</p>
<p>所以上面的块表示对部分flag的操作，然后再加上-80711（s7里）必须等于0</p>
<h3 id="后半段flag"><a href="#后半段flag" class="headerlink" title="后半段flag"></a>后半段flag</h3><p><code>flag[16:27]</code>约束一下，z3一把梭了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_end_flag</span>(<span class="params">instructions</span>):</span><br><span class="line">    orig = [BitVec(<span class="string">&#x27;f%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>,<span class="number">28</span>)]</span><br><span class="line">    flag = ([<span class="number">0</span>] * <span class="number">16</span>) + [ZeroExt(<span class="number">24</span>, x) <span class="keyword">for</span> x <span class="keyword">in</span> orig]</span><br><span class="line"></span><br><span class="line">    s = Solver()</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> orig:</span><br><span class="line">        s.add(UGT(o, <span class="number">0x20</span>))</span><br><span class="line">        s.add(ULT(o, <span class="number">0x7f</span>))</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(Symbol(<span class="number">7</span>), Ref(v), _, ridx) <span class="keyword">if</span> <span class="built_in">type</span>(v) <span class="keyword">is</span> <span class="built_in">int</span>:</span><br><span class="line">                x = BitVecVal(v, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> MultAdd(Symbol(<span class="number">7</span>), Ref(FlagAddr(f)), k, _):</span><br><span class="line">                            x += (flag[f] * k)</span><br><span class="line">                        <span class="keyword">case</span> Aop(Symbol(<span class="number">7</span>), op, Ref(FlagAddr(f)), k, _):</span><br><span class="line">                            v = <span class="literal">None</span></span><br><span class="line">                            <span class="keyword">match</span> op:</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;and&#x27;</span>: v = flag[f] &amp; k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;xor&#x27;</span>: v = flag[f] ^ k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;or&#x27;</span>: v = flag[f] | k</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;rol&#x27;</span>: v = ZeroExt(<span class="number">24</span>, RotateLeft(Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]), k))</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;ror&#x27;</span>: v = ZeroExt(<span class="number">24</span>, RotateRight(Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]), k))</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;shl&#x27;</span>: v = ZeroExt(<span class="number">24</span>, Extract(<span class="number">7</span>,<span class="number">0</span>,flag[f]) &lt;&lt; k)</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&#x27;shr&#x27;</span>: v = flag[f] &gt;&gt; k</span><br><span class="line">                                <span class="keyword">case</span> _:</span><br><span class="line">                                    <span class="keyword">raise</span> Exception(<span class="string">f&#x27;unknown aop: <span class="subst">&#123;op&#125;</span>&#x27;</span>)</span><br><span class="line">                            x += v</span><br><span class="line">                        <span class="keyword">case</span> Trunc(Symbol(<span class="number">7</span>), k, _):</span><br><span class="line">                            s.add(x == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(s.check())</span><br><span class="line"></span><br><span class="line">    m = s.model()</span><br><span class="line">    flag = <span class="built_in">bytes</span>([m.<span class="built_in">eval</span>(o).as_long() <span class="keyword">for</span> o <span class="keyword">in</span> orig])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">sat</span></span><br><span class="line"><span class="string">b&#x27;3_3LF_m4g1c&#125;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="output数组"><a href="#output数组" class="headerlink" title="output数组"></a>output数组</h3><p>我用z3去约束out数组（这数组里只用了madd），但是8太彳亍。</p>
<blockquote>
<p>ctfer宁愿用z3解线性方程组，也不愿学习矩阵是个啥。<br>— cts (@gf_256) <a target="_blank" rel="noopener" href="https://twitter.com/gf_256/status/1543321843037310985?ref_src=twsrc%5Etfw">July 2, 2022</a></p>
</blockquote>
<p>每个单独的约束只有madd，相当于矩阵里的一行，因为正好有24个out值和24组约束（是个方阵），所以我们可以求解这个矩阵。</p>
<p>这次不用z3，用<code>np.linalg.solve</code>来求解矩阵：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_out_arr</span>(<span class="params">instructions</span>):</span><br><span class="line">    X = []</span><br><span class="line">    Y = []</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">        <span class="keyword">match</span> instructions[idx]:</span><br><span class="line">            <span class="keyword">case</span> Mov(Symbol(<span class="number">7</span>), Ref(v), _, ridx) <span class="keyword">if</span> <span class="built_in">type</span>(v) <span class="keyword">is</span> <span class="built_in">int</span>:</span><br><span class="line">                row = []</span><br><span class="line"></span><br><span class="line">                ptr = idx+<span class="number">1</span></span><br><span class="line">                <span class="keyword">while</span> ptr &lt; <span class="built_in">len</span>(instructions):</span><br><span class="line">                    <span class="keyword">match</span> instructions[ptr]:</span><br><span class="line">                        <span class="keyword">case</span> MultAdd(Symbol(<span class="number">7</span>), Ref(OutAddr(_)), k, _):</span><br><span class="line">                            row.append(k)</span><br><span class="line">                        <span class="keyword">case</span> Trunc(Symbol(<span class="number">7</span>), k, _):</span><br><span class="line">                            X.append(row)</span><br><span class="line">                            Y.append(-v)</span><br><span class="line">                        <span class="keyword">case</span> _:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                    ptr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    a = np.array(X, dtype=np.uint32)</span><br><span class="line">    b = np.array(Y, dtype=np.uint32)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> np.linalg.solve(a,b)]</span><br><span class="line"></span><br><span class="line"><span class="comment">#[134, 72, 7, 236, 29, 49, 88, 228, 231, 231, 227, 16, 242, 80, 242, 1, 224, 113, 46, 224, 108, 91, 103, 182]</span></span><br></pre></td></tr></table></figure>

<h3 id="前半段flag"><a href="#前半段flag" class="headerlink" title="前半段flag"></a>前半段flag</h3><p>这个out数组是根据flag的前16个字节和这些块计算的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[0347] :: shuffleblock &amp;flag[0], &amp;flag[1]</span><br><span class="line">[8028] :: mov s4, &amp;0</span><br><span class="line">[8029] :: output out[0], &amp;arr[0]</span><br><span class="line">[8071] :: output out[1], &amp;arr[1]</span><br><span class="line">[8113] :: output out[2], &amp;arr[2]</span><br><span class="line">[8155] :: reset</span><br><span class="line">[8411] :: mov s4, &amp;0</span><br><span class="line">[8412] :: shuffleblock &amp;flag[2], &amp;flag[3]</span><br><span class="line">[16092] :: mov s4, &amp;0</span><br><span class="line">[16093] :: output out[3], &amp;arr[0]</span><br><span class="line">[16135] :: output out[4], &amp;arr[1]</span><br><span class="line">[16177] :: output out[5], &amp;arr[2]</span><br><span class="line">[16219] :: reset</span><br><span class="line">[16475] :: mov s4, &amp;0</span><br><span class="line">[16476] :: shuffleblock &amp;flag[4], &amp;flag[5]</span><br><span class="line">[24156] :: mov s4, &amp;0</span><br><span class="line">[24157] :: output out[6], &amp;arr[0]</span><br><span class="line">[24199] :: output out[7], &amp;arr[1]</span><br><span class="line">[24241] :: output out[8], &amp;arr[2]</span><br><span class="line">[24283] :: reset</span><br></pre></td></tr></table></figure>

<p>具体来说，<code>out[0:3]</code>由<code>flag[0:2]</code>计算得到。<code>out[3:6]</code>由<code>flag[2:4]</code>得到，以此类推。</p>
<p>对于每个3元组可以直接爆破：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">solve_start_flag</span>(<span class="params">output</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sim</span>(<span class="params">a,b</span>):</span><br><span class="line">        arr = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line"></span><br><span class="line">        z = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            p = a <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> b</span><br><span class="line">            z = (z + arr[i] + p) &amp; <span class="number">0xff</span></span><br><span class="line">            arr[i], arr[z] = arr[z], arr[i]</span><br><span class="line"></span><br><span class="line">        out = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">        z = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            z = (z + arr[i]) &amp; <span class="number">0xff</span></span><br><span class="line">            arr[i], arr[z] = arr[z], arr[i]</span><br><span class="line">            out[i] = arr[(arr[i] + arr[z]) &amp; <span class="number">0xff</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve_chunk</span>(<span class="params">k1,k2,k3</span>):</span><br><span class="line">        <span class="comment"># Brute force chunk.</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>, <span class="number">0x7f</span>):</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>, <span class="number">0x7f</span>):</span><br><span class="line">                out = sim(a,b)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">abs</span>(out[<span class="number">0</span>] - k1) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">abs</span>(out[<span class="number">1</span>] - k2) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">abs</span>(out[<span class="number">2</span>] - k3) &lt;= <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> (a,b)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    f = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(output),<span class="number">3</span>):</span><br><span class="line">        f += <span class="built_in">list</span>(solve_chunk(*output[i:i+<span class="number">3</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(f)</span><br><span class="line"></span><br><span class="line"><span class="comment">#CTF&#123;H0p3_y0u_l1k</span></span><br></pre></td></tr></table></figure>

<h2 id="完结撒花"><a href="#完结撒花" class="headerlink" title="完结撒花"></a>完结撒花</h2><p>完整脚本：<a target="_blank" rel="noopener" href="https://gist.github.com/hgarrereyn/9e536e8b3471d3cb8ecbb5932a776b95">https://gist.github.com/hgarrereyn/9e536e8b3471d3cb8ecbb5932a776b95</a></p>

    </div>

    <div class="about">
        <h1>关于本文</h1>
        <p>本文作者 云之君, 许可由 <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>

    
        
    
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/CTF" class="item">CTF</a>
                
                <a href="/Learn" class="item">Learn</a>
                
                <a href="/Diary" class="item">Diary</a>
                
                <a href="/friends" class="item">Friends</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/YunZh1Jun" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/25320847" class="item">Bilibili</a>
                
                <a href="mailto:yunzh1jun@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 云之君<br >驱动由 <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
    </body>
</html>