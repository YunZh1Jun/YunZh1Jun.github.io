<!DOCTYPE html>
<html lang="zh-cn">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>强网杯2022 初赛Reverse 复现 - 云之君&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/theme-img/fav/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

  
<meta name="generator" content="Hexo 5.4.2"></head>
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">云之君&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">主页</a>
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Learn">Learn</a>
            
            
            
            <a class="nav-item" href="/Dairy">Dairy</a>
            
            
            
            <a class="nav-item" href="/Alkaid">Alkaid</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/YunZh1Jun" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            
            <span>September</span>
            
            
            
            
            <span>18,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">强网杯2022 初赛Reverse 复现</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>终于开始缓慢复现强pwn杯了</p>
<span id="more"></span>

<h2 id="easyre"><a href="#easyre" class="headerlink" title="easyre"></a>easyre</h2><p>这题我真的是气死了啊啊啊啊啊啊浪费我一天时间！！！！！！！</p>
<h3 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h3><p>先finger一把梭了恢复符号表。</p>
<p>主函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// r8</span></span><br><span class="line">  __int64 v4; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// er8</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// er9</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_402150();</span><br><span class="line">  v9 = fork();</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401F2F(v9);</span><br><span class="line">    remove(<span class="string">&quot;re3&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sys_ptrace(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, v3, v4, (<span class="type">char</span>)argv);</span><br><span class="line">    sub_44B680((<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;re3&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;re3&quot;</span>, *(_QWORD *)(v8 + <span class="number">8</span>), <span class="number">0</span>, v5, v6, v8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_402150写了一个叫re3的文件，然后fork一个线程。父进程进入sub_401F2F运行re3，结束后remove掉re3，子进程接受父进程的ptrace</p>
<p>sub_401F2F：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_401F2F</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// r8</span></span><br><span class="line">  __int64 v2; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  __int64 v7; <span class="comment">// r9</span></span><br><span class="line">  __int64 v8; <span class="comment">// r8</span></span><br><span class="line">  __int64 v9; <span class="comment">// r9</span></span><br><span class="line">  __int64 v10; <span class="comment">// r8</span></span><br><span class="line">  __int64 v11; <span class="comment">// r9</span></span><br><span class="line">  __int64 v12; <span class="comment">// r8</span></span><br><span class="line">  __int64 v13; <span class="comment">// r9</span></span><br><span class="line">  __int64 v14; <span class="comment">// r8</span></span><br><span class="line">  __int64 v15; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [rsp+0h] [rbp-130h]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [rsp+0h] [rbp-130h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [rsp+0h] [rbp-130h]</span></span><br><span class="line">  <span class="type">char</span> v19; <span class="comment">// [rsp+0h] [rbp-130h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// [rsp+10h] [rbp-120h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+18h] [rbp-118h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [rsp+2Ch] [rbp-104h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">v23</span>;</span> <span class="comment">// [rsp+30h] [rbp-100h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v24; <span class="comment">// [rsp+108h] [rbp-28h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+110h] [rbp-20h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+118h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+124h] [rbp-Ch]</span></span><br><span class="line">  __int64 v28; <span class="comment">// [rsp+128h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  sys_wait(a1, <span class="number">0LL</span>, <span class="number">0</span>);</span><br><span class="line">  sys_ptrace(PTRACE_CONT, a1, <span class="number">0LL</span>, <span class="number">0LL</span>, v1, v2, v16);</span><br><span class="line">  v26 = sub_401A30(a1);</span><br><span class="line">  v3 = sub_4017E5();</span><br><span class="line">  result = v4;</span><br><span class="line">  v20 = v3;</span><br><span class="line">  v21 = v4;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v22 = <span class="number">0</span>;</span><br><span class="line">    sys_wait(a1, &amp;v22, <span class="number">0</span>);</span><br><span class="line">    result = v22 &amp; <span class="number">0x7F</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (v22 &amp; <span class="number">0x7F</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sys_ptrace(PTRACE_GETREGS, a1, <span class="number">0LL</span>, (__int64)&amp;v23, v6, v7, v17);</span><br><span class="line">    v25 = v23.rip - <span class="number">1</span>;</span><br><span class="line">    v24 = sys_ptrace(PTRACE_PEEKTEXT, a1, v23.rip - <span class="number">1</span>, <span class="number">0LL</span>, v8, v9, v18);</span><br><span class="line">    <span class="keyword">if</span> ( v24 == <span class="number">0xCAFEB055BFCC</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      v28 = v25;</span><br><span class="line">      SMC(a1, v25, v26, v20, v21);</span><br><span class="line">      v23.rip = v25 + <span class="number">10</span>;</span><br><span class="line">      sys_ptrace(PTRACE_SETREGS, a1, <span class="number">0LL</span>, (__int64)&amp;v23, v12, v13, v19);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == <span class="number">0xCAFE1055BFCC</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      lizaiganshenmo(a1, v28, v25, v26, v20, v21);</span><br><span class="line">      v23.rip = v25 + <span class="number">10</span>;</span><br><span class="line">      sys_ptrace(PTRACE_SETREGS, a1, <span class="number">0LL</span>, (__int64)&amp;v23, v14, v15, v19);</span><br><span class="line">    &#125;</span><br><span class="line">    result = sys_ptrace(PTRACE_CONT, a1, <span class="number">0LL</span>, <span class="number">0LL</span>, v10, v11, v19);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_4017E5取了一堆抽象的数据。起子进程后等待子进程运行，wait子进程发送信号，为0就退出for循环。不为0的话就保存子进程的寄存器，然后去判断if-else（就是一个子进程命中异常后把控制权交给父进程，父进程保存子进程上下文，处理完异常后恢复子进程上下文，此后继续运行子进程的过程）。</p>
<p>依据从RIP-1处取到的数据来判断进入if还是else，if会对子进程进行一个SMC的操作，else则会将子进程SMC回去。<br>其实findcrypto可以找到MD5常数，然后推测SMC使用了对前面取的数据的MD5值来异或。<del>但是这样毕竟太玄学了，想要恢复re3还是应该采取一些正常人能想到的方法。</del></p>
<h3 id="re3分析"><a href="#re3分析" class="headerlink" title="re3分析"></a>re3分析</h3><p>获取re3很简单，手动dump<code>unk_4BC380</code>处的数据或者把remove扬了然后跑一遍程序就能获取到re3。</p>
<p>对re3分析主函数（分析不出来的函数一路C然后P就彳亍）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">jmp_buf_tag</span> <span class="title">env</span>[1];</span> <span class="comment">// [rsp+10h] [rbp-850h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">jmp_buf_tag</span> <span class="title">v5</span>[1];</span> <span class="comment">// [rsp+E0h] [rbp-780h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">jmp_buf_tag</span> <span class="title">v6</span>[1];</span> <span class="comment">// [rsp+1B0h] [rbp-6B0h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">jmp_buf_tag</span> <span class="title">v7</span>[1];</span> <span class="comment">// [rsp+280h] [rbp-5E0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">640</span>]; <span class="comment">// [rsp+350h] [rbp-510h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">636</span>]; <span class="comment">// [rsp+5D0h] [rbp-290h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+84Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+850h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+854h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+858h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [rsp+85Ch] [rbp-4h]</span></span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+860h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v14 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *, <span class="type">char</span> **, <span class="type">char</span> **))sub_2490)(a2[<span class="number">1</span>], a2, a3);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">void</span> *, <span class="type">char</span> *, <span class="type">char</span> *))loc_21F9)(&amp;unk_55C0, v9, v8);</span><br><span class="line">  v13 = _setjmp(env);</span><br><span class="line">  <span class="keyword">if</span> ( v13 &lt;= <span class="number">24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = _setjmp(v5);</span><br><span class="line">    <span class="keyword">if</span> ( v11 &lt; byte_50A0[<span class="number">25</span> * v13] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_50A0[<span class="number">25</span> * v13 + <span class="number">1</span> + v11] != *((<span class="type">char</span> *)&amp;savedregs + <span class="number">25</span> * v13 + v11 - <span class="number">655</span>) )<span class="comment">// v9</span></span><br><span class="line">        v14 = <span class="number">0</span>;</span><br><span class="line">      longjmp(v5, v11 + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    longjmp(env, v13 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = _setjmp(v6);</span><br><span class="line">  <span class="keyword">if</span> ( v12 &lt;= <span class="number">24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = _setjmp(v7);</span><br><span class="line">    <span class="keyword">if</span> ( v10 &lt; byte_5320[<span class="number">25</span> * v12] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_5320[<span class="number">25</span> * v12 + <span class="number">1</span> + v10] != *((<span class="type">char</span> *)&amp;savedregs + <span class="number">25</span> * v12 + v10 - <span class="number">1295</span>) )<span class="comment">// v8</span></span><br><span class="line">        v14 = <span class="number">0</span>;</span><br><span class="line">      longjmp(v7, v10 + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    longjmp(v6, v12 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;GOOD JOB&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_2490接受输入，控制输入只能为0或1，21F9进行了一些处理，但由于此函数被SMC了所以我们不知道它干了什么，然后把savedregs（做了一些混淆）和byte_50A0处的数据对比，能看出来数据是两组25*25的表。想要看到验证逻辑还是要恢复21F9处的逻辑。</p>
<h3 id="恢复re3"><a href="#恢复re3" class="headerlink" title="恢复re3"></a>恢复re3</h3><p>对于SMC，要么是静态分析自己写脚本恢复，要么是动态调试去解密程序。但是问题在于，子进程本身就处于一个被父进程调试的过程，所以我们没法再向子进程附加调试器。而当父进程结束时，子进程也会结束。不过正是因为父子进程的通信过程，我们又会多一种思路。对于本题而言，恢复re3有以下4种思路。</p>
<h4 id="通过patch程序让子进程成为僵尸进程"><a href="#通过patch程序让子进程成为僵尸进程" class="headerlink" title="通过patch程序让子进程成为僵尸进程"></a>通过patch程序让子进程成为僵尸进程</h4><p>思路来自<a target="_blank" rel="noopener" href="http://1.12.239.117:8090/archives/qwb2022-easyre">FallW1nd师傅</a>，直接看原文8 <del>我就不抄一遍了</del></p>
<p>整体的patch思路：</p>
<ul>
<li>让父进程不必等待子进程结束就可以自行结束</li>
<li>扬了父进程中对子进程SMC回去的操作</li>
<li>让子进程陷入死循环无法结束</li>
</ul>
<p>但是我WSL调试根本起不来子进程，怎么会是捏？<br>准备之后配个ubuntu虚拟机了🤗fork调的血压高</p>
<h4 id="硬刚加密函数"><a href="#硬刚加密函数" class="headerlink" title="硬刚加密函数"></a>硬刚加密函数</h4><p>findcrypto能看到MD5的常数，可以猜测是用了MD5。<br>可能调试看的更快吧，但是我起不来子进程，看看<a target="_blank" rel="noopener" href="https://ppppz.net/2022/08/03/QWB2022-GameMaster-EasyRe/">PZ师傅的WP</a></p>
<h4 id="通过trace程序获取真实数据"><a href="#通过trace程序获取真实数据" class="headerlink" title="通过trace程序获取真实数据"></a>通过trace程序获取真实数据</h4><p>思路来自track神（track神TTTTQQQQLLLL!!!</p>
<p>本题父进程对子进程的操作都需要从子进程读数据、在父进程中修改、写回子进程这3个过程。其中第1、3步会用到ptrace这个系统调用。<br>而对于系统调用，可以使用trace来leak出程序运行过程中的各种参数。</p>
<p>使用命令<code>strace -e trace=ptrace -o ./easyre.log ./easyre flag&#123;hhhhhhhhhh&#125;</code>，然后去看ptrace的log，只要把这些参数写回就好了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_POKETEXT, 149, 0x561dac238213, 0xe900000000fc45c7) = 0</span><br><span class="line">ptrace(PTRACE_PEEKTEXT, 149, 0x561dac238223, [0x4d94f7e68575494c]) = 0</span><br><span class="line">ptrace(PTRACE_POKETEXT, 149, 0x561dac238223, 0xf445c7000000) = 0</span><br><span class="line">ptrace(PTRACE_PEEKTEXT, 149, 0x561dac238233, [0xf1ac2feb8f8c89a9]) = 0</span><br><span class="line">ptrace(PTRACE_POKETEXT, 149, 0x561dac238233, 0x1ec45c700) = 0</span><br><span class="line">ptrace(PTRACE_PEEKTEXT, 149, 0x561dac238243, [0x7ef555b84fe2ed45]) = 0</span><br><span class="line">ptrace(PTRACE_POKETEXT, 149, 0x561dac238243, 0x8dd00102e0c1d089) = 0</span><br><span class="line">ptrace(PTRACE_PEEKTEXT, 149, 0x561dac238253, [0x7d3de98de644b0e3]) = 0</span><br><span class="line">ptrace(PTRACE_POKETEXT, 149, 0x561dac238253, 0xd06348d001f8458b) = 0</span><br><span class="line">ptrace(PTRACE_PEEKTEXT, 149, 0x561dac238263, [0xee5cc92072689f66]) = 0</span><br><span class="line">（后面太长不贴了</span><br></pre></td></tr></table></figure>

<p><code>PTRACE_POKETEXT</code>是向子进程写回数据，取这个数据就好。</p>
<p>IDAPython脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key = [<span class="number">0xe900000000fc45c7</span>,<span class="number">0xf445c7000000</span>,<span class="number">0x1ec45c700</span>,<span class="number">0x8dd00102e0c1d089</span>,<span class="number">0xd06348d001f8458b</span>,<span class="number">0x45830d74c08400b6</span>,<span class="number">0x7400f07d8347eb00</span>,<span class="number">0x14802e0c148d089</span>,<span class="number">0xc0458b48c2014800</span>,<span class="number">0x20c889848ec458b</span>,<span class="number">0xf045c701ec45</span>,<span class="number">0xf07d83407519f8</span>,<span class="number">0x4802e0c148d08948</span>,<span class="number">0x458b48c201480000</span>,<span class="number">0xc889848ec458bc1</span>,<span class="number">0x18f87d8301ec4583</span>,<span class="number">0x6348fc458bc189ec</span>,<span class="number">0x85148d48d00148</span>,<span class="number">0xff518dd00148c045</span>,<span class="number">0xfffffed48e0f18fc</span>,<span class="number">0xe445c700000122</span>,<span class="number">0xdc45c70000</span>,<span class="number">0xe4558b000000c7e9</span>,<span class="number">0xc201000000008514</span>,<span class="number">0xfd00148c8458b48</span>,<span class="number">0x1dc45c701e0</span>,<span class="number">0x48d06348e8458b3a</span>,<span class="number">0x85148d48d0</span>,<span class="number">0xc189e0458bc20148</span>,<span class="number">0x8300000000e045c7</span>,<span class="number">0x7d8301e445830000</span>,<span class="number">0xd06348e8458b3a74</span>,<span class="number">0x85148d48d001</span>,<span class="number">0x89e0458bc20148b8</span>,<span class="number">0xe045c702</span>,<span class="number">0x458bffffff2f8e0f</span>,<span class="number">0x2e0c148d08948d0</span>,<span class="number">0x8b48c20148000000</span>,<span class="number">0x7d8301e845831088</span>]</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x2213</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    idc.patch_qword(addr, i)</span><br><span class="line">    addr += <span class="number">16</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ok&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>patch完慢慢分析伪代码就彳亍。</p>
<p>然后就是注意一下，日常翻翻init段 = =<br>里面调用了一个函数sub_257D，里面对验证数据做了一些修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_257D</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">640</span>]; <span class="comment">// [rsp+0h] [rbp-290h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+280h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+28Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(v1, &amp;unk_3020, <span class="number">0x271</span>uLL);</span><br><span class="line">  v2 = (__int64)&amp;unk_5838 - <span class="number">1304</span>;        <span class="comment">//0x5320</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">24</span>; ++i )</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span> *)(<span class="number">25</span> * i + v2), &amp;v1[<span class="number">25</span> * i], (<span class="type">unsigned</span> __int8)v1[<span class="number">25</span> * i] + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> nullsub_2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在unk_3020附近有unk_32A0，交叉引用可以看到用它对0x50A0做了修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sigabbrev_np</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// zf</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v6; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v6 = a4 - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v4 &amp;&amp; v6 )</span><br><span class="line">    <span class="keyword">return</span> nullsub_2(a1, a2, a3, v6);</span><br><span class="line">  _enable();</span><br><span class="line">  *(_BYTE *)(v5 - <span class="number">97</span>) = <span class="number">-3</span>;</span><br><span class="line">  *(_WORD *)(v5 - <span class="number">114</span>) = <span class="number">-5399</span>;</span><br><span class="line">  *(_BYTE *)(v5 - <span class="number">112</span>) = <span class="number">-20</span>;</span><br><span class="line">  *(_DWORD *)(v5 - <span class="number">120</span>) = <span class="number">-268633374</span>;</span><br><span class="line">  *(_WORD *)(v5 - <span class="number">116</span>) = <span class="number">-5139</span>;</span><br><span class="line">  *(_DWORD *)(v5 - <span class="number">126</span>) = <span class="number">-268633347</span>;</span><br><span class="line">  *(_WORD *)(v5 - <span class="number">122</span>) = <span class="number">-5139</span>;</span><br><span class="line">  *(_WORD *)(v5 - <span class="number">129</span>) = <span class="number">-5401</span>;</span><br><span class="line">  *(_BYTE *)(v5 - <span class="number">127</span>) = <span class="number">-17</span>;</span><br><span class="line">  <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">4</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">4</span>) &lt;= <span class="number">14</span>; ++*(_DWORD *)(v5 - <span class="number">4</span>) )</span><br><span class="line">    *(_BYTE *)(v5 + *(<span class="type">int</span> *)(v5 - <span class="number">4</span>) - <span class="number">111</span>) ^= <span class="number">0x8E</span>u;</span><br><span class="line">  <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">8</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">8</span>) &lt;= <span class="number">2</span>; ++*(_DWORD *)(v5 - <span class="number">8</span>) )</span><br><span class="line">    *(_BYTE *)(v5 + *(<span class="type">int</span> *)(v5 - <span class="number">8</span>) - <span class="number">114</span>) ^= <span class="number">0x8E</span>u;</span><br><span class="line">  <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">12</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">12</span>) &lt;= <span class="number">5</span>; ++*(_DWORD *)(v5 - <span class="number">12</span>) )</span><br><span class="line">    *(_BYTE *)(v5 + *(<span class="type">int</span> *)(v5 - <span class="number">12</span>) - <span class="number">120</span>) ^= <span class="number">0x8E</span>u;</span><br><span class="line">  <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">16</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">16</span>) &lt;= <span class="number">5</span>; ++*(_DWORD *)(v5 - <span class="number">16</span>) )</span><br><span class="line">    *(_BYTE *)(v5 + *(<span class="type">int</span> *)(v5 - <span class="number">16</span>) - <span class="number">126</span>) ^= <span class="number">0x8E</span>u;</span><br><span class="line">  <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">20</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">20</span>) &lt;= <span class="number">5</span>; ++*(_DWORD *)(v5 - <span class="number">20</span>) )</span><br><span class="line">    *(_BYTE *)(v5 + *(<span class="type">int</span> *)(v5 - <span class="number">20</span>) - <span class="number">129</span>) ^= <span class="number">0x8E</span>u;</span><br><span class="line">  v7 = getppid();</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="type">char</span> *)(v5 - <span class="number">80</span>), <span class="number">0x1E</span>uLL, (<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">111</span>), v7);</span><br><span class="line">  *(_QWORD *)(v5 - <span class="number">32</span>) = fopen((<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">80</span>), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  fgets((<span class="type">char</span> *)(v5 - <span class="number">96</span>), <span class="number">16</span>, *(FILE **)(v5 - <span class="number">32</span>));</span><br><span class="line">  fclose(*(FILE **)(v5 - <span class="number">32</span>));</span><br><span class="line">  result = <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">96</span>), (<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">129</span>))</span><br><span class="line">        || <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">96</span>), (<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">114</span>))</span><br><span class="line">        || <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">96</span>), (<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">120</span>))</span><br><span class="line">        || <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">96</span>), (<span class="type">const</span> <span class="type">char</span> *)(v5 - <span class="number">126</span>));</span><br><span class="line">  *(_DWORD *)(v5 - <span class="number">36</span>) = result;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(v5 - <span class="number">36</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    qmemcpy((<span class="type">void</span> *)(v5 - <span class="number">768</span>), byte_32A0, <span class="number">0x271</span>uLL);</span><br><span class="line">    result = (__int64)&amp;unk_5834 - <span class="number">1940</span>;                <span class="comment">//0x50A0</span></span><br><span class="line">    *(_QWORD *)(v5 - <span class="number">48</span>) = (<span class="type">char</span> *)&amp;unk_5834 - <span class="number">1940</span>;</span><br><span class="line">    <span class="keyword">for</span> ( *(_DWORD *)(v5 - <span class="number">24</span>) = <span class="number">0</span>; *(<span class="type">int</span> *)(v5 - <span class="number">24</span>) &lt;= <span class="number">24</span>; ++*(_DWORD *)(v5 - <span class="number">24</span>) )</span><br><span class="line">      result = (__int64)<span class="built_in">memcpy</span>(</span><br><span class="line">                          (<span class="type">void</span> *)(<span class="number">25</span> * *(_DWORD *)(v5 - <span class="number">24</span>) + *(_QWORD *)(v5 - <span class="number">48</span>)),</span><br><span class="line">                          (<span class="type">const</span> <span class="type">void</span> *)(v5 - <span class="number">768</span> + <span class="number">25LL</span> * *(<span class="type">int</span> *)(v5 - <span class="number">24</span>)),</span><br><span class="line">                          *(<span class="type">unsigned</span> __int8 *)(v5 + <span class="number">25LL</span> * *(<span class="type">int</span> *)(v5 - <span class="number">24</span>) - <span class="number">768</span>) + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正好和主函数里进行验证的数据对上了，所以这两组数据才是真实数据。分析出来是数织游戏，去在线网站解一下就好。</p>
<h2 id="GameMaster"><a href="#GameMaster" class="headerlink" title="GameMaster"></a>GameMaster</h2><p><del>双击游戏，拿20块赢到3700w</del></p>
<p>对gamemessage的两处解密：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">byte</span>[] array = Program.memory;</span><br><span class="line">	<span class="built_in">int</span> num = i;</span><br><span class="line">	array[num] ^= <span class="number">34</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="built_in">byte</span>[] key = <span class="keyword">new</span> <span class="built_in">byte</span>[]&#123;<span class="number">66</span>,<span class="number">114</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">115</span>,<span class="number">116</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">109</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">103</span>,<span class="number">33</span>,<span class="number">33</span>,<span class="number">33</span>&#125;;</span><br><span class="line">ICryptoTransform cryptoTransform = <span class="keyword">new</span> RijndaelManaged</span><br><span class="line">&#123;</span><br><span class="line">	Key = key,</span><br><span class="line">	Mode = CipherMode.ECB,</span><br><span class="line">	Padding = PaddingMode.Zeros</span><br><span class="line">&#125;.CreateDecryptor();</span><br><span class="line">Program.m = cryptoTransform.TransformFinalBlock(Program.memory, <span class="number">0</span>, num);</span><br></pre></td></tr></table></figure>

<p>python解密得到二进制文件，找PE头，前面的全部删掉。<br>得到解密后的文件拖进dnspy读代码，z3解方程照抄逻辑即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">enc = [<span class="number">101</span>,<span class="number">5</span>,<span class="number">80</span>,<span class="number">213</span>,<span class="number">163</span>,<span class="number">26</span>,<span class="number">59</span>,<span class="number">38</span>,<span class="number">19</span>,<span class="number">6</span>,<span class="number">173</span>,<span class="number">189</span>,<span class="number">198</span>,<span class="number">166</span>,<span class="number">140</span>,<span class="number">183</span>,<span class="number">42</span>,<span class="number">247</span>,<span class="number">223</span>,<span class="number">24</span>,<span class="number">106</span>,<span class="number">20</span>,<span class="number">145</span>,<span class="number">37</span>,<span class="number">24</span>,<span class="number">7</span>,<span class="number">22</span>,<span class="number">191</span>,<span class="number">110</span>,<span class="number">179</span>,<span class="number">227</span>,<span class="number">5</span>,<span class="number">62</span>,<span class="number">9</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">65</span>,<span class="number">22</span>,<span class="number">37</span>,<span class="number">5</span>]</span><br><span class="line">num = -<span class="number">1</span></span><br><span class="line">chk = [<span class="number">0</span>]*<span class="number">50</span></span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">x = BitVec(<span class="string">&#x27;x&#x27;</span>,<span class="number">64</span>)</span><br><span class="line">y = BitVec(<span class="string">&#x27;y&#x27;</span>,<span class="number">64</span>)</span><br><span class="line">z = BitVec(<span class="string">&#x27;z&#x27;</span>,<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">	x = (((x &gt;&gt; <span class="number">29</span> ^ x &gt;&gt; <span class="number">28</span> ^ x &gt;&gt; <span class="number">25</span> ^ x &gt;&gt; <span class="number">23</span>) &amp; <span class="number">1</span>) | x &lt;&lt; <span class="number">1</span>)</span><br><span class="line">	y = (((y &gt;&gt; <span class="number">30</span> ^ y &gt;&gt; <span class="number">27</span>) &amp; <span class="number">1</span>) | y &lt;&lt; <span class="number">1</span>)</span><br><span class="line">	z = (((z &gt;&gt; <span class="number">31</span> ^ z &gt;&gt; <span class="number">30</span> ^ z &gt;&gt; <span class="number">29</span> ^ z &gt;&gt; <span class="number">28</span> ^ z &gt;&gt; <span class="number">26</span> ^ z &gt;&gt; <span class="number">24</span>) &amp; <span class="number">1</span>) | z &lt;&lt; <span class="number">1</span>)</span><br><span class="line">	flag = i % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> flag:</span><br><span class="line">		num+=<span class="number">1</span></span><br><span class="line">	chk[num] = ((chk[num] &lt;&lt; <span class="number">1</span>) | ((((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span> &amp; (x &gt;&gt; <span class="number">30</span> &amp; <span class="number">1</span>)) ^ (((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span>) ^ <span class="number">1</span>) &amp; (y &gt;&gt; <span class="number">31</span> &amp; <span class="number">1</span>))))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    s.add(chk[i]==enc[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(s.check() == sat):</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br><span class="line"><span class="comment"># [y = 868387187, x = 156324965, z = 3131229747]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">xor_key = [<span class="number">60</span>,<span class="number">100</span>,<span class="number">36</span>,<span class="number">86</span>,<span class="number">51</span>,<span class="number">251</span>,<span class="number">167</span>,<span class="number">108</span>,<span class="number">116</span>,<span class="number">245</span>,<span class="number">207</span>,<span class="number">223</span>,<span class="number">40</span>,<span class="number">103</span>,<span class="number">34</span>,<span class="number">62</span>,<span class="number">22</span>,<span class="number">251</span>,<span class="number">227</span>]</span><br><span class="line"></span><br><span class="line">y = <span class="number">868387187</span></span><br><span class="line">x = <span class="number">156324965</span></span><br><span class="line">z = <span class="number">3131229747</span></span><br><span class="line"></span><br><span class="line">key = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	key.append(x &amp; <span class="number">0xff</span>)</span><br><span class="line">	x &gt;&gt;= <span class="number">8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	key.append(y &amp; <span class="number">0xff</span>)</span><br><span class="line">	y &gt;&gt;= <span class="number">8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	key.append(z &amp; <span class="number">0xff</span>)</span><br><span class="line">	z &gt;&gt;= <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(xor_key)):</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">chr</span>(key[i%<span class="built_in">len</span>(key)]^xor_key[i]),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="deeprev"><a href="#deeprev" class="headerlink" title="deeprev"></a>deeprev</h2><p>题目思路跟<a target="_blank" rel="noopener" href="https://www.yunzh1jun.com/2022/09/22/GoogleCTF2022-eldar/">googleCTF的eldar</a>一样的，链接是我写的翻译，但是建议读原文。</p>
<p>运行一下，然后去so库里面搜flag，可以搜到一个出题人写好的flag，提示我们应该patch这里。当我们把flag patch成正确的flag，这个程序就会提示win。</p>
<p>用IDA打开deeprev可以看到巨大无比的重定位表，并且这个表是可读可写可执行的。<br>注意一堆0xc3，这是ret的机器码，而0xc3类型都是REL，这就是<code>r.r_offset = r.r_addend</code>（见eldar那篇wp）。</p>
<p><img src="/img/code/chall_photo/deeprev1.png"></p>
<p>找一个连着REL类型的0xc3的机器码反编译一下</p>
<p><img src="/img/code/chall_photo/deeprev2.png"></p>
<p>直接双击<code>stru_8040C4</code>进去按U看看内部结构</p>
<p><img src="/img/code/chall_photo/deeprev3.png"></p>
<p>注意IDA已经注释出来，0x8040cc地址处的数据是<code>Copy of shared data</code>，也就是从so文件里copy过来的flag值，所以这里肯定跟flag关系密切。<br>如果不嫌麻烦愿意直接调试硬啃的话就可以直接在这里下内存断点然后跑程序了，调试就可以发现它不断地copy so库里的flag到这个地址，然后经过一个异或和加的运算，再把密文存到另一处（0x8042BA处），然后再不断copy此处存的密文到0x8040FC处，最后再对这个地址异或一个值。<br>我们当然可以慢慢调试去一个一个记录这些值，不过这样还是 <del>太印度人了</del> 太麻烦了，所以可以思考选择一些工具。</p>
<p>首先经过调试可以发现，关键代码都在ret前面（也就是0xc3），那么就可以以这一条为依据来筛选我们需要的<code>r.r_addend</code>值，然后输出这些值的反汇编代码。<br>可以先<code>readelf -r deeprev &gt; rel.txt</code>大概看一下重定位表，只有1.2k+行是有意义的，后面都是0，所以写代码的时候也不用遍历整个重定位表，这样会很慢，遍历到1300的时候就可以了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line">b = lief.ELF.parse(<span class="string">&#x27;./deeprev&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">b</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    relocs = <span class="built_in">list</span>(b.relocations)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">1300</span>):</span><br><span class="line">        r = relocs[i]</span><br><span class="line">        <span class="keyword">if</span> r.<span class="built_in">type</span> == <span class="number">8</span>: <span class="comment">#筛选REL类型的重定位信息</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">hex</span>(r.addend), end=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parse(b)</span><br></pre></td></tr></table></figure>

<p>打印出来的值可以直接反汇编，我这里手动去掉了一些0。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># r.r_addend被lief解析为signed，所以pack可能会报错out of range（因为变成了负数）</span></span><br><span class="line"><span class="comment"># 写一个函数转换一下负数即可</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yun</span>(<span class="params">i</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        i += <span class="number">0x10000000000000000</span></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">lst = [<span class="number">0x404040</span>,<span class="number">0x1</span>,<span class="number">0x16008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x804332</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x80440a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404041</span>,<span class="number">0x17008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80452a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x1008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x804602</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404042</span>,<span class="number">0x10008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x804722</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x2008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8047fa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404043</span>,<span class="number">0x12008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80491a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x3008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8049f2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404044</span>,<span class="number">0x10008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x804b12</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x4008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x804bea</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404045</span>,<span class="number">0x11008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x804d0a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x5008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x804de2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404046</span>,<span class="number">0x12008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x804f02</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x6008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x804fda</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404047</span>,<span class="number">0x13008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8050fa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x7008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8051d2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404048</span>,<span class="number">0x14008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8052f2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8053ca</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404049</span>,<span class="number">0x15008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8054ea</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x9008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8055c2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404a</span>,<span class="number">0x16008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8056e2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xa008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8057ba</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404b</span>,<span class="number">0x17008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8058da</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xb008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x8059b2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404c</span>,<span class="number">0x18008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x805ad2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xc008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x805baa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404d</span>,<span class="number">0x19008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x805cca</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xd008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x805da2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404e</span>,<span class="number">0x24008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x805ec2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xe008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x805f9a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40404f</span>,<span class="number">0x2c008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8060ba</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0xf008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806192</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404050</span>,<span class="number">0x26008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8062b2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x10008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x80638a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404051</span>,<span class="number">0x1e008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8064aa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x11008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806582</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404052</span>,<span class="number">0x1f008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8066a2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x12008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x80677a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404053</span>,<span class="number">0x20008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80689a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x13008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806972</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404054</span>,<span class="number">0x20008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x806a92</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x14008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806b6a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404055</span>,<span class="number">0x21008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x806c8a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x15008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806d62</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404056</span>,<span class="number">0x23008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x806e82</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x16008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x806f5a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404057</span>,<span class="number">0x27008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80707a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x17008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x807152</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404058</span>,<span class="number">0x24008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807272</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x18008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x80734a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x404059</span>,<span class="number">0x25008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80746a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x19008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x807542</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40405a</span>,<span class="number">0x26008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807662</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x1a008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x80773a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x40405b</span>,<span class="number">0x27008040cc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80785a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x1b008040cc250480</span>,<span class="number">0xc3</span>,<span class="number">0x807932</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0x8040cc</span>,<span class="number">0x1</span>,<span class="number">0x8042ba</span>,<span class="number">0x8</span>,<span class="number">0x70008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807ab2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042bb</span>,<span class="number">0x7c008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807c4a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042bc</span>,<span class="number">0x73008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807de2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042bd</span>,<span class="number">0x78008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x807f7a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042be</span>,<span class="number">0x6f008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808112</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042bf</span>,<span class="number">0x27008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8082aa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c0</span>,<span class="number">0x2a008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808442</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c1</span>,<span class="number">0x2c008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8085da</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c2</span>,<span class="number">0x7f008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808772</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c3</span>,<span class="number">0x35008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80890a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c4</span>,<span class="number">0x2d008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808aa2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c5</span>,<span class="number">0x32008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808c3a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c6</span>,<span class="number">0x37008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808dd2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c7</span>,<span class="number">0x3b008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x808f6a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c8</span>,<span class="number">0x22008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809102</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042c9</span>,<span class="number">0x59008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80929a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042ca</span>,<span class="number">0x53008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809432</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042cb</span>,-<span class="number">0x71ff7fbf03dacb80</span>,<span class="number">0xc3</span>,<span class="number">0x8095ca</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042cc</span>,<span class="number">0x3d008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809762</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042cd</span>,<span class="number">0x2a008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x8098fa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042ce</span>,<span class="number">0x59008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809a92</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042cf</span>,<span class="number">0x27008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809c2a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d0</span>,<span class="number">0x2d008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809dc2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d1</span>,<span class="number">0x29008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x809f5a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d2</span>,<span class="number">0x34008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80a0f2</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d3</span>,<span class="number">0x2d008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80a28a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d4</span>,<span class="number">0x61008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80a422</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x8042d5</span>,<span class="number">0x32008040fc253480</span>,<span class="number">0xc3</span>,<span class="number">0x80a5ba</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x8040fc</span>,<span class="number">0x8</span>,<span class="number">0x40405c</span>,<span class="number">0x40405d</span>,<span class="number">0x80412c</span>,<span class="number">0x8040fc</span>,<span class="number">0x804144</span>,<span class="number">0x804114</span>,<span class="number">0x804144</span>,<span class="number">0x6c0080415c253480</span>,<span class="number">0xc3</span>,<span class="number">0x80a992</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x80415c</span>,<span class="number">0x8</span>,<span class="number">0x40405c</span>,<span class="number">0x40405d</span>,<span class="number">0x80412c</span>,<span class="number">0x8040fc</span>,<span class="number">0x80412c</span>,<span class="number">0x804144</span>,<span class="number">0x804114</span>,<span class="number">0x804144</span>,-<span class="number">0x5eff7fbea3dacb80</span>,<span class="number">0xc3</span>,<span class="number">0x80ae2a</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x80415c</span>,<span class="number">0x8</span>,<span class="number">0x40405e</span>,<span class="number">0x40405f</span>,<span class="number">0x80412c</span>,<span class="number">0x8040fc</span>,<span class="number">0x804144</span>,<span class="number">0x804114</span>,<span class="number">0x804144</span>,-<span class="number">0x4eff7fbea3dacb80</span>,<span class="number">0xc3</span>,<span class="number">0x80b262</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x80415c</span>,<span class="number">0x8</span>,<span class="number">0x40405e</span>,<span class="number">0x40405f</span>,<span class="number">0x80412c</span>,<span class="number">0x8040fc</span>,<span class="number">0x80412c</span>,<span class="number">0x804144</span>,<span class="number">0x804114</span>,<span class="number">0x804144</span>,-<span class="number">0x1aff7fbea3dacb80</span>,<span class="number">0xc3</span>,<span class="number">0x80b6fa</span>,<span class="number">0x1000a0000001a</span>,<span class="number">0xa53f62</span>,<span class="number">0x18</span>,<span class="number">0x80415c</span>,<span class="number">0x8</span>,<span class="number">0x8040e4</span>,<span class="number">0x1</span>]</span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lst)):</span><br><span class="line">    <span class="keyword">if</span> lst[j] == <span class="number">0xc3</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            CODE = pack(<span class="string">&#x27;&lt;Q&#x27;</span>,lst[j-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            t = yun(lst[j-<span class="number">1</span>])</span><br><span class="line">            CODE = pack(<span class="string">&#x27;&lt;Q&#x27;</span>, t)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(CODE, <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s\t%s&quot;</span> %(i.mnemonic, i.op_str))</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">xor	byte ptr [0x8040cc], 0x16</span><br><span class="line">add	byte ptr [0x8040cc], 0</span><br><span class="line">xor	byte ptr [0x8040cc], 0x17</span><br><span class="line">add	byte ptr [0x8040cc], 1</span><br><span class="line">xor	byte ptr [0x8040cc], 0x10</span><br><span class="line">add	byte ptr [0x8040cc], 2</span><br><span class="line">xor	byte ptr [0x8040cc], 0x12</span><br><span class="line">add	byte ptr [0x8040cc], 3</span><br><span class="line">xor	byte ptr [0x8040cc], 0x10</span><br><span class="line">add	byte ptr [0x8040cc], 4</span><br><span class="line">xor	byte ptr [0x8040cc], 0x11</span><br><span class="line">add	byte ptr [0x8040cc], 5</span><br><span class="line">xor	byte ptr [0x8040cc], 0x12</span><br><span class="line">add	byte ptr [0x8040cc], 6</span><br><span class="line">xor	byte ptr [0x8040cc], 0x13</span><br><span class="line">add	byte ptr [0x8040cc], 7</span><br><span class="line">xor	byte ptr [0x8040cc], 0x14</span><br><span class="line">add	byte ptr [0x8040cc], 8</span><br><span class="line">xor	byte ptr [0x8040cc], 0x15</span><br><span class="line">add	byte ptr [0x8040cc], 9</span><br><span class="line">xor	byte ptr [0x8040cc], 0x16</span><br><span class="line">add	byte ptr [0x8040cc], 0xa</span><br><span class="line">xor	byte ptr [0x8040cc], 0x17</span><br><span class="line">add	byte ptr [0x8040cc], 0xb</span><br><span class="line">xor	byte ptr [0x8040cc], 0x18</span><br><span class="line">add	byte ptr [0x8040cc], 0xc</span><br><span class="line">xor	byte ptr [0x8040cc], 0x19</span><br><span class="line">add	byte ptr [0x8040cc], 0xd</span><br><span class="line">xor	byte ptr [0x8040cc], 0x24</span><br><span class="line">add	byte ptr [0x8040cc], 0xe</span><br><span class="line">xor	byte ptr [0x8040cc], 0x2c</span><br><span class="line">add	byte ptr [0x8040cc], 0xf</span><br><span class="line">xor	byte ptr [0x8040cc], 0x26</span><br><span class="line">add	byte ptr [0x8040cc], 0x10</span><br><span class="line">xor	byte ptr [0x8040cc], 0x1e</span><br><span class="line">add	byte ptr [0x8040cc], 0x11</span><br><span class="line">xor	byte ptr [0x8040cc], 0x1f</span><br><span class="line">add	byte ptr [0x8040cc], 0x12</span><br><span class="line">xor	byte ptr [0x8040cc], 0x20</span><br><span class="line">add	byte ptr [0x8040cc], 0x13</span><br><span class="line">xor	byte ptr [0x8040cc], 0x20</span><br><span class="line">add	byte ptr [0x8040cc], 0x14</span><br><span class="line">xor	byte ptr [0x8040cc], 0x21</span><br><span class="line">add	byte ptr [0x8040cc], 0x15</span><br><span class="line">xor	byte ptr [0x8040cc], 0x23</span><br><span class="line">add	byte ptr [0x8040cc], 0x16</span><br><span class="line">xor	byte ptr [0x8040cc], 0x27</span><br><span class="line">add	byte ptr [0x8040cc], 0x17</span><br><span class="line">xor	byte ptr [0x8040cc], 0x24</span><br><span class="line">add	byte ptr [0x8040cc], 0x18</span><br><span class="line">xor	byte ptr [0x8040cc], 0x25</span><br><span class="line">add	byte ptr [0x8040cc], 0x19</span><br><span class="line">xor	byte ptr [0x8040cc], 0x26</span><br><span class="line">add	byte ptr [0x8040cc], 0x1a</span><br><span class="line">xor	byte ptr [0x8040cc], 0x27</span><br><span class="line">add	byte ptr [0x8040cc], 0x1b</span><br><span class="line">xor	byte ptr [0x8040fc], 0x70</span><br><span class="line">xor	byte ptr [0x8040fc], 0x7c</span><br><span class="line">xor	byte ptr [0x8040fc], 0x73</span><br><span class="line">xor	byte ptr [0x8040fc], 0x78</span><br><span class="line">xor	byte ptr [0x8040fc], 0x6f</span><br><span class="line">xor	byte ptr [0x8040fc], 0x27</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2a</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2c</span><br><span class="line">xor	byte ptr [0x8040fc], 0x7f</span><br><span class="line">xor	byte ptr [0x8040fc], 0x35</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2d</span><br><span class="line">xor	byte ptr [0x8040fc], 0x32</span><br><span class="line">xor	byte ptr [0x8040fc], 0x37</span><br><span class="line">xor	byte ptr [0x8040fc], 0x3b</span><br><span class="line">xor	byte ptr [0x8040fc], 0x22</span><br><span class="line">xor	byte ptr [0x8040fc], 0x59</span><br><span class="line">xor	byte ptr [0x8040fc], 0x53</span><br><span class="line">xor	byte ptr [0x8040fc], 0x8e</span><br><span class="line">xor	byte ptr [0x8040fc], 0x3d</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2a</span><br><span class="line">xor	byte ptr [0x8040fc], 0x59</span><br><span class="line">xor	byte ptr [0x8040fc], 0x27</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2d</span><br><span class="line">xor	byte ptr [0x8040fc], 0x29</span><br><span class="line">xor	byte ptr [0x8040fc], 0x34</span><br><span class="line">xor	byte ptr [0x8040fc], 0x2d</span><br><span class="line">xor	byte ptr [0x8040fc], 0x61</span><br><span class="line">xor	byte ptr [0x8040fc], 0x32</span><br><span class="line">xor	byte ptr [0x80415c], 0x6c</span><br><span class="line">xor	byte ptr [0x80415c], 0xa1</span><br><span class="line">xor	byte ptr [0x80415c], 0xb1</span><br><span class="line">xor	byte ptr [0x80415c], 0xe5</span><br></pre></td></tr></table></figure>

<p>提取值手搓解密即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xor1 = [<span class="number">0x16</span>, <span class="number">0x17</span>, <span class="number">0x10</span>, <span class="number">0x12</span>, <span class="number">0x10</span>, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0x13</span>, <span class="number">0x14</span>, <span class="number">0x15</span>, <span class="number">0x16</span>, <span class="number">0x17</span>, <span class="number">0x18</span>, <span class="number">0x19</span>, <span class="number">0x24</span>, <span class="number">0x2c</span>, <span class="number">0x26</span>, <span class="number">0x1e</span>, <span class="number">0x1f</span>, <span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x21</span>, <span class="number">0x23</span>, <span class="number">0x27</span>, <span class="number">0x24</span>, <span class="number">0x25</span>, <span class="number">0x26</span>, <span class="number">0x27</span>]</span><br><span class="line">xor2 = [<span class="number">0x70</span>, <span class="number">0x7c</span>, <span class="number">0x73</span>, <span class="number">0x78</span>, <span class="number">0x6f</span>, <span class="number">0x27</span>, <span class="number">0x2a</span>, <span class="number">0x2c</span>, <span class="number">0x7f</span>, <span class="number">0x35</span>, <span class="number">0x2d</span>, <span class="number">0x32</span>, <span class="number">0x37</span>, <span class="number">0x3b</span>, <span class="number">0x22</span>, <span class="number">0x59</span>, <span class="number">0x53</span>, <span class="number">0x8e</span>, <span class="number">0x3d</span>, <span class="number">0x2a</span>, <span class="number">0x59</span>, <span class="number">0x27</span>, <span class="number">0x2d</span>, <span class="number">0x29</span>, <span class="number">0x34</span>, <span class="number">0x2d</span>, <span class="number">0x61</span>, <span class="number">0x32</span>]</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(xor1)):</span><br><span class="line">    flag += <span class="built_in">chr</span>((xor2[i]-i)^xor1[i])</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment">#flag&#123;366c950370fec47e34581a0</span></span><br></pre></td></tr></table></figure>

<p>注意上面输出的最后4句汇编不再是对0x8040fc处的异或，而是在0x80415c处进行异或，所以后4位flag显然是换了验证方式。</p>
<p>对0x80415c下硬件断点可以发现，其逻辑就是两个一组的二元方程，自己解或者z3解均可……</p>
<p>不过比赛的时候给了flag的SHA256值，所以也可以直接爆破。</p>
<p>当然了，毕竟flag只剩最后4位（实际上是3位，因为最后一位一定是<code>&#125;</code>），再去看这个逻辑属实有点麻烦。所以<del>对于我这么一个爆破走天下的人来说</del>当然还是直接爆破方便一些。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">fr = <span class="built_in">open</span>(<span class="string">&quot;libsecret.so&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">f = fr.read()</span><br><span class="line">fr.close()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> itertools.product(<span class="string">&#x27;1234567890abcedf&#x27;</span>,repeat = <span class="number">3</span>):</span><br><span class="line">	s = i[<span class="number">0</span>] + i[<span class="number">1</span>] + i[<span class="number">2</span>]</span><br><span class="line">	fw = <span class="built_in">open</span>(<span class="string">&quot;libsecret.so&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">	fw.write(f[:<span class="number">0x305c</span>] + s.encode() + f[<span class="number">0x305f</span>:])</span><br><span class="line">	out = subprocess.check_output([<span class="string">&quot;./deeprev&quot;</span>])</span><br><span class="line">	<span class="keyword">if</span> <span class="string">b&#x27;Fail&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> out:</span><br><span class="line">		<span class="built_in">print</span>(s)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"><span class="comment">#574</span></span><br></pre></td></tr></table></figure>

<p><code>flag&#123;366c950370fec47e34581a0574&#125;</code></p>
<p>下面是逆向分享会的文档</p>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>ELF动态重定位条目的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr      r_offset;</span><br><span class="line">    Elf64_Xword     r_info;</span><br><span class="line">    Elf64_Sxword    r_addend;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p>info包括一个type和symble(可选)索引：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM(info)             ((info)&gt;&gt;32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE(info)            ((Elf64_Word)(info))</span></span><br></pre></td></tr></table></figure>

<p>动态符号表条目的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Word      st_name;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_info;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   st_other;</span><br><span class="line">    Elf64_Half      st_shndx;</span><br><span class="line">    Elf64_Addr      st_value;</span><br><span class="line">    Elf64_Xword     st_size;</span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure>

<p>本题使用了以下重定位信息：</p>
<h4 id="REL-type-8"><a href="#REL-type-8" class="headerlink" title="REL(type 8)"></a>REL(type 8)</h4><p>将重定位信息设置为一个相对基址的值（但是基址始终为0）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = r.r_addend;</span><br></pre></td></tr></table></figure>

<p>立即数寻址：<code>mov *0xbeef0000, $0x04</code><br>写成重定位条目就是<code>&#123;type=RELATIVE, offset=0xbeef0000,symbol=0,addend=0x04&#125;</code><br>在IDA中显示为<code>Elf64_Rela &lt;beef0000h, 8, 4h&gt;</code></p>
<h4 id="CPY-type-5"><a href="#CPY-type-5" class="headerlink" title="CPY(type 5)"></a>CPY(type 5)</h4><p>从符号地址复制n字节到重定位地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Elf64_Sym sym = symbols[ELF64_R_SYM(r.r_info)];</span><br><span class="line"><span class="built_in">memcpy</span>(r.r_offset, sym.st_value, sym.st_size);</span><br></pre></td></tr></table></figure>

<p>立即数寻址：<code>mov *0xbeef0000, [%foo]</code><br><code>&#123;type=COPY, offset=0xbeef0000,symbol=foo,addend=0&#125;</code><br><code>Elf64_Rela &lt;beef0000h, ?00000005, 0&gt;</code><br>复制foo指向的n个字节到0xbeef0000，n是foo的st_size。</p>
<h4 id="R64-type-1"><a href="#R64-type-1" class="headerlink" title="R64(type 1)"></a>R64(type 1)</h4><p>将重定位信息设置为 符号值+常数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">uint64_t</span> *)r.r_offset = symbols[ELF64_R_SYM(r.r_info)] + r.r_addend;</span><br></pre></td></tr></table></figure>

<h3 id="怎么做？"><a href="#怎么做？" class="headerlink" title="怎么做？"></a>怎么做？</h3><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p>当我们对这些数据具体如何填充并不清楚的时候，最好的办法当然是让链接器来帮我们做这些事情。我们只需要下断点调试，去找数据的加密逻辑就可以了。<br>对于这个题而言，调试就可以发现它不断地copy so库里的flag到这个地址，然后经过一个异或和加的运算，再把密文存到另一处（0x8042BA处），然后再不断copy此处存的密文到0x8040FC处，最后再对这个地址异或一个值。</p>
<p>不过其实可以发现，这个题虽然对单个字符串的加密数据不同，但大部分代码是复用的。一个典型的表现就是每次复制数据、异或、加之后，都会有一个ret。所以我们可以认为ret前就是用于加密的关键代码，其他地方是一些对逆向价值不高的代码。<br>那么就可以写一个脚本来解析这些数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line">b = lief.ELF.parse(<span class="string">&#x27;./deeprev&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">b</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    relocs = <span class="built_in">list</span>(b.relocations)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">1300</span>):</span><br><span class="line">        r = relocs[i]</span><br><span class="line">        <span class="keyword">if</span> r.<span class="built_in">type</span> == <span class="number">8</span>: <span class="comment">#筛选REL类型的重定位信息</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">hex</span>(r.addend), end=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parse(b)</span><br></pre></td></tr></table></figure>

<p>这个脚本输出了所有REL类型的重定位信息的addend值，其中可能会有一些值不是我们需要的，但是不用管。<br>后续反编译的时候，capstone遇到无法反编译的数据就会直接跳过。</p>
<p>然后写一个脚本，筛选ret之前的值反汇编：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># r.r_addend被lief解析为signed，所以pack可能会报错out of range（因为变成了负数）</span></span><br><span class="line"><span class="comment"># 写一个函数转换一下负数即可</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yun</span>(<span class="params">i</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">        i += <span class="number">0x10000000000000000</span></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">lst = [...]</span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lst)):</span><br><span class="line">    <span class="keyword">if</span> lst[j] == <span class="number">0xc3</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            CODE = pack(<span class="string">&#x27;&lt;Q&#x27;</span>,lst[j-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            t = yun(lst[j-<span class="number">1</span>])</span><br><span class="line">            CODE = pack(<span class="string">&#x27;&lt;Q&#x27;</span>, t)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(CODE, <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s\t%s&quot;</span> %(i.mnemonic, i.op_str))</span><br></pre></td></tr></table></figure>

<h4 id="自己写一个解析脚本"><a href="#自己写一个解析脚本" class="headerlink" title="自己写一个解析脚本"></a>自己写一个解析脚本</h4><p>推荐阅读：<br><a target="_blank" rel="noopener" href="https://ctf.harrisongreen.me/2022/googlectf/eldar/">googlectf2022 eldar WP</a></p>
<p>顺便一提：eldar这个题是<strong>真正实现了使用元数据来隐藏代码逻辑的。</strong><br>deeprev这个题更像是直接把机器码放在了重定位表里，所以上面那种偷懒的解析方法（直接dump重定位表的数据来反编译）才能奏效。<br>eldar里的重定位表是没有depprev那样的长数据机器码的，所以基本只能硬调，或者像上面这个大佬一样自己写脚本解析。</p>

    </div>

    <div class="about">
        <h1>关于本文</h1>
        <p>本文作者 云之君, 许可由 <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>

    
        
    
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/CTF" class="item">CTF</a>
                
                <a href="/Learn" class="item">Learn</a>
                
                <a href="/Dairy" class="item">Dairy</a>
                
                <a href="/Alkaid" class="item">Alkaid</a>
                
                <a href="/friends" class="item">Friends</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/YunZh1Jun" class="item">GitHub</a>
                
                <a href="mailto:yunzh1jun@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2022 云之君<br >驱动由 <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
    </body>
</html>