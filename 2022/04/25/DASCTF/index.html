<!DOCTYPE html>
<html lang="zh-cn">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>DASCTF 复现 - 云之君&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/img/fav/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

  
<meta name="generator" content="Hexo 5.4.2"></head>
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">云之君&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">主页</a>
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Learn">Learn</a>
            
            
            
            <a class="nav-item" href="/Diary">Diary</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/YunZh1Jun" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            <span>April</span>
            
            
            
            
            
            
            
            
            
            <span>25,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">DASCTF 复现</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>一月一度，DASCTF！</p>
<span id="more"></span>

<h2 id="SU-三月春季挑战赛"><a href="#SU-三月春季挑战赛" class="headerlink" title="SU 三月春季挑战赛"></a>SU 三月春季挑战赛</h2><h3 id="easyre"><a href="#easyre" class="headerlink" title="easyre"></a>easyre</h3><p><del>脚本不贴了，都是抄IDA代码，懒得改那一坨很丑的代码了</del><br>简单说一下我遇到的问题：<br>1.我刚开始手动脱壳的，虽然跑不了，但是IDA可以反编译出来。后来去网上搜了搜，大部分都是脱壳机……我下了好几个脱壳机，都说没有ASPack，很迷。<del>有没有带师有什么很nb的脱壳机，请务必告诉我</del><br>2.加密是用的一个魔改的RC4，代码逻辑是什么不管，直接复制IDA代码，简单改一下然后跑。按道理来讲这种RC4不应该管他的逻辑，直接输入然后动调取值来异或，但是我手动脱的壳可能有些问题，（看别人说要用一个工具修复导入表，但是我摆弄了半天那个程序，没搞懂怎么玩的），跑不了所以没法动调。OD调试也8太会，输入之后直接退出了，麻。<br>3.刚开始跑出来是乱码，因为我最开始改的python，都用的range函数，改成C为了方便都用了while循环，结果我把计数器自增的代码写到最前面了，我是什么憨批。<br>3.改完之后跑是能跑出来了，但是中间有几个字符是乱码。虽然已经半夜两点多，但是不知道原因我是真！的！难！受！啊！！！网上找了份WP，两个代码一起调，发现是数据类型的锅。RC4里s盒正常人都用的unsigned char类型，我写脚本也顺手写成无符号字符型了，但是由于这个题是魔改，对s盒运算的时候有一些奇怪的运算，要用int才能保证运算结果的正确性，unsigned char会溢出而损失部分运算结果……我!#%^@$@^*#</p>
<h3 id="login"><a href="#login" class="headerlink" title="login"></a>login</h3><p>仍是按照<a target="_blank" rel="noopener" href="https://ppppz.net/2022/04/04/DASCTF2022-X-SU-login/">PZ师傅的WP复现</a></p>
<p>这里只记录一些我想的跟PZ师傅不同或者PZ师傅没写的</p>
<h4 id="端口反调试"><a href="#端口反调试" class="headerlink" title="端口反调试"></a>端口反调试</h4><p>确定调试端口是通过<code>serv_addr.sin_port = sub_454A60(dword_4DA120);</code>，其中sub_454A60什么也没干，而dword_4DA120是1234。对这个数字查找交叉引用可以找到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_401D95</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)(dword_4DA120 + <span class="number">22712</span>);</span><br><span class="line">  dword_4DA120 += <span class="number">22712</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对这个函数查找交叉引用是找不到的。那么这个函数到底在哪里被调用？去找找init函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall _libc_csu_init(<span class="type">unsigned</span> <span class="type">int</span> a1, __int64 a2, __int64 a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">signed</span> __int64 v5; <span class="comment">// r14</span></span><br><span class="line">  __int64 i; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  result = init_proc();</span><br><span class="line">  v5 = ((<span class="type">char</span> *)&amp;off_4D6F90 - (<span class="type">char</span> *)&amp;off_4D6F78) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != v5; ++i )</span><br><span class="line">      result = ((__int64 (__fastcall *)(_QWORD, __int64, __int64))*(&amp;off_4D6F78 + i))(a1, a2, a3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是把off_4D6F78开头的一个数组作为函数依次调用。一共调用了3个函数，其中第2个函数在地址401D95处，这个就是用于反调试的函数地址。</p>
<blockquote>
<p>关于为什么研究这个问题，因为我在复现的时候，IDA将地址401D94识别成了此函数的起始地址，导致这个函数反编译不出来，所以dword_4DA120的交叉引用也找不到。后来去查了一下init调用的函数表，发现是IDA识别的起始地址有问题，自己手动改一下即可。</p>
</blockquote>
<h4 id="如何识别RSA算法"><a href="#如何识别RSA算法" class="headerlink" title="如何识别RSA算法"></a>如何识别RSA算法</h4><p>拿到程序发现一个符号都没有，抠得干干净净……于是先finger一把梭了</p>
<p>识别出来的RSA函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">RSA</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  _BOOL8 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> n[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-310h] BYREF</span></span><br><span class="line">  <span class="type">char</span> c[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-300h] BYREF</span></span><br><span class="line">  <span class="type">char</span> e[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-2F0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> plain[<span class="number">26</span>]; <span class="comment">// [rsp+40h] [rbp-2E0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">6</span>]; <span class="comment">// [rsp+5Ah] [rbp-2C6h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">64</span>]; <span class="comment">// [rsp+60h] [rbp-2C0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">632</span>]; <span class="comment">// [rsp+A0h] [rbp-280h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+318h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(</span><br><span class="line">    v9,</span><br><span class="line">    <span class="string">&quot;13123058934861171416713230498081453101147538789122070079961388806126697916963123413431108069961369055630747412550900&quot;</span></span><br><span class="line">    <span class="string">&quot;23940271082784791796087035865396294828238135174112188452839936976453044650993624026229024830522655211710058472661625&quot;</span></span><br><span class="line">    <span class="string">&quot;52929639711415105186785526790332203152463777462705158539879031845129488013974521045545898037256190760663399689993089&quot;</span></span><br><span class="line">    <span class="string">&quot;10127885089547678968793196148780382182445270838659078189316664538631875879022325427220682805580410213245364855569367&quot;</span></span><br><span class="line">    <span class="string">&quot;70291915788136708567728312473287462156937990127266216202578060866957754654833327476605875578644949127700234991859897&quot;</span></span><br><span class="line">    <span class="string">&quot;1841605936268030140638579388226573929&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v8, <span class="string">&quot;By reading we enrich the mind, by conversation we polish it.&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v7, <span class="string">&quot;10001&quot;</span>);</span><br><span class="line">  char_to_int(n, v9, <span class="number">10LL</span>);</span><br><span class="line">  v1 = sub_4057A9((__int64)v8);</span><br><span class="line">  char_to_int(c, v1, <span class="number">16LL</span>);</span><br><span class="line">  char_to_int(e, v7, <span class="number">16LL</span>);</span><br><span class="line">  char_to_int(plain, a1, <span class="number">10LL</span>);</span><br><span class="line">  _gmpz_powm(plain, plain, e, n);</span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)_gmpz_cmp(plain, c) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) != v10 )</span><br><span class="line">    sub_55CC60();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_gmpz_powm</code>和<code>_gmpz_cmp</code>都是finger识别出来的函数名，通过函数名就可以知道这两个函数的功能了。</p>
<h2 id="Apr-X-FATE"><a href="#Apr-X-FATE" class="headerlink" title="Apr X FATE"></a>Apr X FATE</h2><h3 id="Crackme"><a href="#Crackme" class="headerlink" title="Crackme"></a>Crackme</h3><p><del>为什么我看图标第一反应是C#，离谱</del><br>好吧，最后看题解发现是MFC写的……<br><del>我感觉这玩意已经在某道题给我留下了难以磨灭的心理阴影</del></p>
<p>先跑一下，随便输个key和flag，弹窗报wrong，那么去IDA里搜字符串wrong，定位到常量段，刚好下面是success。<br>去查交叉引用，定位到主要加密逻辑处：<br>（主要变量和函数我已经修改名称）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">sub_1831E0</span><span class="params">(<span class="type">int</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len_key; <span class="comment">// [esp+18h] [ebp-230h]</span></span><br><span class="line">  <span class="type">size_t</span> len_flag; <span class="comment">// [esp+20h] [ebp-228h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *Buf1; <span class="comment">// [esp+24h] [ebp-224h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *v8; <span class="comment">// [esp+28h] [ebp-220h] BYREF</span></span><br><span class="line">  BYTE *v9; <span class="comment">// [esp+2Ch] [ebp-21Ch] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> dwDataLen; <span class="comment">// [esp+30h] [ebp-218h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> v11; <span class="comment">// [esp+34h] [ebp-214h] BYREF</span></span><br><span class="line">  DWORD v12; <span class="comment">// [esp+38h] [ebp-210h] BYREF</span></span><br><span class="line">  BYTE flag[<span class="number">260</span>]; <span class="comment">// [esp+3Ch] [ebp-20Ch] BYREF</span></span><br><span class="line">  BYTE key[<span class="number">260</span>]; <span class="comment">// [esp+140h] [ebp-108h] BYREF</span></span><br><span class="line"></span><br><span class="line">  CWnd::<span class="built_in">UpdateData</span>((CWnd *)<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memset</span>(key, <span class="number">0</span>, <span class="built_in">sizeof</span>(key));</span><br><span class="line">  <span class="built_in">memset</span>(flag, <span class="number">0</span>, <span class="built_in">sizeof</span>(flag));</span><br><span class="line">  len_key = <span class="built_in">sub_183E70</span>((<span class="type">void</span> *)(<span class="keyword">this</span> + <span class="number">216</span>));</span><br><span class="line">  len_flag = <span class="built_in">sub_183E70</span>((<span class="type">void</span> *)(<span class="keyword">this</span> + <span class="number">212</span>));</span><br><span class="line">  dwDataLen = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v1 = (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">sub_182590</span>(len_key);</span><br><span class="line">  <span class="built_in">memmove</span>(key, v1, len_key);</span><br><span class="line">  v2 = (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">sub_182590</span>(len_flag);</span><br><span class="line">  <span class="built_in">memmove</span>(flag, v2, len_flag);</span><br><span class="line">  <span class="keyword">if</span> ( len_key != <span class="number">8</span> &amp;&amp; len_flag != <span class="number">32</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">print_wrong</span>((CWnd *)<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">enc</span>(key, len_key &gt;&gt; <span class="number">1</span>, <span class="number">0x8003</span>u, (<span class="type">int</span>)&amp;Buf1, (<span class="type">int</span>)&amp;dwDataLen);</span><br><span class="line">  <span class="built_in">enc</span>(&amp;key[<span class="number">4</span>], len_key &gt;&gt; <span class="number">1</span>, <span class="number">0x8004</span>u, (<span class="type">int</span>)&amp;v8, (<span class="type">int</span>)&amp;v11);</span><br><span class="line">  <span class="built_in">enc</span>(key, len_key, <span class="number">0x8003</span>u, (<span class="type">int</span>)&amp;v9, (<span class="type">int</span>)&amp;v12);</span><br><span class="line">  <span class="built_in">memcmp</span>(Buf1, (<span class="type">const</span> <span class="type">void</span> *)(<span class="keyword">this</span> + <span class="number">220</span>), dwDataLen);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(v8, (<span class="type">const</span> <span class="type">void</span> *)(<span class="keyword">this</span> + <span class="number">480</span>), v11) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">print_wrong</span>((CWnd *)<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">sub_1836E0</span>(v9, v12, flag, &amp;len_flag, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(flag, (<span class="type">const</span> <span class="type">void</span> *)(<span class="keyword">this</span> + <span class="number">740</span>), len_flag) )</span><br><span class="line">    result = <span class="built_in">print_success</span>((CWnd *)<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">print_wrong</span>((CWnd *)<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>29行指明key和flag的长度分别为8和32，随后31~33行的三个enc函数分别对<code>key[:4]</code>、<code>key[4:]</code>、整个key进行加密，结果分别存储在<code>dwDataLen</code>、<code>v11</code>、<code>v12</code>中。<br>34~35行将<code>dwDataLen</code>、<code>v11</code>中的值与this指针里的两段值<code>(this + 220)</code>和<code>(this + 480)</code>进行比较，错误就报wrong，表示key输入错误。<br>37行将<code>v12</code>（也就是对整个key加密的结果）和flag用函数<code>sub_1836E0</code>加密，38行将结果与<code>(this + 740)</code>比较，正确则报success。</p>
<p>那么整个思路就是动调去取this指针里用来比较的4段值，然后分析enc函数，逆向得到key。<br>再去逆向分析<code>sub_1836E0</code>，逆向得到flag。</p>
<p>先看enc函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __stdcall <span class="title">enc</span><span class="params">(BYTE *pbData, DWORD dwDataLen, ALG_ID Algid, <span class="type">int</span> a4, <span class="type">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BYTE *v6; <span class="comment">// [esp+10h] [ebp-20h]</span></span><br><span class="line">  BOOL v7; <span class="comment">// [esp+18h] [ebp-18h]</span></span><br><span class="line">  BYTE v8[<span class="number">4</span>]; <span class="comment">// [esp+1Ch] [ebp-14h] BYREF</span></span><br><span class="line">  DWORD pdwDataLen; <span class="comment">// [esp+20h] [ebp-10h] BYREF</span></span><br><span class="line">  HCRYPTPROV phProv; <span class="comment">// [esp+24h] [ebp-Ch] BYREF</span></span><br><span class="line">  HCRYPTHASH phHash; <span class="comment">// [esp+28h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  phProv = <span class="number">0</span>;</span><br><span class="line">  phHash = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)v8 = <span class="number">0</span>;</span><br><span class="line">  pdwDataLen = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="built_in">CryptAcquireContextA</span>(&amp;phProv, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x18</span>u, CRYPT_VERIFYCONTEXT);</span><br><span class="line">  <span class="keyword">if</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="built_in">CryptCreateHash</span>(phProv, Algid, <span class="number">0</span>, <span class="number">0</span>, &amp;phHash);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="built_in">CryptHashData</span>(phHash, pbData, dwDataLen, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        pdwDataLen = <span class="number">4</span>;</span><br><span class="line">        v7 = <span class="built_in">CryptGetHashParam</span>(phHash, <span class="number">4u</span>, v8, &amp;pdwDataLen, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = (BYTE *)<span class="built_in">sub_334540</span>(*(<span class="type">size_t</span> *)v8);</span><br><span class="line">          <span class="keyword">if</span> ( v6 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">memset</span>(v6, <span class="number">0</span>, *(<span class="type">size_t</span> *)v8);</span><br><span class="line">            v7 = <span class="built_in">CryptGetHashParam</span>(phHash, <span class="number">2u</span>, v6, (DWORD *)v8, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v7 )</span><br><span class="line">            &#123;</span><br><span class="line">              *(_DWORD *)a4 = v6;</span><br><span class="line">              *(_DWORD *)a5 = *(_DWORD *)v8;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v7 = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v7 &amp;&amp; v6 )</span><br><span class="line">    <span class="built_in">sub_33453B</span>(v6);</span><br><span class="line">  <span class="keyword">if</span> ( phHash )</span><br><span class="line">    <span class="built_in">CryptDestroyHash</span>(phHash);</span><br><span class="line">  <span class="keyword">if</span> ( phProv )</span><br><span class="line">    <span class="built_in">CryptReleaseContext</span>(phProv, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都是一些win32的库函数，微软官方文档里都有详细说明，就不一个一个贴了。<br>主要知道这是一个哈希算法，其中枚举值0x8003表示MD5，0x8004表示SHA1。也就是对key的前半段MD5，后半段SHA1，验证key的正确性，然后对整个keyMD5作为密钥来加密flag。<br>那么现在就是要去找这段MD5和SHA1，去在线网站查询一下。</p>
<p>但是实际上，这里面写的有反调试，一跑就自动退出……经过对this结构体无尽的寻找，我找到了用来验证的密文和验证过程……</p>
<p>密文存储：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_332B30</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="keyword">struct</span> CWnd *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> v4[<span class="number">48</span>]; <span class="comment">// [esp+10h] [ebp-64h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+40h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+44h] [ebp-30h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp+48h] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-28h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [esp+50h] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+58h] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+5Ch] [ebp-18h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+60h] [ebp-14h]</span></span><br><span class="line"></span><br><span class="line">  CDialogEx::<span class="built_in">CDialogEx</span>((CDialogEx *)<span class="keyword">this</span>, <span class="number">0x66</span>u, a2);</span><br><span class="line">  *<span class="keyword">this</span> = &amp;CCrackmeDlg::`vftable<span class="number">&#x27;</span>;</span><br><span class="line">  <span class="built_in">sub_334120</span>(&amp;unk_4D8D9F);</span><br><span class="line">  <span class="built_in">sub_334120</span>(&amp;unk_4D8DA0);</span><br><span class="line">  <span class="built_in">sub_333AF0</span>();</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">52</span>] = <span class="built_in">sub_333B10</span>(<span class="number">128</span>);</span><br><span class="line">  v10 = <span class="number">0x600C59A8</span>;</span><br><span class="line">  v11 = <span class="number">0xEAB1281B</span>;</span><br><span class="line">  v12 = <span class="number">0xF9249AE5</span>;</span><br><span class="line">  v5 = <span class="number">0x978C9ED5</span>;</span><br><span class="line">  v6 = <span class="number">0x69D8E4B4</span>;</span><br><span class="line">  v7 = <span class="number">0xAB129C3A</span>;</span><br><span class="line">  v8 = <span class="number">0x9BA449C8</span>;</span><br><span class="line">  v9 = <span class="number">0x579F6DCE</span>;</span><br><span class="line">  v4[<span class="number">0</span>] = <span class="number">0x5B</span>;</span><br><span class="line">  v4[<span class="number">1</span>] = <span class="number">0x9C</span>;</span><br><span class="line">  v4[<span class="number">2</span>] = <span class="number">0xEE</span>;</span><br><span class="line">  v4[<span class="number">3</span>] = <span class="number">0xB2</span>;</span><br><span class="line">  v4[<span class="number">4</span>] = <span class="number">0x3B</span>;</span><br><span class="line">  v4[<span class="number">5</span>] = <span class="number">0xB7</span>;</span><br><span class="line">  v4[<span class="number">6</span>] = <span class="number">0xD7</span>;</span><br><span class="line">  v4[<span class="number">7</span>] = <span class="number">0x34</span>;</span><br><span class="line">  v4[<span class="number">8</span>] = <span class="number">0xF3</span>;</span><br><span class="line">  v4[<span class="number">9</span>] = <span class="number">0x1B</span>;</span><br><span class="line">  v4[<span class="number">10</span>] = <span class="number">0x75</span>;</span><br><span class="line">  v4[<span class="number">11</span>] = <span class="number">0x14</span>;</span><br><span class="line">  v4[<span class="number">12</span>] = <span class="number">0xC6</span>;</span><br><span class="line">  v4[<span class="number">13</span>] = <span class="number">0xB2</span>;</span><br><span class="line">  v4[<span class="number">14</span>] = <span class="number">0x1F</span>;</span><br><span class="line">  v4[<span class="number">15</span>] = <span class="number">0xE8</span>;</span><br><span class="line">  v4[<span class="number">16</span>] = <span class="number">0xDE</span>;</span><br><span class="line">  v4[<span class="number">17</span>] = <span class="number">0x33</span>;</span><br><span class="line">  v4[<span class="number">18</span>] = <span class="number">0x44</span>;</span><br><span class="line">  v4[<span class="number">19</span>] = <span class="number">0x74</span>;</span><br><span class="line">  v4[<span class="number">20</span>] = <span class="number">0x75</span>;</span><br><span class="line">  v4[<span class="number">21</span>] = <span class="number">0x1B</span>;</span><br><span class="line">  v4[<span class="number">22</span>] = <span class="number">0x47</span>;</span><br><span class="line">  v4[<span class="number">23</span>] = <span class="number">0x6A</span>;</span><br><span class="line">  v4[<span class="number">24</span>] = <span class="number">0xD4</span>;</span><br><span class="line">  v4[<span class="number">25</span>] = <span class="number">0x37</span>;</span><br><span class="line">  v4[<span class="number">26</span>] = <span class="number">0x51</span>;</span><br><span class="line">  v4[<span class="number">27</span>] = <span class="number">0x88</span>;</span><br><span class="line">  v4[<span class="number">28</span>] = <span class="number">0xFC</span>;</span><br><span class="line">  v4[<span class="number">29</span>] = <span class="number">0x67</span>;</span><br><span class="line">  v4[<span class="number">30</span>] = <span class="number">0xE6</span>;</span><br><span class="line">  v4[<span class="number">31</span>] = <span class="number">0x60</span>;</span><br><span class="line">  v4[<span class="number">32</span>] = <span class="number">0xDA</span>;</span><br><span class="line">  v4[<span class="number">33</span>] = <span class="number">0xD</span>;</span><br><span class="line">  v4[<span class="number">34</span>] = <span class="number">0x58</span>;</span><br><span class="line">  v4[<span class="number">35</span>] = <span class="number">7</span>;</span><br><span class="line">  v4[<span class="number">36</span>] = <span class="number">0x81</span>;</span><br><span class="line">  v4[<span class="number">37</span>] = <span class="number">0x43</span>;</span><br><span class="line">  v4[<span class="number">38</span>] = <span class="number">0x53</span>;</span><br><span class="line">  v4[<span class="number">39</span>] = <span class="number">0xEA</span>;</span><br><span class="line">  v4[<span class="number">40</span>] = <span class="number">0x7B</span>;</span><br><span class="line">  v4[<span class="number">41</span>] = <span class="number">0x52</span>;</span><br><span class="line">  v4[<span class="number">42</span>] = <span class="number">0x85</span>;</span><br><span class="line">  v4[<span class="number">43</span>] = <span class="number">0x6C</span>;</span><br><span class="line">  v4[<span class="number">44</span>] = <span class="number">0x86</span>;</span><br><span class="line">  v4[<span class="number">45</span>] = <span class="number">0x65</span>;</span><br><span class="line">  v4[<span class="number">46</span>] = <span class="number">0xAF</span>;</span><br><span class="line">  v4[<span class="number">47</span>] = <span class="number">0xB4</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">55</span>] = <span class="number">0xA7C0769F</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">56</span>] = v10;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">57</span>] = v11;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">58</span>] = v12;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">120</span>] = v5;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">121</span>] = v6;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">122</span>] = v7;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">123</span>] = v8;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">124</span>] = v9;</span><br><span class="line">  <span class="built_in">qmemcpy</span>(<span class="keyword">this</span> + <span class="number">185</span>, v4, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中v4是用于验证的flag的密文，this里的是MD5和SHA1。</p>
<p>至于说怎么找到的……<br>我们最开始找到的主逻辑是sub_1831E0(int this)，这个函数的参数只有一个this指针……那么就去找这个函数的交叉引用，双击跳转之后IDA带我们来到了这里：<br><code>.rdata:004D92AC                 dd offset sub_3331E0</code><br><del>显然这必不是一个函数</del> 那么到底怎么调用的……<br>按我的理解，这应该是C++封装的类，而sub_3331E0是类里面一个成员函数，所以它调用的时候只有一个this指针。直接找交叉引用也是只有常量段里一张表，没有直接调用的……<br>那么怎么找，具体来说就是从这里往上翻，翻到类的顶部，然后去查交叉引用，自然能找到调用的地方。<br>像这个题，从这里往上翻，翻到<code>.rdata:004D9250 unk_4D9250      db  12h</code>可以认为是类的顶部，然后查引用，是上面的数据<code>off_4D9248</code>引用，再查引用，发现是一个函数<code>sub_332E50</code>调用了这个类……<br>对这个函数再查两次引用，又会跳到一个表，然后再查一次就能找到存密文的函数。<br>像这样不断查引用，你会找到<code>.rdata:004D92CC ??_7CCrackmeDlg@@6B@</code>，对这个东西的引用处就是存储密文的函数。</p>
<p>为什么说this里存的应该是MD5和SHA1，因为长度是这样子……<br>MD5长度是32字节，SHA1长度是40字节，正好前4组是MD5，后5组是SHA1，这样子……<br>额但是直接拿去查查不到，那么应该是对这里面的东西做了一些修改。</p>
<p>上面提到<code>.rdata:004D92CC ??_7CCrackmeDlg@@6B@</code>，这个应该是这个题的主类了（至于为什么是主类，加密的密文都在里面了怎么不是主类（逃<br>你会看到这个类下面有巨长的一个函数列表，像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.rdata:004D92CC ??_7CCrackmeDlg@@6B@ dd offset sub_34ACAD</span><br><span class="line">.rdata:004D92CC                                         ; DATA XREF: sub_332B30+45↑o</span><br><span class="line">.rdata:004D92D0                 dd offset sub_332DA0</span><br><span class="line">.rdata:004D92D4                 dd offset ?_Alloc_proxy@_Container_base0@std@@QAEXABU_Fake_allocator@2@@Z ; std::_Container_base0::_Alloc_proxy(std::_Fake_allocator const &amp;)</span><br><span class="line">.rdata:004D92D8                 dd offset unknown_libname_78 ; MFC 3.1-14.0 32bit</span><br><span class="line">.rdata:004D92DC                 dd offset ?OnFinalRelease@CWnd@@UAEXXZ ; CWnd::OnFinalRelease(void)</span><br><span class="line">.rdata:004D92E0                 dd offset sub_349733</span><br><span class="line">.rdata:004D92E4                 dd offset sub_336FDB</span><br><span class="line">.rdata:004D92E8                 dd offset UserMathErrorFunction</span><br><span class="line">.rdata:004D92EC                 dd offset UserMathErrorFunction</span><br><span class="line">.rdata:004D92F0                 dd offset ?GetTypeLib@CCmdTarget@@UAEJKPAPAUITypeLib@@@Z ; CCmdTarget::GetTypeLib(ulong,ITypeLib * *)</span><br><span class="line">……</span><br><span class="line">……</span><br><span class="line">.rdata:004D9444                 dd offset sub_332E60</span><br><span class="line">.rdata:004D9448                 dd offset nullsub_5</span><br><span class="line">.rdata:004D944C                 dd offset ?OnOK@CDialog@@MAEXXZ ; CDialog::OnOK(void)</span><br><span class="line">.rdata:004D9450                 dd offset sub_343FF5</span><br><span class="line">.rdata:004D9454                 dd offset nullsub_1</span><br></pre></td></tr></table></figure>

<p>只贴了最开始和结束部分一点点，中间还有好长一串，可以自己康康IDA（逃<br>当然中间大部分是一些库函数，可以忽略，实际上的函数并不多。一个一个翻sub，可以看到里面大部分是空白的，或者是实现了一些没什么用的功能(x<br>就这样翻，相信你必可以翻到(x<br>翻到最后,倒数第2个函数sub_332E60，我们会发现对MD5和SHA1那两串密文的加密逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">sub_332E60</span><span class="params">(LPARAM *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> CHAR *v1; <span class="comment">// eax</span></span><br><span class="line">  HMODULE v2; <span class="comment">// eax</span></span><br><span class="line">  HANDLE v3; <span class="comment">// eax</span></span><br><span class="line">  FARPROC ZwSetInformationThread; <span class="comment">// [esp+8h] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+14h] [ebp-18h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+14h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">4</span>]; <span class="comment">// [esp+18h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+28h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  CDialog::<span class="built_in">OnInitDialog</span>((CDialog *)<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">sub_333AC0</span>(<span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_331CB0</span>(<span class="number">4u</span>);</span><br><span class="line">    <span class="built_in">sub_332100</span>(v9);</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">sub_333D40</span>(<span class="number">101</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)<span class="built_in">sub_333A90</span>(v9) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sub_333A60</span>(<span class="number">0x800</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      v1 = (<span class="type">const</span> CHAR *)std::_Ptr_base&lt;_EXCEPTION_RECORD <span class="type">const</span>&gt;::<span class="built_in">get</span>(v9);</span><br><span class="line">      <span class="built_in">sub_333A60</span>(<span class="number">0</span>, <span class="number">0x10</span>u, v1);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">sub_3329F0</span>(v9);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_333A30</span>(<span class="keyword">this</span>[<span class="number">52</span>], <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">sub_333A30</span>(<span class="keyword">this</span>[<span class="number">52</span>], <span class="number">0</span>);</span><br><span class="line">  v2 = <span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">  ZwSetInformationThread = <span class="built_in">GetProcAddress</span>(v2, <span class="string">&quot;ZwSetInformationThread&quot;</span>);</span><br><span class="line">  v3 = <span class="built_in">GetCurrentThread</span>();</span><br><span class="line">  ((<span class="built_in">void</span> (__stdcall *)(HANDLE, <span class="type">int</span>, _DWORD, _DWORD))ZwSetInformationThread)(v3, <span class="number">17</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i )</span><br><span class="line">    *((_BYTE *)<span class="keyword">this</span> + i + <span class="number">220</span>) ^= i;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">20</span>; ++j )</span><br><span class="line">    *((_BYTE *)<span class="keyword">this</span> + j + <span class="number">480</span>) ^= j;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现是依次异或索引值，那么写个脚本解一下。</p>
<p>实际上31~33行是一种反调，详见<a target="_blank" rel="noopener" href="https://ctf-wiki.org/reverse/windows/anti-debug/zwsetinformationthread/">CTF-wiki</a>。<br>当然我们前面已经知道了这个程序里必然有反调，如果对反调很熟悉，可以直接去导出表里找相应的反调试函数，然后查交叉引用，就能找到加密逻辑。因为按照经验来讲，只要不是库函数里的反调试，有反调试的地方一般存储着重要的加密逻辑 <del>（不然在这里写反调干什么啊喂！</del><br>当然也可以找到反调函数，下断绕过，就能动态去调试获取密文值，不用静态分析了。</p>
<p>静态分析解的脚本如下，在线网站查询出来的字符串写在注释里。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">this_md5=[<span class="number">0</span>]*<span class="number">4</span></span><br><span class="line">this_md5[<span class="number">0</span>] = <span class="number">0xA7C0769F</span></span><br><span class="line">this_md5[<span class="number">1</span>] = <span class="number">0x600C59A8</span></span><br><span class="line">this_md5[<span class="number">2</span>] = <span class="number">0xEAB1281B</span></span><br><span class="line">this_md5[<span class="number">3</span>] = <span class="number">0xF9249AE5</span></span><br><span class="line"><span class="comment">#NocT</span></span><br><span class="line"></span><br><span class="line">this_sha1=[<span class="number">0</span>]*<span class="number">5</span></span><br><span class="line">this_sha1[<span class="number">0</span>] = <span class="number">0x978C9ED5</span></span><br><span class="line">this_sha1[<span class="number">1</span>] = <span class="number">0x69D8E4B4</span></span><br><span class="line">this_sha1[<span class="number">2</span>] = <span class="number">0xAB129C3A</span></span><br><span class="line">this_sha1[<span class="number">3</span>] = <span class="number">0x9BA449C8</span></span><br><span class="line">this_sha1[<span class="number">4</span>] = <span class="number">0x579F6DCE</span></span><br><span class="line"><span class="comment">#uRne</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        tmp=this_md5[i]&amp;<span class="number">0xff</span></span><br><span class="line">        this_md5[i]=this_md5[i]&gt;&gt;<span class="number">8</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(tmp^(j+i*<span class="number">4</span>))[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        tmp=this_sha1[i]&amp;<span class="number">0xff</span></span><br><span class="line">        this_sha1[i]=this_sha1[i]&gt;&gt;<span class="number">8</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(tmp^(j+i*<span class="number">4</span>))[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这样我们就获得了key。</p>
<p>然后是加密flag的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __stdcall <span class="title">sub_3336E0</span><span class="params">(BYTE *pbData, DWORD dwDataLen, BYTE *a3, DWORD *pdwDataLen, DWORD dwBufLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BOOL v6; <span class="comment">// [esp+4h] [ebp-18h]</span></span><br><span class="line">  HCRYPTKEY phKey; <span class="comment">// [esp+Ch] [ebp-10h] BYREF</span></span><br><span class="line">  HCRYPTPROV phProv; <span class="comment">// [esp+10h] [ebp-Ch] BYREF</span></span><br><span class="line">  HCRYPTHASH phHash; <span class="comment">// [esp+14h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  phProv = <span class="number">0</span>;</span><br><span class="line">  phHash = <span class="number">0</span>;</span><br><span class="line">  phKey = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="built_in">CryptAcquireContextA</span>(&amp;phProv, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x18</span>u, <span class="number">0xF0000000</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="built_in">CryptCreateHash</span>(phProv, <span class="number">0x8003</span>u, <span class="number">0</span>, <span class="number">0</span>, &amp;phHash);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">CryptHashData</span>(phHash, pbData, dwDataLen, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v6 )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="built_in">CryptDeriveKey</span>(phProv, <span class="number">0x660E</span>u, phHash, <span class="number">1u</span>, &amp;phKey);</span><br><span class="line">        <span class="keyword">if</span> ( v6 )</span><br><span class="line">          v6 = <span class="built_in">CryptEncrypt</span>(phKey, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, a3, pdwDataLen, dwBufLen);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( phKey )</span><br><span class="line">    <span class="built_in">CryptDestroyKey</span>(phKey);</span><br><span class="line">  <span class="keyword">if</span> ( phHash )</span><br><span class="line">    <span class="built_in">CryptDestroyHash</span>(phHash);</span><br><span class="line">  <span class="keyword">if</span> ( phProv )</span><br><span class="line">    <span class="built_in">CryptReleaseContext</span>(phProv, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptderivekey#:~:text=The%20CryptDeriveKey%20function%20generates%20cryptographic%20session%20keys%20derived,be%20a%20password%20or%20any%20other%20user%20data.">CryptDeriveKey函数</a><br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptencrypt">CryptEncrypt函数</a><br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/alg-id">ALG_ID枚举值</a></p>
<p>可以查到0x660E对应<code>CALG_AES_128</code>。</p>
<p>彳亍口巴，用python写半天解密被报了一脸错……<br>那就抄IDA的伪代码，用cpp仿写原程序的逻辑，调用这些API函数来模拟一遍加密过程，最后调用解密函数即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wincrypt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">sub_3336E0</span><span class="params">(BYTE* pbData, DWORD dwDataLen, BYTE* a3, DWORD* pdwDataLen, DWORD dwBufLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL v6; <span class="comment">// [esp+4h] [ebp-18h]</span></span><br><span class="line">    HCRYPTKEY phKey; <span class="comment">// [esp+Ch] [ebp-10h] BYREF</span></span><br><span class="line">    HCRYPTPROV phProv; <span class="comment">// [esp+10h] [ebp-Ch] BYREF</span></span><br><span class="line">    HCRYPTHASH phHash; <span class="comment">// [esp+14h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">    phProv = <span class="number">0</span>;</span><br><span class="line">    phHash = <span class="number">0</span>;</span><br><span class="line">    phKey = <span class="number">0</span>;</span><br><span class="line">    v6 = <span class="built_in">CryptAcquireContextA</span>(&amp;phProv, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x18</span>, <span class="number">0xF0000000</span>);</span><br><span class="line">    <span class="keyword">if</span> (v6)</span><br><span class="line">    &#123;</span><br><span class="line">        v6 = <span class="built_in">CryptCreateHash</span>(phProv, <span class="number">0x8003</span>u, <span class="number">0</span>, <span class="number">0</span>, &amp;phHash);</span><br><span class="line">        <span class="keyword">if</span> (v6)</span><br><span class="line">        &#123;</span><br><span class="line">            v6 = <span class="built_in">CryptHashData</span>(phHash, pbData, dwDataLen, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (v6)</span><br><span class="line">            &#123;</span><br><span class="line">                v6 = <span class="built_in">CryptDeriveKey</span>(phProv, <span class="number">0x660E</span>, phHash, <span class="number">1</span>, &amp;phKey);</span><br><span class="line">                <span class="keyword">if</span> (v6)</span><br><span class="line">                    v6 = <span class="built_in">CryptDecrypt</span>(phKey, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, a3, pdwDataLen);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (phKey)</span><br><span class="line">        <span class="built_in">CryptDestroyKey</span>(phKey);</span><br><span class="line">    <span class="keyword">if</span> (phHash)</span><br><span class="line">        <span class="built_in">CryptDestroyHash</span>(phHash);</span><br><span class="line">    <span class="keyword">if</span> (phProv)</span><br><span class="line">        <span class="built_in">CryptReleaseContext</span>(phProv, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BYTE flag[] = &#123; <span class="number">0x5B</span>,<span class="number">0x9C</span>,<span class="number">0xEE</span>,<span class="number">0xB2</span>,<span class="number">0x3B</span>,<span class="number">0xB7</span>,<span class="number">0xD7</span>,<span class="number">0x34</span>,<span class="number">0xF3</span>,<span class="number">0x1B</span>,<span class="number">0x75</span>,<span class="number">0x14</span>,<span class="number">0xC6</span>,<span class="number">0xB2</span>,<span class="number">0x1F</span>,<span class="number">0xE8</span>,<span class="number">0xDE</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x74</span>,<span class="number">0x75</span>,<span class="number">0x1B</span>,<span class="number">0x47</span>,<span class="number">0x6A</span>,<span class="number">0xD4</span>,<span class="number">0x37</span>,<span class="number">0x51</span>,<span class="number">0x88</span>,<span class="number">0xFC</span>,<span class="number">0x67</span>,<span class="number">0xE6</span>,<span class="number">0x60</span>,<span class="number">0xDA</span>,<span class="number">0xD</span>,<span class="number">0x58</span>,<span class="number">7</span>,<span class="number">0x81</span>,<span class="number">0x43</span>,<span class="number">0x53</span>,<span class="number">0xEA</span>,<span class="number">0x7B</span>,<span class="number">0x52</span>,<span class="number">0x85</span>,<span class="number">0x6C</span>,<span class="number">0x86</span>,<span class="number">0x65</span>,<span class="number">0xAF</span>,<span class="number">0xB4</span> &#125;;</span><br><span class="line">    BYTE key[] = &#123; <span class="number">0x5c</span>,<span class="number">0x53</span>,<span class="number">0xa4</span>,<span class="number">0xa4</span>,<span class="number">0x1d</span>,<span class="number">0x52</span>,<span class="number">0x43</span>,<span class="number">0x7a</span>,<span class="number">0x9f</span>,<span class="number">0xa1</span>,<span class="number">0xe9</span>,<span class="number">0xc2</span>,<span class="number">0x6c</span>,<span class="number">0xa5</span>,<span class="number">0x90</span>,<span class="number">0x90</span> &#125;;</span><br><span class="line">    DWORD dwKeyLen = <span class="number">16</span>;</span><br><span class="line">    DWORD dwDataLen = <span class="number">32</span>;</span><br><span class="line">    DWORD* pdwDataLen = &amp;dwDataLen;</span><br><span class="line">    DWORD dwBufLen = <span class="number">0x104</span>;</span><br><span class="line">    <span class="built_in">sub_3336E0</span>(key, dwKeyLen, flag, pdwDataLen, dwBufLen);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>VS调了半天没搞明白怎么查看变量，maybe需要插件什么的，一直报a3是无效的字符串……<br>行吧，扔IDA里调，下断到解密完成的地方跑程序。<br>但是a3还是点不进去，直接去hex里跳转到ebp，然后往下翻，找到flag。<br><img src="/./img/code/chall_photo/Apr_FATE_crackme.png"></p>
<h3 id="FakePica"><a href="#FakePica" class="headerlink" title="FakePica"></a>FakePica</h3><p>高高兴兴脱了壳打开jadx，面对巨长的类表显然是没心情翻的，直接搜MainActivity，但是搜出来一堆奇奇怪怪的东西，什么加密也没有。<br>于是☁️戴上了痛苦面具，开始在巨长的类表里一个一个翻。<br>然而翻了N年也没翻到，☁️终于忍不了了，直接去看WP，搜WP里的类名，然鹅也还是没有。</p>
<blockquote>
<p>怎么会是呢？<br>是啊怎么会是呢？</p>
</blockquote>
<p>WP如此简单，两组AES密文直接解密，简单得让☁️怀疑人生。</p>
<blockquote>
<p>主类在哪啊？你的主类到底tmd在哪啊？？？这个题的唯一难度难道就在于找主类吗？？？</p>
</blockquote>
<p>☁️关了jadx冷静了一会，想起来自己刚才脱壳的时候手滑点到了另一个APP，所以那个本来只有5MB的题到☁️手上脱壳出来20多MB的文件。</p>
<blockquote>
<p>原来世界上真的又这么傻逼的人啊。<br>确实，除了你没别人了。</p>
</blockquote>
<p>☁️长叹一声，爬回去找文件。</p>
<p>脱壳，找到主类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">ActivityC0214AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">IvParameterSpec</span> <span class="variable">IV_PARAMETER_SPEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(<span class="string">&quot;0102030405060708&quot;</span>.getBytes());</span><br><span class="line">    Button checkIn;</span><br><span class="line">    <span class="type">byte</span>[] content0 = &#123;-<span class="number">114</span>, <span class="number">95</span>, -<span class="number">37</span>, Byte.MAX_VALUE, -<span class="number">110</span>, <span class="number">113</span>, <span class="number">41</span>, <span class="number">74</span>, <span class="number">40</span>, <span class="number">73</span>, <span class="number">19</span>, <span class="number">124</span>, -<span class="number">57</span>, -<span class="number">88</span>, <span class="number">39</span>, -<span class="number">116</span>, -<span class="number">16</span>, -<span class="number">75</span>, -<span class="number">3</span>, -<span class="number">45</span>, -<span class="number">73</span>, -<span class="number">6</span>, -<span class="number">104</span>, -<span class="number">6</span>, -<span class="number">78</span>, <span class="number">121</span>, <span class="number">110</span>, <span class="number">74</span>, -<span class="number">90</span>, -<span class="number">47</span>, -<span class="number">28</span>, -<span class="number">28</span>&#125;;</span><br><span class="line">    <span class="type">byte</span>[] content1 = &#123;-<span class="number">40</span>, <span class="number">26</span>, <span class="number">95</span>, -<span class="number">49</span>, -<span class="number">40</span>, -<span class="number">123</span>, <span class="number">72</span>, -<span class="number">90</span>, -<span class="number">100</span>, -<span class="number">41</span>, <span class="number">122</span>, -<span class="number">4</span>, <span class="number">25</span>, -<span class="number">101</span>, -<span class="number">58</span>, <span class="number">116</span>&#125;;</span><br><span class="line">    EditText emailInput;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;picapicapicapica&quot;</span>;</span><br><span class="line">    EditText passWordInput;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encryptIntoHexString</span><span class="params">(String data, String key2)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">            cipher.init(<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key2.getBytes(), <span class="string">&quot;AES&quot;</span>), <span class="built_in">this</span>.IV_PARAMETER_SPEC);</span><br><span class="line">            <span class="keyword">return</span> bytesConvertHexString(cipher.doFinal(Arrays.copyOf(data.getBytes(), ((data.getBytes().length / <span class="number">16</span>) + <span class="number">1</span>) * <span class="number">16</span>)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">decryptByHexString</span><span class="params">(String data, String key2)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">            cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key2.getBytes(), <span class="string">&quot;AES&quot;</span>), <span class="built_in">this</span>.IV_PARAMETER_SPEC);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(cipher.doFinal(hexStringConvertBytes(data.toLowerCase())), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">bytesConvertHexString</span><span class="params">(<span class="type">byte</span>[] data)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : data) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hexString</span> <span class="operator">=</span> Integer.toHexString(b &amp; <span class="number">255</span>);</span><br><span class="line">            result.append(hexString.length() == <span class="number">1</span> ? <span class="string">&quot;0&quot;</span> + hexString : hexString);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] hexStringConvertBytes(String data) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> data.length() / <span class="number">2</span>;</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> Integer.parseInt(data.substring(i * <span class="number">2</span>, (i * <span class="number">2</span>) + <span class="number">1</span>), <span class="number">16</span>);</span><br><span class="line">            result[i] = (<span class="type">byte</span>) ((first * <span class="number">16</span>) + Integer.parseInt(data.substring((i * <span class="number">2</span>) + <span class="number">1</span>, (i * <span class="number">2</span>) + <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>AES，CBC模式，key和iv都给了，去解密就好。<br>虽然但是，我试了好几个解密网站，enc2的内容都比较顺利，但是enc1不是16字节倍数的。<br>我先截取了前16字节，解出来是<code>picacomic@gmail.</code>，实际内容应该是<code>picacomic@gmail.com</code>。我直接对<code>picacomic@gmail.com</code>加密，出来的数据少了一截，换成zeropadding的话出来的数据会多一截。</p>
<p>具体而言：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enc1</span><br><span class="line">8e5fdb7f9271294a2849137cc7a8278cf0b5fdd3b7fa98fab2796e4aa6</span><br><span class="line"></span><br><span class="line">picacomic@gmail.com NoPadding</span><br><span class="line">8e5fdb7f9271294a2849137cc7a8278cf0b5fd</span><br><span class="line"></span><br><span class="line">picacomic@gmail.com ZeroPadding</span><br><span class="line">8e5fdb7f9271294a2849137cc7a8278cf0b5fdd3b7fa98fab2796e4aa6d1e4e4</span><br></pre></td></tr></table></figure>

<p>嗯，反正感觉挺迷的。说是NoPadding但是多了一截，ZeroPadding又少了一截……<br>不过这个题取前16字节就可以解出邮箱前半部分，后半部分靠常识也知道是com了。<br><del>大概是出题人最后的温柔</del></p>
<h3 id="奇怪的交易"><a href="#奇怪的交易" class="headerlink" title="奇怪的交易"></a>奇怪的交易</h3><p>有UPX壳，脱壳。<br>脱壳完了丢进IDA，逻辑看不懂，发现PY之类的字符串，又想起来我第一次跑这个程序跑不起来，报错是</p>
<blockquote>
<p>[112] Error loading Python lib ‘&#x2F;tmp&#x2F;_MEImk23nz&#x2F;libpython3.10.so.1.0’: dlopen: &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6: version &#96;GLIBC_2.33’ not found (required by &#x2F;tmp&#x2F;_MEImk23nz&#x2F;libpython3.10.so.1.0)</p>
</blockquote>
<p>为了能用uncompyle6，我的python版本是3.8，看到这个报错我还挺疑惑的，怎么跟python3.10扯上关系……直到后来在IDA里看到<br><img src="/./img/code/chall_photo/qgdjy_ida.jpg"></p>
<p>好家伙，这一堆import <del>仿佛梦回抗疫CTF被树师傅的题折磨</del></p>
<p>彳亍口巴，那必然是python打包的可执行文件了，出题人qs会玩。</p>
<p>环境换成python3.10，pyinstxtractor还是8能用，按照这个解决：<br><a target="_blank" rel="noopener" href="https://github.com/extremecoders-re/pyinstxtractor/wiki/Extracting-Linux-ELF-binaries">https://github.com/extremecoders-re/pyinstxtractor/wiki/Extracting-Linux-ELF-binaries</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objcopy --dump-section pydata=pydata.dump testfile.elf</span><br><span class="line">python pyinstxtractor.py pydata.dump</span><br></pre></td></tr></table></figure>

<p>（我把文件名改成data）<br><img src="/./img/code/chall_photo/qgdjy_unelf.jpg"></p>
<p>成功解包。</p>
<blockquote>
<p>☁️：停一下，我宣布一件事情。<br>☁️：用python3.10出pyc的出题人都是屑。<br>☁️：track神除外。</p>
</blockquote>
<p><del>（手动狗头保命</del></p>
<p>加文件头，读字节码，复原python代码，虽然<a target="_blank" rel="noopener" href="https://tool.lu/pyc/">在线网站</a>可以用，但是3.10解出来的部分代码还是有问题，直接看容易出锅，还是得自己手翻一下。</p>
<p>复原python代码之后发现从cup库导了一个encrypto函数，提示是a cup of tea，实际上可以猜出来是tea加密。<br>密文长度115，必然不是TEA和XTEA，因为如果看过实现代码就知道，这两个加密是要求偶数对密文的，所以只能是XXTEA。</p>
<p>当然了，这么猜着做题确实能做出来，但是没什么意思，还是试着去找一下cup库的内容。</p>
<p>实际上这里用到了一个<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-271253.htm">pyinstaller加密</a></p>
<p>简而言之，就是把导入的库（pyc文件）用aes加密之后压缩成pyz文件。因为这是pyinstaller里的源代码，所以加密方式必然是这样的。<br>先去解包pyz文件，获取cup包加密后的pyc文件，然后对这个文件解密得到cup.pyc，再反编译去看cup的源码。</p>
<p>解包pyz文件<br><img src="/./img/code/chall_photo/unpyz.jpg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tinyaes</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"> </span><br><span class="line">CRYPT_BLOCK_SIZE = <span class="number">16</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 从crypt_key.pyc获取key，也可自行反编译获取</span></span><br><span class="line">key = <span class="built_in">bytes</span>(<span class="string">&#x27;0000000000000tea&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">inf = <span class="built_in">open</span>(<span class="string">&#x27;cup.pyc.encrypted&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="comment"># 打开加密文件</span></span><br><span class="line">outf = <span class="built_in">open</span>(<span class="string">&#x27;cup.pyc&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="comment"># 输出文件</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 按加密块大小进行读取</span></span><br><span class="line">iv = inf.read(CRYPT_BLOCK_SIZE)</span><br><span class="line"> </span><br><span class="line">cipher = tinyaes.AES(key, iv)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line">plaintext = zlib.decompress(cipher.CTR_xcrypt_buffer(inf.read()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入解密数据</span></span><br><span class="line">outf.write(plaintext)</span><br><span class="line"> </span><br><span class="line">inf.close()</span><br><span class="line">outf.close()</span><br></pre></td></tr></table></figure>

<p>解密出来之后补一下头文件，然后dis自己看字节码，可以看出来是XXTEA。那么写脚本解密。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x9e3779b9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;5^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">xxtea</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">int</span> n, <span class="type">uint32_t</span>* key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;</span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)             <span class="comment">// encrypt</span></span><br><span class="line">    &#123;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = <span class="number">0</span>;</span><br><span class="line">        z = v[n<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            sum += DELTA;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)</span><br><span class="line">            &#123;</span><br><span class="line">                y = v[p+<span class="number">1</span>];</span><br><span class="line">                z = v[p] += MX;</span><br><span class="line">            &#125;</span><br><span class="line">            y = v[<span class="number">0</span>];</span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">// decrypt</span></span><br><span class="line">    &#123;</span><br><span class="line">        n = -n;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = rounds * DELTA;</span><br><span class="line">        y = v[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)</span><br><span class="line">            &#123;</span><br><span class="line">                z = v[p<span class="number">-1</span>];</span><br><span class="line">                y = v[p] -= MX;</span><br><span class="line">            &#125;</span><br><span class="line">            z = v[n<span class="number">-1</span>];</span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">            sum -= DELTA;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> v[] = &#123;<span class="number">3532577106</span>, <span class="number">1472742623</span>, <span class="number">3642468664</span>, <span class="number">4193500461</span>, <span class="number">2398676029</span>, <span class="number">617653972</span>, <span class="number">1474514999</span>, <span class="number">1471783658</span>, <span class="number">1012864704</span>,</span><br><span class="line">              <span class="number">3615627536</span>, <span class="number">993855884</span>, <span class="number">438456717</span>, <span class="number">3358938551</span>, <span class="number">3906991208</span>, <span class="number">198959101</span>, <span class="number">3317190635</span>, <span class="number">3656923078</span>, <span class="number">613157871</span>,</span><br><span class="line">              <span class="number">2398768861</span>, <span class="number">97286225</span>, <span class="number">2336972940</span>, <span class="number">1471645170</span>, <span class="number">3233163154</span>, <span class="number">583597118</span>, <span class="number">2863776301</span>, <span class="number">3183067750</span>, <span class="number">1384330715</span>,</span><br><span class="line">              <span class="number">2929694742</span>, <span class="number">3522431804</span>, <span class="number">2181488067</span>, <span class="number">3303062236</span>, <span class="number">3825712422</span>, <span class="number">145643141</span>, <span class="number">2148976293</span>, <span class="number">2940910035</span>, <span class="number">506798154</span>,</span><br><span class="line">              <span class="number">994590281</span>, <span class="number">2231904779</span>, <span class="number">3389770074</span>, <span class="number">2814269052</span>, <span class="number">1105937096</span>, <span class="number">1789727804</span>, <span class="number">3757028753</span>, <span class="number">2469686072</span>, <span class="number">1162286478</span>,</span><br><span class="line">              <span class="number">680814033</span>, <span class="number">2934024098</span>, <span class="number">2162521262</span>, <span class="number">4048876895</span>, <span class="number">2121620700</span>, <span class="number">4240287315</span>, <span class="number">2391811140</span>, <span class="number">3396611602</span>, <span class="number">3091349617</span>,</span><br><span class="line">              <span class="number">3031523010</span>, <span class="number">2486958601</span>, <span class="number">3164065171</span>, <span class="number">1285603712</span>, <span class="number">798920280</span>, <span class="number">2337813135</span>, <span class="number">4186055520</span>, <span class="number">3523024366</span>, <span class="number">1077514121</span>,</span><br><span class="line">              <span class="number">1436444106</span>, <span class="number">2731983230</span>, <span class="number">1507202797</span>, <span class="number">500756149</span>, <span class="number">198754565</span>, <span class="number">2382448647</span>, <span class="number">880454148</span>, <span class="number">1970517398</span>, <span class="number">3217485349</span>,</span><br><span class="line">              <span class="number">1161840191</span>, <span class="number">560498076</span>, <span class="number">1782600856</span>, <span class="number">2643721918</span>, <span class="number">1285196205</span>, <span class="number">788797746</span>, <span class="number">1195724574</span>, <span class="number">4061612551</span>, <span class="number">103427523</span>,</span><br><span class="line">              <span class="number">2502688387</span>, <span class="number">4147162188</span>, <span class="number">617564657</span>, <span class="number">978211984</span>, <span class="number">1781482121</span>, <span class="number">2205798970</span>, <span class="number">3939973102</span>, <span class="number">3826603515</span>, <span class="number">659557668</span>,</span><br><span class="line">              <span class="number">2582884932</span>, <span class="number">1561884856</span>, <span class="number">2217488804</span>, <span class="number">1189296962</span>, <span class="number">169145316</span>, <span class="number">2781742156</span>, <span class="number">1323893433</span>, <span class="number">824667876</span>, <span class="number">408202876</span>,</span><br><span class="line">              <span class="number">3759637634</span>, <span class="number">4094868412</span>, <span class="number">1508996065</span>, <span class="number">162419237</span>, <span class="number">3732146944</span>, <span class="number">3083560189</span>, <span class="number">3955940127</span>, <span class="number">2393776934</span>, <span class="number">2470191468</span>,</span><br><span class="line">              <span class="number">3620861513</span>, <span class="number">481927014</span>, <span class="number">2756226070</span>, <span class="number">3154651143</span>, <span class="number">1261069441</span>, <span class="number">2063238535</span>, <span class="number">2222237213</span>, <span class="number">101459755</span>, <span class="number">3159774417</span>,</span><br><span class="line">              <span class="number">1721190841</span>, <span class="number">1078395785</span>, <span class="number">176506553</span>, <span class="number">3552913423</span>, <span class="number">1566142515</span>, <span class="number">1938949000</span>, <span class="number">1499289517</span>, <span class="number">3315102456</span>, <span class="number">829714860</span>,</span><br><span class="line">              <span class="number">3843359394</span>, <span class="number">952932374</span>, <span class="number">1283577465</span>, <span class="number">2045007203</span>, <span class="number">3957761944</span>, <span class="number">3767891405</span>, <span class="number">2917089623</span>, <span class="number">3296133521</span>, <span class="number">482297421</span>,</span><br><span class="line">              <span class="number">1734231412</span>, <span class="number">3670478932</span>, <span class="number">2575334979</span>, <span class="number">2827842737</span>, <span class="number">3413631016</span>, <span class="number">1533519803</span>, <span class="number">4008428470</span>, <span class="number">3890643173</span>, <span class="number">272960248</span>,</span><br><span class="line">              <span class="number">317508587</span>, <span class="number">3299937500</span>, <span class="number">2440520601</span>, <span class="number">27470488</span>, <span class="number">1666674386</span>, <span class="number">1737927609</span>, <span class="number">750987808</span>, <span class="number">2385923471</span>, <span class="number">2694339191</span>,</span><br><span class="line">              <span class="number">562925334</span>, <span class="number">2206035395</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> k[<span class="number">4</span>]= &#123;<span class="number">54</span>,<span class="number">54</span>,<span class="number">54</span>,<span class="number">54</span>&#125;;</span><br><span class="line">    <span class="comment">//n的绝对值表示v的长度，取正表示加密，取负表示解密</span></span><br><span class="line">    <span class="type">int</span> n = <span class="number">155</span>;</span><br><span class="line"></span><br><span class="line">    xxtea(v, -n, k);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">155</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,v[i]&gt;&gt;<span class="number">24</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,(v[i]&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,(v[i]&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,v[i]&amp;<span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//10610336534759505889607399322387179316771488492347274741918862678692508953185876570981227584004676580623553664818853686933004290078153620168054665086468417541382824708104480882577200529822968531743002301934310349005341104696887943182074473298650903541494918266823037984054778903666406545980557074219162536057146090758158128189406073809226361445046225524917089434897957301396534515964547462425719205819342172669899546965221084098690893672595962129879041507903210851706793788311452973769358455761907303633956322972510500253009083922781934406731633755418753858930476576720874219359466503538931371444470303193503733920039</span></span><br></pre></td></tr></table></figure>

<p>然后解RSA，用yafu跑了一下，8彳亍，☁️就8会了，因为☁️8是密码👴</p>
<blockquote>
<p>☁️：在逆向题里放RSA是否搞错了什么？</p>
</blockquote>
<p>于是有了以下对话：<br><img src="/./img/code/chall_photo/rsa.jpg"></p>
<p>彳亍，还得是dbt神。</p>
<p>搜维纳攻击，随便找个脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">x,y</span>):       <span class="comment">#使用辗转相处将分数 x/y 转为连分数的形式</span></span><br><span class="line">    res=[]</span><br><span class="line">    <span class="keyword">while</span> y:</span><br><span class="line">        res.append(x//y)</span><br><span class="line">        x,y=y,x%y</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">continued_fraction</span>(<span class="params">sub_res</span>):</span><br><span class="line">    numerator,denominator=<span class="number">1</span>,<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> sub_res[::-<span class="number">1</span>]:      <span class="comment">#从sublist的后面往前循环</span></span><br><span class="line">        denominator,numerator=numerator,i*numerator+denominator</span><br><span class="line">    <span class="keyword">return</span> denominator,numerator   <span class="comment">#得到渐进分数的分母和分子，并返回</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#求解每个渐进分数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub_fraction</span>(<span class="params">x,y</span>):</span><br><span class="line">    res=transform(x,y)</span><br><span class="line">    res=<span class="built_in">list</span>(<span class="built_in">map</span>(continued_fraction,(res[<span class="number">0</span>:i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(res)))))  <span class="comment">#将连分数的结果逐一截取以求渐进分数</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pq</span>(<span class="params">a,b,c</span>):      <span class="comment">#由p+q和pq的值通过维达定理来求解p和q</span></span><br><span class="line">    par=gmpy2.isqrt(b*b-<span class="number">4</span>*a*c)   <span class="comment">#由上述可得，开根号一定是整数，因为有解</span></span><br><span class="line">    x1,x2=(-b+par)//(<span class="number">2</span>*a),(-b-par)//(<span class="number">2</span>*a)</span><br><span class="line">    <span class="keyword">return</span> x1,x2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wienerAttack</span>(<span class="params">e,n</span>):</span><br><span class="line">    <span class="keyword">for</span> (d,k) <span class="keyword">in</span> sub_fraction(e,n):  <span class="comment">#用一个for循环来注意试探e/n的连续函数的渐进分数，直到找到一个满足条件的渐进分数</span></span><br><span class="line">        <span class="keyword">if</span> k==<span class="number">0</span>:                     <span class="comment">#可能会出现连分数的第一个为0的情况，排除</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (e*d-<span class="number">1</span>)%k!=<span class="number">0</span>:             <span class="comment">#ed=1 (mod φ(n)) 因此如果找到了d的话，(ed-1)会整除φ(n),也就是存在k使得(e*d-1)//k=φ(n)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        phi=(e*d-<span class="number">1</span>)//k               <span class="comment">#这个结果就是 φ(n)</span></span><br><span class="line">        px,qy=get_pq(<span class="number">1</span>,n-phi+<span class="number">1</span>,n)</span><br><span class="line">        <span class="keyword">if</span> px*qy==n:</span><br><span class="line">            p,q=<span class="built_in">abs</span>(<span class="built_in">int</span>(px)),<span class="built_in">abs</span>(<span class="built_in">int</span>(qy))     <span class="comment">#可能会得到两个负数，负负得正未尝不会出现</span></span><br><span class="line">            d=gmpy2.invert(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))     <span class="comment">#求ed=1 (mod  φ(n))的结果，也就是e关于 φ(n)的乘法逆元d</span></span><br><span class="line">            <span class="keyword">return</span> d</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;该方法不适用&quot;</span>)</span><br><span class="line">    </span><br><span class="line">c=<span class="number">10610336534759505889607399322387179316771488492347274741918862678692508953185876570981227584004676580623553664818853686933004290078153620168054665086468417541382824708104480882577200529822968531743002301934310349005341104696887943182074473298650903541494918266823037984054778903666406545980557074219162536057146090758158128189406073809226361445046225524917089434897957301396534515964547462425719205819342172669899546965221084098690893672595962129879041507903210851706793788311452973769358455761907303633956322972510500253009083922781934406731633755418753858930476576720874219359466503538931371444470303193503733920039</span></span><br><span class="line">n=<span class="number">0x649EE967E7916A825CC9FD3320BEABF263BEAC68C080F52824A0F521EDB6B78577EC52BF1C9E78F4BB71192F9A23F1A17AA76E5979E4D953329D3CA65FB4A71DA57412B59DFD6AEDF0191C5555D3E5F582B81B5E6B23163E9889204A81AFFDF119FE25C92F4ED59BD3285BCD7AAE14824240D2E33C5A97848F4EB7AAC203DE6330D2B4D8FF61691544FBECD120F99A157B3D2F58FA51B2887A9D06CA383C44D071314A12B17928B96F03A06E959A5AFEFA0183664F52CD32B9FC72A04B45913FCB2D5D2D3A415A14F611CF1EAC2D6C785142A8E9CC41B67A6CD85001B06EDB8CA767D367E56E0AE651491BF8A8C17A38A1835DB9E4A9292B1D86D5776C98CC25</span></span><br><span class="line">e=<span class="number">0x647327833ACFEF1F9C83E74E171FC300FA347D4A6769476C33DA82C95120ACB38B62B33D429206FE6E9BB0BB7AB748A1036971BEA36EC47130B749C1C9FF6FE03D0F7D9FC5346EB0E575BDFA6C530AA57CD676894FC080D2DD049AB59625F4B9C78BCFD95CDCD2793E440E26E189D251121CB6EB177FEDB596409034E8B0C5BBD9BD9342235DBB226C9170EFE347FF0FD2CFF9A1F7B647CC83E4D8F005FD7125A89251C768AFE70BDD54B88116814D5030F499BCAC4673CCCC342FB4B6AC58EA5A64546DC25912B6C430529F6A7F449FD96536DE269D1A1B015A4AC6B6E46EE19DCE8143726A6503E290E4BAE6BD78319B5878981F6CFFDB3B818209341FD68B</span></span><br><span class="line"></span><br><span class="line">d=wienerAttack(e,n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,n)))</span><br><span class="line"><span class="comment">#b&#x27;flag&#123;You_Need_Some_Tea&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="May-出题人挑战赛"><a href="#May-出题人挑战赛" class="headerlink" title="May 出题人挑战赛"></a>May 出题人挑战赛</h2><p><del>DAS就是纯纯坐牢</del></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1W54y1o7zC?share_source=copy_web">PZ师傅的WP视频</a></p>
<h3 id="WER"><a href="#WER" class="headerlink" title="WER"></a>WER</h3><p>翻导入表，找<code>RegisterApplicationRecoveryCallback</code>，查交叉引用，跳到<code>sub_140001000</code>，F5得到伪代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HRESULT <span class="title function_">sub_140001000</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  atexit(sub_14000F4A0);</span><br><span class="line">  <span class="keyword">return</span> RegisterApplicationRecoveryCallback((APPLICATION_RECOVERY_CALLBACK)sub_14000F3B0, <span class="number">0</span>i64, <span class="number">0x1388</span>u, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然<code>RegisterApplicationRecoveryCallback</code>调用的是<code>sub_14000F3B0</code>，那么就去看这个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_14000F3B0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  CHAR Text[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  BOOL pbCancelled; <span class="comment">// [rsp+68h] [rbp+18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0</span>i64;</span><br><span class="line">  v3[<span class="number">0</span>] = <span class="number">89457413</span>;</span><br><span class="line">  pbCancelled = <span class="number">0</span>;</span><br><span class="line">  v3[<span class="number">1</span>] = <span class="number">1415448324</span>;</span><br><span class="line">  v3[<span class="number">2</span>] = <span class="number">38799109</span>;</span><br><span class="line">  v3[<span class="number">3</span>] = <span class="number">1348424451</span>;</span><br><span class="line">  v3[<span class="number">4</span>] = <span class="number">89346131</span>;</span><br><span class="line">  v3[<span class="number">5</span>] = <span class="number">1431568469</span>;</span><br><span class="line">  v3[<span class="number">6</span>] = <span class="number">33882967</span>;</span><br><span class="line">  v3[<span class="number">7</span>] = <span class="number">1397837906</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(Text, <span class="string">&quot;Correct!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( (*((<span class="type">unsigned</span> __int8 *)v3 + v0) ^ *((<span class="type">char</span> *)&amp;xmmword_140035C20 + v0)) == <span class="number">102</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ++v0 &gt;= <span class="number">32</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = MessageBoxA(<span class="number">0</span>i64, Text, <span class="number">0</span>i64, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( pbCancelled )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      ApplicationRecoveryInProgress(&amp;pbCancelled);</span><br><span class="line">      <span class="keyword">if</span> ( pbCancelled )</span><br><span class="line">      &#123;</span><br><span class="line">        ApplicationRecoveryFinished(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ApplicationRecoveryFinished(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，就是一组异或……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v3=[<span class="number">0x5550305</span>,<span class="number">0x545E0704</span>,<span class="number">0x2500705</span>,<span class="number">0x505F5303</span>,<span class="number">0x5535053</span>,<span class="number">0x55540055</span>,<span class="number">0x2050357</span>,<span class="number">0x53515052</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v3:</span><br><span class="line">    t=i^<span class="number">0x66666666</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(t&amp;<span class="number">0xff</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        t&gt;&gt;=<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>其实我觉得吧，这种虚假控制流的题，如果是把整个执行流放在回调函数里还好说。<br>因为如果main函数根本没调用的话，那么回调函数里必然要进行IO操作，而IO操作必然要引用导入的库函数，所以这个题不知道<code>RegisterApplicationRecoveryCallback</code>的话，直接去导入表找<code>MessageBoxA</code>就好了。</p>
<p>以下来自<a target="_blank" rel="noopener" href="http://www.ctfiot.com/42240.html">官方WP</a></p>
<p>1.通过Windows的WER机制隐藏控制流：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Test</span>() &#123;</span><br><span class="line">    <span class="built_in">atexit</span>(OnExit);</span><br><span class="line">    PVOID pvParameter = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwPingInterval = RECOVERY_DEFAULT_PING_INTERVAL;</span><br><span class="line">    DWORD dwFlags = <span class="number">0</span>;</span><br><span class="line">    HRESULT hRes = <span class="built_in">RegisterApplicationRecoveryCallback</span>(ApplicationRecoverCallback, pvParameter, dwPingInterval, dwFlags);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnExit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">WerReportHang</span>(<span class="built_in">GetForegroundWindow</span>(), <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">TriggerException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.在类初始化时注册一个 ApplicationRecoverCallback 回调，可以在 main 函数之前完成<br>3.在 onExit 里调用 WerReportHang 并触发异常，使真正的逻辑执行<br>4.main 中的逻辑是 ECC 中的点加法，但是设置为了不可能成立，同时在 mp_read_radix 中动了手脚，能把输入保存下来。</p>
<h3 id="CEF"><a href="#CEF" class="headerlink" title="CEF"></a>CEF</h3><p>感觉我真是把能踩的坑都踩了一遍……还是按<a target="_blank" rel="noopener" href="https://ppppz.net/2022/05/26/DASCTF2022-X-VOID-CEF/">PZ师傅的博客</a>复现，师傅tql QAQ，我实在是太菜了。</p>
<p>这种生成密钥然后加密的算法，都不用管密钥怎么生成的，直接下断点去内存里dump出来就好了</p>
<p>round函数里起始的result是2，所以第一句异或的几个值分别是key、<code>a1[(i+2)%4]</code>、<code>a1[(i+2+1)%4]</code>、<code>a1[(i+2-1)%4]</code>，也就是<code>a1[(i+1)%4]</code>、<code>a1[(i+2)%4]</code>、<code>a1[(i+3)%4]</code>，但是忽略了刚开始那个人result&#x3D;2的某人索引全写错了，但是看我的脚本似乎有时候还是想起来了这个问题，<del>所以难道这是个玄学问题么</del><br>还有就是在网上乱当代码，宏定义人家后面写的BE结尾，我直接忽略，后来死活解不对，去挨个对，发现宏里面位移是反的，才突然醒悟BE是big endian（大端序）…………………………</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">round</span><span class="params">(<span class="type">int</span> a1, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">2</span>;</span><br><span class="line">  v5 = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *a2++ ^ *(_DWORD *)(a1 + <span class="number">4</span> * (result % <span class="number">4</span>)) ^ *(_DWORD *)(a1 + <span class="number">4</span> * ((result + <span class="number">1</span>) % <span class="number">4</span>)) ^ *(_DWORD *)(a1 + <span class="number">4</span> * ((result - <span class="number">1</span>) % <span class="number">4</span>));</span><br><span class="line">    v4 = v5-- == <span class="number">1</span>;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">4</span> * ((result + <span class="number">2</span>) % <span class="number">4</span>)) = v3 ^ *(_DWORD *)(a1 + <span class="number">4</span> * (((_BYTE)result - <span class="number">2</span>) &amp; <span class="number">3</span>)) ^ __ROL4__(v3, <span class="number">2</span>) ^ __ROR4__(v3, <span class="number">8</span>) ^ __ROL4__(v3, <span class="number">10</span>) ^ __ROR4__(v3, <span class="number">14</span>);</span><br><span class="line">    ++result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !v4 );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> k[] = &#123;<span class="number">0x7C</span>, <span class="number">0x22</span>, <span class="number">0xDB</span>, <span class="number">0xE8</span>, <span class="number">0xB9</span>, <span class="number">0x51</span>, <span class="number">0x24</span>, <span class="number">0x01</span>, <span class="number">0xDB</span>, <span class="number">0xA9</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0xED</span>, <span class="number">0xC3</span>, <span class="number">0x65</span>, <span class="number">0x1F</span>, <span class="number">0xC9</span>, <span class="number">0x81</span>, <span class="number">0xE9</span>, <span class="number">0xD1</span>, <span class="number">0xB3</span>, </span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0x47</span>, <span class="number">0x9B</span>, <span class="number">0x31</span>, <span class="number">0x51</span>, <span class="number">0x55</span>, <span class="number">0xBA</span>, <span class="number">0xA4</span>, <span class="number">0x2D</span>, <span class="number">0xED</span>, </span><br><span class="line">  <span class="number">0xF2</span>, <span class="number">0xD0</span>, <span class="number">0x92</span>, <span class="number">0xD6</span>, <span class="number">0x00</span>, <span class="number">0x4A</span>, <span class="number">0x30</span>, <span class="number">0xFE</span>, <span class="number">0xAE</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x4A</span>, <span class="number">0xDB</span>, <span class="number">0xBC</span>, <span class="number">0x6B</span>, <span class="number">0xF1</span>, <span class="number">0xF6</span>, <span class="number">0x15</span>, <span class="number">0xC3</span>, <span class="number">0x30</span>, <span class="number">0xB0</span>, </span><br><span class="line">  <span class="number">0xE1</span>, <span class="number">0xB4</span>, <span class="number">0xCE</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x69</span>, <span class="number">0xD3</span>, <span class="number">0x08</span>, <span class="number">0x92</span>, <span class="number">0x47</span>, </span><br><span class="line">  <span class="number">0x97</span>, <span class="number">0x7B</span>, <span class="number">0x8C</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>, <span class="number">0x77</span>, <span class="number">0x77</span>, <span class="number">0x74</span>, <span class="number">0xBB</span>, <span class="number">0x9B</span>, </span><br><span class="line">  <span class="number">0xEC</span>, <span class="number">0xED</span>, <span class="number">0xC1</span>, <span class="number">0x06</span>, <span class="number">0xE5</span>, <span class="number">0xC8</span>, <span class="number">0x2A</span>, <span class="number">0xA9</span>, <span class="number">0x55</span>, <span class="number">0xB9</span>, </span><br><span class="line">  <span class="number">0xBB</span>, <span class="number">0xFD</span>, <span class="number">0x88</span>, <span class="number">0xB3</span>, <span class="number">0xC3</span>, <span class="number">0x97</span>, <span class="number">0x46</span>, <span class="number">0x1A</span>, <span class="number">0xAA</span>, <span class="number">0x26</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0xB1</span>, <span class="number">0x07</span>, <span class="number">0x22</span>, <span class="number">0x1F</span>, <span class="number">0xBB</span>, <span class="number">0x60</span>, <span class="number">0xCD</span>, <span class="number">0x1D</span>, <span class="number">0x29</span>, </span><br><span class="line">  <span class="number">0xA7</span>, <span class="number">0xE3</span>, <span class="number">0xA3</span>, <span class="number">0x2B</span>, <span class="number">0xDD</span>, <span class="number">0xDF</span>, <span class="number">0x83</span>, <span class="number">0x1B</span>, <span class="number">0xD5</span>, <span class="number">0x4F</span>, </span><br><span class="line">  <span class="number">0x4D</span>, <span class="number">0x01</span>, <span class="number">0xF3</span>, <span class="number">0x59</span>, <span class="number">0xC6</span>, <span class="number">0x80</span>, <span class="number">0x23</span>, <span class="number">0x5B</span>, <span class="number">0xB4</span>, <span class="number">0x3E</span>, </span><br><span class="line">  <span class="number">0x66</span>, <span class="number">0x62</span>, <span class="number">0xE3</span>, <span class="number">0x43</span>, <span class="number">0x2C</span>, <span class="number">0x53</span>, <span class="number">0x22</span>, <span class="number">0xBD</span>, <span class="number">0</span>&#125;; </span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> *key = (<span class="type">unsigned</span> <span class="type">int</span> *)k;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GET_ULONG_LE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ULONG_LE(n,b,i)                             \</span></span><br><span class="line"><span class="meta">&#123;                                                       \</span></span><br><span class="line"><span class="meta">    (n) = ( (unsigned long) (b)[(i)    ]       )        \</span></span><br><span class="line"><span class="meta">        | ( (unsigned long) (b)[(i) + 1] &lt;&lt;  8 )        \</span></span><br><span class="line"><span class="meta">        | ( (unsigned long) (b)[(i) + 2] &lt;&lt; 16 )        \</span></span><br><span class="line"><span class="meta">        | ( (unsigned long) (b)[(i) + 3] &lt;&lt; 24 );       \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUT_ULONG_LE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT_ULONG_LE(n,b,i)                             \</span></span><br><span class="line"><span class="meta">&#123;                                                       \</span></span><br><span class="line"><span class="meta">    (b)[(i)    ] = (unsigned char) ( (n)       );       \</span></span><br><span class="line"><span class="meta">    (b)[(i) + 1] = (unsigned char) ( (n) &gt;&gt;  8 );       \</span></span><br><span class="line"><span class="meta">    (b)[(i) + 2] = (unsigned char) ( (n) &gt;&gt; 16 );       \</span></span><br><span class="line"><span class="meta">    (b)[(i) + 3] = (unsigned char) ( (n) &gt;&gt; 24 );       \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  SHL(x,n) (((x) &amp; 0xFFFFFFFF) &lt;&lt; n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROTL(x,n) (SHL((x),n) | ((x) &gt;&gt; (32 - n)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAP(a,b) &#123; unsigned long t = a; a = b; b = t; t = 0; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sm4_one_round</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> input[<span class="number">16</span>], <span class="type">unsigned</span> <span class="type">char</span> output[<span class="number">16</span>] )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> tmp[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> t;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(tmp, <span class="number">0</span>, <span class="keyword">sizeof</span>(tmp));</span><br><span class="line">    GET_ULONG_LE( tmp[<span class="number">0</span>], input, <span class="number">0</span> )</span><br><span class="line">    GET_ULONG_LE( tmp[<span class="number">1</span>], input, <span class="number">4</span> )</span><br><span class="line">    GET_ULONG_LE( tmp[<span class="number">2</span>], input, <span class="number">8</span> )</span><br><span class="line">    GET_ULONG_LE( tmp[<span class="number">3</span>], input, <span class="number">12</span> )</span><br><span class="line">    <span class="keyword">while</span>(i &lt; <span class="number">32</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        t = tmp[(i+<span class="number">1</span>) % <span class="number">4</span>] ^ tmp[(i+<span class="number">2</span>) % <span class="number">4</span>] ^ tmp[(i+<span class="number">3</span>) % <span class="number">4</span>] ^ key[i];</span><br><span class="line">        tmp[i % <span class="number">4</span>] ^= t ^ ROTL(t,<span class="number">2</span>) ^ ROTL(t,<span class="number">10</span>) ^ ROTL(t,<span class="number">18</span>) ^ ROTL(t,<span class="number">24</span>);</span><br><span class="line">	    i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span> ; i &lt; <span class="number">4</span>; i++ )</span><br><span class="line">		GET_ULONG_LE(key[<span class="number">26</span> - i], input, i * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	PUT_ULONG_LE(tmp[<span class="number">3</span>],output,<span class="number">0</span>);</span><br><span class="line">	PUT_ULONG_LE(tmp[<span class="number">2</span>],output,<span class="number">4</span>);</span><br><span class="line">	PUT_ULONG_LE(tmp[<span class="number">1</span>],output,<span class="number">8</span>);</span><br><span class="line">	PUT_ULONG_LE(tmp[<span class="number">0</span>],output,<span class="number">12</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sm4_dec</span><span class="params">(<span class="type">int</span> length, <span class="type">unsigned</span> <span class="type">char</span> *input,<span class="type">unsigned</span> <span class="type">char</span> *output)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>( length &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        sm4_one_round(input, output);</span><br><span class="line">        input  += <span class="number">16</span>;</span><br><span class="line">        output += <span class="number">16</span>;</span><br><span class="line">        length -= <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> input[] = &#123;<span class="number">0x7D</span>, <span class="number">0x54</span>, <span class="number">0xCB</span>, <span class="number">0xC0</span>, <span class="number">0x74</span>, <span class="number">0xDB</span>, <span class="number">0xF5</span>, <span class="number">0xD7</span>, <span class="number">0x6F</span>, <span class="number">0xD9</span>,</span><br><span class="line">    <span class="number">0x92</span>, <span class="number">0x1B</span>, <span class="number">0xEB</span>, <span class="number">0x28</span>, <span class="number">0x46</span>, <span class="number">0x20</span>, <span class="number">0xE5</span>, <span class="number">0xD5</span>, <span class="number">0xD3</span>, <span class="number">0x60</span>,</span><br><span class="line">    <span class="number">0x80</span>, <span class="number">0x6D</span>, <span class="number">0x36</span>, <span class="number">0x2F</span>, <span class="number">0xB0</span>, <span class="number">0x63</span>, <span class="number">0x2F</span>, <span class="number">0x61</span>, <span class="number">0x20</span>, <span class="number">0x0F</span>,</span><br><span class="line">    <span class="number">0xA9</span>, <span class="number">0x30</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> output[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">		SWAP(key[i], key[<span class="number">31</span> - i]);</span><br><span class="line"></span><br><span class="line">    sm4_dec(<span class="number">32</span>, input, output);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span> ; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,output[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JIT"><a href="#JIT" class="headerlink" title="JIT"></a>JIT</h3><p>就是按照<a target="_blank" rel="noopener" href="https://ppppz.net/2022/05/26/DASCTF2022-X-VOID-JIT/">PZ师傅的博客</a>复现，我就不抄过来了（逃</p>
<p>我的x64 Native Tools Command Prompt for VS 2022目录是<code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Visual Studio 2022\Visual Studio Tools\VC</code></p>
<p><del>然后后面印度人题也不是很想看了（bushi</del></p>
<h2 id="Dest0g3-520迎新赛"><a href="#Dest0g3-520迎新赛" class="headerlink" title="Dest0g3 520迎新赛"></a>Dest0g3 520迎新赛</h2><p>前面两题很简单就不写了</p>
<h3 id="tttea"><a href="#tttea" class="headerlink" title="tttea"></a>tttea</h3><p>这题属实是……比赛的时候一看七十多解，想着应该很简单，但是死活解不对，调试出来的密钥也是一样的……调一下午调不出来直接开摆，后面题也没心思看了……老想着很简单，看了一下异常也没有，交叉引用也查了但是什么也没有，怎么就是懒得去翻一下导出表……真是sb……</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS __stdcall <span class="title function_">TlsCallback_0_0</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE v3; <span class="comment">// eax</span></span><br><span class="line">  NTSTATUS result; <span class="comment">// eax</span></span><br><span class="line">  NTSTATUS (__stdcall *NtQueryInformationProcess)(HANDLE, PROCESSINFOCLASS, PVOID, ULONG, PULONG); <span class="comment">// [esp+D0h] [ebp-14h]</span></span><br><span class="line">  HMODULE hModule; <span class="comment">// [esp+DCh] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_89C015);</span><br><span class="line">  hModule = LoadLibraryA(<span class="string">&quot;Ntdll.dll&quot;</span>);</span><br><span class="line">  NtQueryInformationProcess = (NTSTATUS (__stdcall *)(HANDLE, PROCESSINFOCLASS, PVOID, ULONG, PULONG))GetProcAddress(hModule, <span class="string">&quot;NtQueryInformationProcess&quot;</span>);</span><br><span class="line">  v3 = GetCurrentProcess();</span><br><span class="line">  result = NtQueryInformationProcess(v3, ProcessDebugPort, &amp;dword_89A1FC, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !dword_89A1FC )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">    *(&amp;dword_89A000 + <span class="number">6</span>) = <span class="number">0x66403319</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *__stdcall <span class="title function_">TlsCallback_1_0</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">signed</span> __int8 v4; <span class="comment">// [esp+EBh] [ebp-5h]</span></span><br><span class="line"></span><br><span class="line">  v4 = NtCurrentPeb()-&gt;BeingDebugged;</span><br><span class="line">  result = (<span class="type">char</span> *)v4;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">char</span> *)&amp;unk_89A014 + <span class="number">4</span>;</span><br><span class="line">    *((_DWORD *)&amp;unk_89A014 + <span class="number">1</span>) ^= <span class="number">0x12345678</span>u;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.data:0089A000 dword_89A000    dd 636C6557h            ; DATA XREF: TlsCallback_0_0+8F↑w</span><br><span class="line">.data:0089A004 aOmeToDest0g3   db &#x27;ome_to_Dest0g3!&#x27;,0</span><br><span class="line">.data:0089A014 unk_89A014      db    1                 ; DATA XREF: TlsCallback_1_0+33↑o</span><br><span class="line">.data:0089A015                 db    0</span><br><span class="line">.data:0089A016                 db    0</span><br><span class="line">.data:0089A017                 db    0</span><br><span class="line">.data:0089A018 delta           dd 9E3779B9h </span><br></pre></td></tr></table></figure>

<p>所以为什么交叉引用查不到，因为他是用<code>dword_89A000 + 6</code>和<code>unk_89A014 + 1</code>来引用到delta，所以查不到，我真的是……还是不能过分信任交叉引用…………感觉好多都查不到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x74746561</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;6^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">xxtea</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">int</span> n, <span class="type">uint32_t</span>* key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;</span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)             <span class="comment">// encrypt</span></span><br><span class="line">    &#123;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = <span class="number">0</span>;</span><br><span class="line">        z = v[n<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            sum += DELTA;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)</span><br><span class="line">            &#123;</span><br><span class="line">                y = v[p+<span class="number">1</span>];</span><br><span class="line">                z = v[p] += MX;</span><br><span class="line">            &#125;</span><br><span class="line">            y = v[<span class="number">0</span>];</span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">// decrypt</span></span><br><span class="line">    &#123;</span><br><span class="line">        n = -n;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = rounds * DELTA;</span><br><span class="line">        y = v[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)</span><br><span class="line">            &#123;</span><br><span class="line">                z = v[p<span class="number">-1</span>];</span><br><span class="line">                y = v[p] -= MX;</span><br><span class="line">            &#125;</span><br><span class="line">            z = v[n<span class="number">-1</span>];</span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">            sum -= DELTA;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> v0[] = &#123;<span class="number">0x03</span>, <span class="number">0x23</span>, <span class="number">0x22</span>, <span class="number">0x2F</span>, <span class="number">0x36</span>, <span class="number">0x88</span>, <span class="number">0xFD</span>, <span class="number">0x43</span>, <span class="number">0x21</span>, <span class="number">0xE8</span>, </span><br><span class="line">  <span class="number">0x5B</span>, <span class="number">0x65</span>, <span class="number">0x31</span>, <span class="number">0x1E</span>, <span class="number">0x3B</span>, <span class="number">0xA6</span>, <span class="number">0x4B</span>, <span class="number">0xB8</span>, <span class="number">0xDC</span>, <span class="number">0x88</span>, </span><br><span class="line">  <span class="number">0x80</span>, <span class="number">0x19</span>, <span class="number">0x84</span>, <span class="number">0x6F</span>, <span class="number">0x97</span>, <span class="number">0x72</span>, <span class="number">0x21</span>, <span class="number">0x26</span>, <span class="number">0xAD</span>, <span class="number">0x64</span>, </span><br><span class="line">  <span class="number">0xEE</span>, <span class="number">0xBB</span>, <span class="number">0x88</span>, <span class="number">0x04</span>, <span class="number">0x4D</span>, <span class="number">0x06</span>, <span class="number">0x2F</span>, <span class="number">0x26</span>, <span class="number">0xE5</span>, <span class="number">0x6B</span>, </span><br><span class="line">  <span class="number">0x81</span>, <span class="number">0x4B</span>, <span class="number">0xF5</span>, <span class="number">0x73</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> *v = (<span class="type">uint32_t</span>*)v0;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> k[<span class="number">4</span>]= &#123;<span class="number">0x61</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x74</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">    xxtea(v, -n, k);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">44</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, v0[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Dest0g3&#123;73dd38c2-9d45-4f7a-9bd0-90a1e9907c1&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="EzMath"><a href="#EzMath" class="headerlink" title="EzMath"></a>EzMath</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">EzMath</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Token: 0x02000003 RID: 3</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Checker</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Token: 0x06000005 RID: 5 RVA: 0x00002110 File Offset: 0x00000310</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Encrypt1</span>(<span class="params"><span class="built_in">byte</span>[] a</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			List&lt;<span class="built_in">byte</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>&gt;();</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">uint</span> <span class="keyword">value</span> = (<span class="built_in">uint</span>)((<span class="built_in">ulong</span>)utils.Unpack32(RuntimeHelpers.GetSubArray&lt;<span class="built_in">byte</span>&gt;(a, <span class="keyword">new</span> Range(<span class="number">4</span> * i, <span class="number">4</span> * (i + <span class="number">1</span>)))) * <span class="number">83987U</span>L % (<span class="built_in">ulong</span>)<span class="number">-232573883</span>);</span><br><span class="line">				list.AddRange(BitConverter.GetBytes(<span class="keyword">value</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> list.ToArray();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Token: 0x06000006 RID: 6 RVA: 0x00002174 File Offset: 0x00000374</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Encrypt2</span>(<span class="params"><span class="built_in">byte</span>[] a</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			List&lt;<span class="built_in">byte</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>&gt;();</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ulong</span> num = utils.Unpack64(RuntimeHelpers.GetSubArray&lt;<span class="built_in">byte</span>&gt;(a, <span class="keyword">new</span> Range(<span class="number">8</span> * i, <span class="number">8</span> * (i + <span class="number">1</span>))));</span><br><span class="line">				<span class="built_in">ulong</span> <span class="keyword">value</span> = num ^ num &gt;&gt; <span class="number">25</span>;</span><br><span class="line">				list.AddRange(BitConverter.GetBytes(<span class="keyword">value</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> list.ToArray();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="陇原战”疫”2021网络安全大赛"><a href="#陇原战”疫”2021网络安全大赛" class="headerlink" title="陇原战”疫”2021网络安全大赛"></a>陇原战”疫”2021网络安全大赛</h2><h3 id="findme"><a href="#findme" class="headerlink" title="findme"></a>findme</h3><p>验证用的函数是off_403844，此地址处只有strcmp，所以肯定是被hook了，查交叉引用，往这个地址写了off_403840，off_403840调用了sub_401866，所以主逻辑在sub_401866。<br>进入sub_401866的伪代码，写了个RC4，有没有魔改不知道，直接调试。断点下到第40行的for循环调试起来，输26个a进去，提取dword_403040作为enc，v6作为xor，写异或脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enc = [<span class="number">0xB7</span>,<span class="number">0x52</span>,<span class="number">0x85</span>,<span class="number">0xC1</span>,<span class="number">0x90</span>,<span class="number">0xE9</span>,<span class="number">0x07</span>,<span class="number">0xB8</span>,<span class="number">0xE4</span>,<span class="number">0x1A</span>,<span class="number">0xC3</span>,<span class="number">0xBD</span>,<span class="number">0x1D</span>,<span class="number">0x8E</span>,<span class="number">0x85</span>,<span class="number">0x46</span>,<span class="number">0x00</span>,<span class="number">0x21</span>,<span class="number">0x44</span>,<span class="number">0xAF</span>,<span class="number">0xEF</span>,<span class="number">0x70</span>,<span class="number">0x32</span>,<span class="number">0xB5</span>,<span class="number">0x11</span>,<span class="number">0xC6</span>]</span><br><span class="line">xor = [<span class="number">0x85</span>, <span class="number">0x76</span>, <span class="number">0xB0</span>, <span class="number">0xE3</span>, <span class="number">0xA5</span>, <span class="number">0xCE</span>, <span class="number">0x1D</span>, <span class="number">0x8D</span>, <span class="number">0xED</span>, <span class="number">0x4A</span>, </span><br><span class="line">  <span class="number">0xD1</span>, <span class="number">0x83</span>, <span class="number">0x15</span>, <span class="number">0xDA</span>, <span class="number">0xBB</span>, <span class="number">0x62</span>, <span class="number">0x53</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0xBA</span>, </span><br><span class="line">  <span class="number">0xDC</span>, <span class="number">0x72</span>, <span class="number">0x3E</span>, <span class="number">0xED</span>, <span class="number">0x51</span>, <span class="number">0xDA</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i] ^ xor[i] ^ <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">#SETCTF&#123;Th1s_i5_E2_5tRcm9!&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="power"><a href="#power" class="headerlink" title="power"></a>power</h3><p>印度人题他又来了……</p>
<p>line1247~1278：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.L84:</span></span><br><span class="line">	<span class="meta">.word</span>	_GLOBAL_OFFSET_TABLE_-(.LPIC12+<span class="number">4</span>)</span><br><span class="line">	<span class="meta">.word</span>	__stack_chk_guard(GOT)</span><br><span class="line">	<span class="meta">.word</span>	.LC0-(.LPIC11+<span class="number">4</span>)</span><br><span class="line">	<span class="meta">.word</span>	_GLOBAL_OFFSET_TABLE_-(.LPIC13+<span class="number">4</span>)</span><br><span class="line">	.fnend</span><br><span class="line">	.size	_ZN3aes14encryption_cbcEPcS0_, .-_ZN3aes14encryption_cbcEPcS0_</span><br><span class="line">	<span class="meta">.section</span>	.rodata</span><br><span class="line">	<span class="meta">.align</span>	<span class="number">2</span></span><br><span class="line"><span class="symbol">.LC2:</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;input flag:\000&quot;</span></span><br><span class="line">	<span class="meta">.align</span>	<span class="number">2</span></span><br><span class="line"><span class="symbol">.LC3:</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;1030a9254d44937bed312da03d2db9adbec5762c2eca7b5853e&quot;</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;489d2a140427b\000&quot;</span></span><br><span class="line">	<span class="meta">.align</span>	<span class="number">2</span></span><br><span class="line"><span class="symbol">.LC4:</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;yeah, you get it!\000&quot;</span></span><br><span class="line">	<span class="meta">.align</span>	<span class="number">2</span></span><br><span class="line"><span class="symbol">.LC5:</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;wrong!\000&quot;</span></span><br><span class="line">	<span class="meta">.align</span>	<span class="number">2</span></span><br><span class="line"><span class="symbol">.LC1:</span></span><br><span class="line">	<span class="meta">.ascii</span>	<span class="string">&quot;this_is_a_key!!!\000&quot;</span></span><br><span class="line">	<span class="meta">.text</span></span><br><span class="line">	<span class="meta">.align</span>	<span class="number">1</span></span><br><span class="line">	<span class="meta">.global</span>	main</span><br><span class="line">	.syntax unified</span><br><span class="line">	<span class="meta">.thumb</span></span><br><span class="line">	<span class="meta">.thumb_func</span></span><br><span class="line">	.fpu vfpv3-<span class="built_in">d16</span></span><br><span class="line">	.type	main, %<span class="meta">function</span></span><br></pre></td></tr></table></figure>

<p>L84指明是AES，LC3是密文，LC1是key，iv是0（不是字符0）。<br>CBC解密只能解出前一半flag，用ECB就可以……<br><code>flag&#123;y0u_found_the_aes_12113112&#125;</code></p>
<h3 id="EasyRE-Revenge"><a href="#EasyRE-Revenge" class="headerlink" title="EasyRE_Revenge"></a>EasyRE_Revenge</h3><p>出题人好像是批量加的花指令……<br>patch了老半天，但是还是恢复不了函数，没耐心了直接上手调</p>
<p>到IDA拖着红色的那里，后面都是很多结构一样的函数，作用就是设置了几个参数，不同就是最后mov的地址不一样，花指令在最开始的call函数前后，是一些无用数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:00B11817                 call    sub_B1181D</span><br><span class="line">.text:00B1181C                 push    cs</span><br><span class="line">.text:00B1181D</span><br><span class="line">.text:00B1181D ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:00B1181D</span><br><span class="line">.text:00B1181D</span><br><span class="line">.text:00B1181D sub_B1181D      proc near               ; CODE XREF: .text:00B11817↑p</span><br><span class="line">.text:00B1181D                 xor     ebx, ebx</span><br><span class="line">.text:00B1181F                 xor     eax, eax</span><br><span class="line">.text:00B11821                 xor     ecx, ecx</span><br><span class="line">.text:00B11823                 pop     ecx</span><br><span class="line">.text:00B11824                 add     eax, 1</span><br><span class="line">.text:00B11827                 mov     ebx, 7</span><br><span class="line">.text:00B1182C                 mul     ebx</span><br><span class="line">.text:00B1182E                 add     ecx, 20h ; &#x27; &#x27;</span><br><span class="line">.text:00B11831                 add     eax, 0Bh</span><br><span class="line">.text:00B11834                 xor     eax, ebx</span><br><span class="line">.text:00B11836                 push    ecx</span><br><span class="line">.text:00B11837                 mov     [ebp-77h], al</span><br><span class="line">.text:00B1183A                 retn</span><br><span class="line">.text:00B1183A sub_B1181D      endp</span><br><span class="line">.text:00B1183A</span><br><span class="line">.text:00B1183A ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>就不停地找E8，然后按C转为代码……到最后一个这种结构的函数结束处，下面是一个新的函数，创建函数然后反编译。<br>代码有点抽象，参数改成<code>int*</code>类型，顺眼多了……</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="type">int</span> __usercall sub_4C1C92@&lt;eax&gt;(<span class="type">int</span> *a1@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( *(a1 - <span class="number">33</span>) = <span class="number">0</span>; *(a1 - <span class="number">33</span>) &lt; <span class="number">8</span>; ++*(a1 - <span class="number">33</span>) )</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">33</span>)) = *(_DWORD *)(a1[<span class="number">2</span>] + <span class="number">4</span> * *(a1 - <span class="number">33</span>)) ^ a1[(<span class="number">7</span> * *(a1 - <span class="number">33</span>) + <span class="number">2</span>) % <span class="number">8</span> - <span class="number">30</span>];</span><br><span class="line">  <span class="keyword">for</span> ( *(a1 - <span class="number">36</span>) = <span class="number">0</span>; *(a1 - <span class="number">36</span>) &lt; <span class="number">8</span>; ++*(a1 - <span class="number">36</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) &lt;&lt; <span class="number">7</span>;</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= a1[(<span class="number">7</span> * *(a1 - <span class="number">36</span>) + <span class="number">3</span>) % <span class="number">8</span> - <span class="number">30</span>];</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * ((<span class="number">5</span> * *(a1 - <span class="number">36</span>) + <span class="number">3</span>) % <span class="number">8</span>));</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) &lt;&lt; <span class="number">13</span>;</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= a1[(<span class="number">7</span> * *(a1 - <span class="number">36</span>) + <span class="number">5</span>) % <span class="number">8</span> - <span class="number">30</span>];</span><br><span class="line">    *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) ^= *(_DWORD *)(*(a1 - <span class="number">3</span>) + <span class="number">4</span> * *(a1 - <span class="number">36</span>)) &lt;&lt; <span class="number">17</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sub_4C1154();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还原算法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __usercall sub_4C1C92@&lt;eax&gt;(<span class="type">int</span> *key@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">    tmp[i] = input[i] ^ key[(<span class="number">7</span> * i + <span class="number">2</span>) % <span class="number">8</span>];</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    tmp[i] ^= tmp[i] &lt;&lt; <span class="number">7</span>;</span><br><span class="line">    tmp[i] ^= key[(<span class="number">7</span> * i + <span class="number">3</span>) % <span class="number">8</span>];</span><br><span class="line">    tmp[i] ^= (tmp + ((<span class="number">5</span> * i + <span class="number">3</span>) % <span class="number">8</span>));</span><br><span class="line">    tmp[i] ^= tmp[i] &lt;&lt; <span class="number">13</span>;</span><br><span class="line">    tmp[i] ^= key[(<span class="number">7</span> * i + <span class="number">5</span>) % <span class="number">8</span>];</span><br><span class="line">    tmp[i] ^= tmp[i] &lt;&lt; <span class="number">17</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sub_4C1154();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个shift xor要用特殊的算法来还原，<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1540727-1-1.html">zsky神的博客</a>有写，我就不抄过来了（逃<br>其他的逆回去写就行</p>
<h3 id="Eat-something"><a href="#Eat-something" class="headerlink" title="Eat_something"></a>Eat_something</h3><p>……………………………………………………………………………………<br>梦回miniL………………………………………………………………</p>
<p>我要是miniL前复现过这题也不至于做不出来WebAssembly吧呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜呜</p>
<h2 id="CBCTF-2022九月挑战赛"><a href="#CBCTF-2022九月挑战赛" class="headerlink" title="CBCTF 2022九月挑战赛"></a>CBCTF 2022九月挑战赛</h2><h3 id="landing"><a href="#landing" class="headerlink" title="landing"></a>landing</h3><p>这题我tm真的是………………</p>
<p><img src="/img/code/chall_photo/DAS0.png"></p>
<p>经过学弟提醒，我觉得自己还是要文明一些，所以谨代表我个人向出题人致以诚挚的问候……………………@#&amp;￥%@#￥~！&#96;%@#*&amp;</p>
<p>经过一个异或0x22和+1的处理之后，对输入进行一个类似base的加密（但是并不是）。<br>主程序里的密文解出来是个fake flag，func2会抛出异常进入真正的执行流程。注意出题人写了4个异常，一个int一个long一个<code>char*</code>一个所有类型的。<br>会触发的异常是最后两个（但是<code>char*</code>的里面好像并没有写什么东西（？<del>懒得再翻一遍了，我是懒🐶</del><br>catch里面的代码巨长无比，懒得看汇编可以把fun1的一个jmp语句patch掉让它跳转到except块里，就能反编译出来伪代码了。<br>except块里的代码就是存储了密文，然后对密文异或0x12，然后对input（之前在主程序里经过了一个异或0x22和+1的处理）用nothing函数进行加密。<br>这个nothing跟那个假flag的加密逻辑是一样的，直接解密即可<br><del>依旧对这题充满了怨念</del></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">enc = <span class="string">&#x27;TFdMUkFYT0xJTklOR0hBWE9MR1hOTk5OTk5OTg&#x27;</span></span><br><span class="line">model = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">output = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    output.append(model.index(enc[i]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">36</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="built_in">input</span> += <span class="built_in">chr</span>(((((output[i]&lt;&lt;<span class="number">2</span>) | ((output[i+<span class="number">1</span>]&gt;&gt;<span class="number">4</span>)&amp;<span class="number">3</span>))&amp;<span class="number">0xff</span>)-<span class="number">1</span>)^<span class="number">0x22</span>)</span><br><span class="line">    <span class="built_in">input</span> += <span class="built_in">chr</span>(((((output[i+<span class="number">1</span>]&lt;&lt;<span class="number">4</span>) | ((output[i+<span class="number">2</span>]&gt;&gt;<span class="number">2</span>)&amp;<span class="number">0xf</span>))&amp;<span class="number">0xff</span>)-<span class="number">1</span>)^<span class="number">0x22</span>)</span><br><span class="line">    <span class="built_in">input</span> += <span class="built_in">chr</span>(((((output[i+<span class="number">2</span>]&lt;&lt;<span class="number">6</span>) | (output[i+<span class="number">3</span>] &amp; <span class="number">0x3f</span>))&amp;<span class="number">0xff</span>)-<span class="number">1</span>)^<span class="number">0x22</span>)</span><br><span class="line"><span class="built_in">input</span> += <span class="built_in">chr</span>(((((output[i]&lt;&lt;<span class="number">2</span>) | ((output[i+<span class="number">1</span>]&gt;&gt;<span class="number">4</span>)&amp;<span class="number">3</span>))&amp;<span class="number">0xff</span>)-<span class="number">1</span>)^<span class="number">0x22</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">input</span>)</span><br></pre></td></tr></table></figure>




    </div>

    <div class="about">
        <h1>关于本文</h1>
        <p>本文作者 云之君, 许可由 <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>

    
        
    
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/CTF" class="item">CTF</a>
                
                <a href="/Learn" class="item">Learn</a>
                
                <a href="/Diary" class="item">Diary</a>
                
                <a href="/friends" class="item">Friends</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/YunZh1Jun" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/25320847" class="item">Bilibili</a>
                
                <a href="mailto:yunzh1jun@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2023 云之君<br >驱动由 <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
    </body>
</html>